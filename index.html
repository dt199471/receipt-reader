<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>領収読 - レシート読み取り</title>
  <meta name="description" content="和モダンなレシート読み取りアプリ">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#c94a4a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="領収読">
  <link rel="apple-touch-icon" href="icons/icon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sumi: #2d2d2d;
      --sumi-light: #4a4a4a;
      --shu: #c94a4a;
      --shu-dark: #a33a3a;
      --shu-glow: rgba(201, 74, 74, 0.4);
      --ai: #3d5a6e;
      --ai-light: #5a7a8e;
      --kinari: #f5f1eb;
      --washi: #faf8f5;
      --kage: rgba(45, 45, 45, 0.08);
      --kage-deep: rgba(45, 45, 45, 0.15);
      /* safe-area用変数 */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      background-color: var(--kinari);
      color: var(--sumi);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      position: relative;
      overflow-x: hidden;
      padding-top: var(--safe-area-top);
      padding-bottom: var(--safe-area-bottom);
      padding-left: var(--safe-area-left);
      padding-right: var(--safe-area-right);
    }

    /* 和紙テクスチャ背景 */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }

    /* 装飾的な波紋パターン */
    body::after {
      content: '';
      position: fixed;
      top: -50%;
      right: -30%;
      width: 80%;
      height: 80%;
      background: radial-gradient(ellipse, var(--shu-glow) 0%, transparent 70%);
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
    }

    .app-container {
      position: relative;
      z-index: 1;
      max-width: 480px;
      margin: 0 auto;
      padding: 0 1.25rem 2rem;
      min-height: 100vh;
    }

    /* ========== ヘッダー ========== */
    header {
      padding: 1.5rem 0 1rem;
      text-align: center;
      opacity: 0;
      animation: fadeSlideDown 0.8s ease-out 0.2s forwards;
    }

    .logo {
      font-family: 'Noto Serif JP', serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--sumi);
      letter-spacing: 0.3em;
      position: relative;
      display: inline-block;
    }

    .logo::before {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--shu), transparent);
    }

    .logo-sub {
      display: block;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--sumi-light);
      letter-spacing: 0.2em;
      margin-top: 0.5rem;
    }

    /* ========== スキャンエリア ========== */
    .scan-section {
      margin: 1.5rem 0;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.4s forwards;
    }

    .scan-area {
      position: relative;
      aspect-ratio: 3 / 4;
      background: var(--washi);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      touch-action: manipulation;
    }

    .scan-area:hover {
      transform: scale(1.01);
    }

    .scan-area.camera-active {
      cursor: default;
    }

    .scan-area.camera-active:hover {
      transform: none;
    }

    /* 障子風フレーム */
    .scan-frame {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }

    .scan-frame::before {
      content: '';
      position: absolute;
      inset: 8px;
      border: 2px solid var(--sumi);
      border-radius: 2px;
      opacity: 0.15;
    }

    /* 墨で描いたような不均一なボーダー */
    .scan-frame-corner {
      position: absolute;
      width: 40px;
      height: 40px;
      opacity: 0.8;
    }

    .scan-frame-corner--tl {
      top: 12px;
      left: 12px;
      border-top: 3px solid var(--sumi);
      border-left: 3px solid var(--sumi);
      border-top-left-radius: 2px;
    }

    .scan-frame-corner--tr {
      top: 12px;
      right: 12px;
      border-top: 3px solid var(--sumi);
      border-right: 3px solid var(--sumi);
      border-top-right-radius: 2px;
    }

    .scan-frame-corner--bl {
      bottom: 12px;
      left: 12px;
      border-bottom: 3px solid var(--sumi);
      border-left: 3px solid var(--sumi);
      border-bottom-left-radius: 2px;
    }

    .scan-frame-corner--br {
      bottom: 12px;
      right: 12px;
      border-bottom: 3px solid var(--sumi);
      border-right: 3px solid var(--sumi);
      border-bottom-right-radius: 2px;
    }

    /* 障子の光グロー効果 */
    .scan-glow {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.6) 0%, transparent 70%);
      animation: pulseGlow 3s ease-in-out infinite;
      pointer-events: none;
    }

    .camera-active .scan-glow {
      display: none;
    }

    @keyframes pulseGlow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    .scan-content {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transition: opacity 0.3s ease;
    }

    .scan-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    .scan-area:hover .scan-icon {
      opacity: 0.6;
    }

    .scan-text {
      font-family: 'Noto Serif JP', serif;
      font-size: 1rem;
      color: var(--sumi-light);
      letter-spacing: 0.1em;
    }

    .scan-preview {
      position: absolute;
      inset: 0;
      object-fit: contain;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
      padding: 20px;
    }

    .scan-preview.visible {
      opacity: 1;
    }

    /* ========== カメラビデオ要素 ========== */
    .camera-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
      background: #000;
    }

    .camera-video.visible {
      opacity: 1;
    }

    /* キャプチャプレビュー（撮影後の静止画） */
    .capture-preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .capture-preview.visible {
      opacity: 1;
    }

    /* キャプチャ用キャンバス（非表示） */
    .capture-canvas {
      display: none;
    }

    /* シャッターエフェクト */
    .shutter-effect {
      position: absolute;
      inset: 0;
      background: white;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
    }

    .shutter-effect.flash {
      animation: shutterFlash 0.2s ease-out;
    }

    @keyframes shutterFlash {
      0% { opacity: 0.9; }
      100% { opacity: 0; }
    }

    /* カメラ切り替えボタン */
    .camera-switch-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(45, 45, 45, 0.6);
      border: none;
      cursor: pointer;
      z-index: 5;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      touch-action: manipulation;
    }

    .camera-switch-btn.visible {
      display: flex;
    }

    .camera-switch-btn:hover {
      background: rgba(45, 45, 45, 0.8);
      transform: scale(1.05);
    }

    .camera-switch-btn:active {
      transform: scale(0.95);
    }

    .camera-switch-btn svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    /* 撮り直しボタン */
    .retake-btn {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.75rem 1.5rem;
      background: rgba(250, 248, 245, 0.95);
      border: none;
      border-radius: 20px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      color: var(--ai);
      cursor: pointer;
      z-index: 5;
      display: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      touch-action: manipulation;
    }

    .retake-btn.visible {
      display: block;
    }

    .retake-btn:hover {
      background: white;
      color: var(--shu);
    }

    .retake-btn:active {
      transform: translateX(-50%) scale(0.95);
    }

    /* カメラエラーメッセージ */
    .camera-error {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3;
      padding: 20px;
      text-align: center;
      background: rgba(250, 248, 245, 0.95);
    }

    .camera-error.visible {
      display: flex;
    }

    .camera-error-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 1rem;
      color: var(--shu);
      opacity: 0.8;
    }

    .camera-error-title {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.1rem;
      color: var(--sumi);
      margin-bottom: 0.5rem;
    }

    .camera-error-message {
      font-size: 0.85rem;
      color: var(--sumi-light);
      line-height: 1.6;
      max-width: 280px;
    }

    /* カメラエラー時のボタン群 */
    .camera-error-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1rem;
      width: 100%;
      max-width: 200px;
    }

    .camera-error-retry {
      padding: 0.75rem 1.5rem;
      background: var(--shu);
      color: white;
      border: none;
      border-radius: 4px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .camera-error-retry:hover {
      background: var(--shu-dark);
    }

    .camera-error-fallback {
      padding: 0.75rem 1.5rem;
      background: var(--ai);
      color: white;
      border: none;
      border-radius: 4px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .camera-error-fallback:hover {
      background: var(--ai-light);
    }

    /* スキャンライン効果 */
    .scan-line {
      position: absolute;
      left: 20px;
      right: 20px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--shu), transparent);
      box-shadow: 0 0 20px var(--shu-glow), 0 0 40px var(--shu-glow);
      z-index: 3;
      opacity: 0;
      pointer-events: none;
    }

    .scan-line.scanning {
      opacity: 1;
      animation: scanMove 2s ease-in-out infinite;
    }

    @keyframes scanMove {
      0% { top: 20px; }
      50% { top: calc(100% - 23px); }
      100% { top: 20px; }
    }

    /* ========== モード切り替えタブ ========== */
    .mode-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1rem;
      background: var(--kage);
      border-radius: 8px;
      padding: 4px;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.5s forwards;
    }

    .mode-tab {
      flex: 1;
      padding: 0.75rem 1rem;
      min-height: 48px;
      border: none;
      border-radius: 6px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--sumi-light);
      background: transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      touch-action: manipulation;
    }

    .mode-tab.active {
      background: var(--washi);
      color: var(--sumi);
      box-shadow: 0 2px 8px var(--kage);
    }

    .mode-tab:not(.active):hover {
      color: var(--sumi);
    }

    .mode-tab-icon {
      width: 20px;
      height: 20px;
    }

    /* ========== ナビゲーションバー ========== */
    .main-nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 0.5rem;
      background: var(--kage-light);
      border-radius: 12px;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.6s forwards;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem 0.5rem;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--sumi-light);
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .nav-btn svg {
      width: 24px;
      height: 24px;
    }

    .nav-btn.active {
      background: var(--shu);
      color: white;
      box-shadow: 0 2px 10px var(--shu-glow);
    }

    .nav-btn:not(.active):hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--sumi);
    }

    /* 画面コンテナ */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* ========== アクションボタン ========== */
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin: 1.5rem 0;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.6s forwards;
    }

    /* カメラモード時は非表示 */
    .action-buttons.hidden {
      display: none;
    }

    .btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      min-height: 48px;
      border: none;
      border-radius: 4px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    .btn-primary {
      background: var(--shu);
      color: white;
      box-shadow: 0 4px 15px var(--shu-glow);
    }

    .btn-primary:hover {
      background: var(--shu-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shu-glow);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* 朱印エフェクト */
    .btn-primary::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transform: scale(0);
      transition: all 0.4s ease;
    }

    .btn-primary:active::after {
      opacity: 1;
      transform: scale(2);
    }

    .btn-secondary {
      background: var(--washi);
      color: var(--ai);
      border: 1px solid var(--kage-deep);
    }

    .btn-secondary:hover {
      background: white;
      border-color: var(--ai);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--kage);
    }

    .btn-icon {
      width: 24px;
      height: 24px;
    }

    /* ========== 撮影モードセクション（カメラモード用） ========== */
    .capture-mode-section {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1.25rem;
      margin: 1.5rem 0 0.5rem;
      opacity: 0;
      animation: fadeSlideUp 0.4s ease-out forwards;
    }

    .capture-mode-section.visible {
      display: flex;
    }

    .capture-mode-buttons {
      display: flex;
      gap: 0.75rem;
      background: rgba(245, 241, 235, 0.9);
      padding: 0.375rem;
      border-radius: 999px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .capture-mode-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: none;
      background: transparent;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.85rem;
      color: var(--sumi-light);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .capture-mode-btn.active {
      background: var(--shu);
      color: white;
      box-shadow: 0 2px 8px var(--shu-glow);
    }

    .capture-mode-btn svg {
      flex-shrink: 0;
    }

    .frame-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.25rem;
      height: 1.25rem;
      padding: 0 0.35rem;
      border-radius: 999px;
      background: var(--kage);
      color: var(--kinari);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .capture-mode-btn.active .frame-count {
      background: rgba(255,255,255,0.3);
    }

    @keyframes pulse-recording {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .shutter-btn {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: var(--shu);
      border: 4px solid white;
      box-shadow: 0 4px 20px var(--shu-glow), 0 0 0 4px var(--shu);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      touch-action: manipulation;
    }

    .shutter-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 25px var(--shu-glow), 0 0 0 4px var(--shu-dark);
    }

    .shutter-btn:active {
      transform: scale(0.95);
    }

    .shutter-btn::before {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      background: white;
      opacity: 0;
      transition: opacity 0.1s ease;
    }

    .shutter-btn:active::before {
      opacity: 0.3;
    }

    /* 録画中のシャッターボタン（四角いデザイン） */
    .shutter-btn.recording {
      border-radius: 12px;
      animation: pulse-recording 1.5s ease-in-out infinite;
    }

    .shutter-btn.recording::before {
      border-radius: 4px;
    }

    /* 解析ボタン */
    .analyze-section {
      margin: 1rem 0;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.7s forwards;
    }

    .btn-analyze {
      width: 100%;
      padding: 1.2rem;
      background: var(--ai);
      color: white;
      box-shadow: 0 4px 15px rgba(61, 90, 110, 0.3);
    }

    .btn-analyze:hover {
      background: var(--ai-light);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(61, 90, 110, 0.4);
    }

    .btn-analyze:disabled {
      background: var(--kage-deep);
      color: var(--sumi-light);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ========== まとめ撮り結果表示エリア ========== */
    .batch-results-section {
      margin: 2rem 0;
      display: none;
      opacity: 0;
      transform: translateY(20px);
    }

    .batch-results-section.visible {
      display: block;
      animation: fadeSlideUp 0.6s ease-out forwards;
    }

    .batch-results-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .batch-results-header h2 {
      color: var(--sumi);
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .batch-count {
      color: var(--sumi-light);
      font-size: 1rem;
    }

    .batch-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .batch-receipt-card {
      background: var(--washi);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 10px var(--kage);
      transition: all 0.3s ease;
    }

    .batch-receipt-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--kage);
    }

    .batch-receipt-thumbnail {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 0.75rem;
      background: var(--kage-light);
    }

    /* まとめ撮り編集セクション */
    .batch-receipt-edit {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .batch-edit-field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .batch-edit-field label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--sumi-light);
    }

    .batch-edit-field input,
    .batch-edit-field select {
      padding: 0.5rem;
      border: 1.5px solid var(--kage);
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
      color: var(--sumi);
      background: white;
      transition: all 0.2s;
    }

    .batch-edit-field input:focus,
    .batch-edit-field select:focus {
      outline: none;
      border-color: var(--ai);
      box-shadow: 0 0 0 2px rgba(139, 169, 195, 0.1);
    }

    .batch-store-input {
      font-weight: 600;
    }

    .batch-amount-input {
      font-weight: 700;
      color: var(--shu);
    }

    .batch-receipt-info h3 {
      color: var(--sumi);
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .batch-receipt-info .amount {
      color: var(--shu);
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 0.75rem;
    }

    .batch-receipt-info .date {
      color: var(--sumi-light);
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }

    .batch-category-select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid var(--kage-light);
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      background: white;
    }

    .batch-save-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--shu);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .batch-save-btn:hover:not(:disabled) {
      background: var(--shu-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(217, 83, 79, 0.3);
    }

    .batch-save-btn:disabled {
      background: var(--kage);
      cursor: not-allowed;
    }

    .batch-save-btn.saved {
      background: var(--ai);
    }

    .batch-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .batch-actions .btn {
      padding: 0.8rem 2rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .batch-actions .btn-primary {
      background: var(--shu);
      color: white;
    }

    .batch-actions .btn-primary:hover {
      background: var(--shu-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--shu-glow);
    }

    .batch-actions .btn-secondary {
      background: var(--kage-light);
      color: var(--sumi);
    }

    .batch-actions .btn-secondary:hover {
      background: var(--kage);
    }

    /* ========== 結果表示エリア ========== */
    .result-section {
      margin: 2rem 0;
      display: none;
    }

    .result-section.visible {
      display: block;
    }

    .result-card {
      background: var(--washi);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px var(--kage);
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: translateY(20px);
    }

    .result-card.animate {
      animation: slideUp 0.6s ease-out forwards;
    }

    @keyframes slideUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 和紙風テクスチャ on カード */
    .result-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity: 0.02;
      pointer-events: none;
    }

    .result-header {
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--kage);
    }

    /* 編集セクション */
    .result-edit-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .edit-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .edit-field label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--sumi);
    }

    .edit-field input,
    .edit-field select {
      padding: 0.75rem;
      border: 2px solid var(--kage);
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      color: var(--sumi);
      background: white;
      transition: all 0.2s;
    }

    .edit-field input:focus,
    .edit-field select:focus {
      outline: none;
      border-color: var(--ai);
      box-shadow: 0 0 0 3px rgba(139, 169, 195, 0.1);
    }

    .store-name-input {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .total-amount-input {
      font-weight: 700;
      color: var(--shu);
      font-size: 1.1rem;
    }

    /* 登録ボタン */
    .result-actions {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--kage);
      display: flex;
      justify-content: center;
    }

    .btn-register {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .btn-register:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(217, 83, 79, 0.3);
    }

    .btn-register:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .btn-register.saved {
      background: var(--ai);
      border-color: var(--ai);
    }

    .store-name {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--sumi);
    }

    .receipt-date {
      font-size: 0.85rem;
      color: var(--sumi-light);
    }

    .result-total {
      text-align: right;
      margin-bottom: 1.5rem;
    }

    .total-label {
      font-size: 0.8rem;
      color: var(--sumi-light);
      margin-bottom: 0.25rem;
    }

    .total-amount {
      font-family: 'Noto Serif JP', serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--shu);
    }

    .total-amount::before {
      content: '¥';
      font-size: 1.2rem;
      margin-right: 0.1rem;
    }

    .result-items {
      list-style: none;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px dashed var(--kage);
      opacity: 0;
      transform: translateX(-10px);
    }

    .result-item.animate {
      animation: slideRight 0.4s ease-out forwards;
    }

    @keyframes slideRight {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .item-name {
      font-size: 0.95rem;
      color: var(--sumi);
    }

    .item-price {
      font-weight: 500;
      color: var(--ai);
    }

    /* ========== カテゴリ分類 ========== */
    .category-section {
      margin-bottom: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--kage);
    }

    .category-label {
      font-size: 0.85rem;
      color: var(--sumi-light);
      margin-bottom: 0.75rem;
      font-weight: 500;
    }

    .category-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .category-btn {
      padding: 0.5rem 1rem;
      border: 1.5px solid var(--kage-deep);
      border-radius: 20px;
      background: var(--washi);
      color: var(--sumi);
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .category-btn:hover {
      border-color: var(--ai);
      background: rgba(61, 90, 110, 0.05);
      transform: translateY(-1px);
    }

    .category-btn.active {
      background: var(--ai);
      color: white;
      border-color: var(--ai);
      box-shadow: 0 2px 8px rgba(61, 90, 110, 0.3);
    }

    .category-btn.category-food.active {
      background: #e74c3c;
      border-color: #e74c3c;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
    }

    .category-btn.category-transport.active {
      background: #3498db;
      border-color: #3498db;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }

    .category-btn.category-daily.active {
      background: #2ecc71;
      border-color: #2ecc71;
      box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
    }

    .category-btn.category-entertainment.active {
      background: #9b59b6;
      border-color: #9b59b6;
      box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);
    }

    .category-btn.category-medical.active {
      background: #e67e22;
      border-color: #e67e22;
      box-shadow: 0 2px 8px rgba(230, 126, 34, 0.3);
    }

    .category-btn.category-education.active {
      background: #1abc9c;
      border-color: #1abc9c;
      box-shadow: 0 2px 8px rgba(26, 188, 156, 0.3);
    }

    .category-btn.category-other.active {
      background: var(--sumi-light);
      border-color: var(--sumi-light);
      box-shadow: 0 2px 8px rgba(45, 45, 45, 0.3);
    }

    .item-category {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      margin-left: 0.5rem;
      font-size: 0.7rem;
      border-radius: 10px;
      background: var(--kage);
      color: var(--sumi-light);
    }

    /* ========== 履歴ボタン ========== */
    .history-section {
      margin: 2rem 0;
      text-align: center;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.8s forwards;
    }

    .history-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      min-height: 48px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      color: var(--sumi-light);
      text-decoration: none;
      border: 1px dashed var(--kage-deep);
      border-radius: 30px;
      transition: all 0.3s ease;
    }

    .history-link:hover {
      color: var(--ai);
      border-color: var(--ai);
      background: rgba(61, 90, 110, 0.05);
    }

    .history-icon {
      width: 18px;
      height: 18px;
    }

    /* ========== 隠しinput ========== */
    .hidden-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* ========== アニメーション ========== */
    @keyframes fadeSlideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========== ローディング ========== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(245, 241, 235, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .loading-circle {
      width: 60px;
      height: 60px;
      border: 3px solid var(--kage);
      border-top-color: var(--shu);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 1rem;
      font-family: 'Noto Serif JP', serif;
      font-size: 1rem;
      color: var(--sumi-light);
      letter-spacing: 0.1em;
    }

    /* プログレスバー（連続スキャン解析進捗用） */
    .progress-bar-container {
      width: 80%;
      max-width: 280px;
      height: 6px;
      background: rgba(45, 45, 45, 0.15);
      border-radius: 3px;
      margin-top: 16px;
      display: none;
      overflow: hidden;
    }

    .progress-bar-container.visible {
      display: block;
    }

    .progress-bar {
      height: 100%;
      background: var(--shu);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* 解析チェックリスト（各フレームの状況表示） */
    .analysis-checklist {
      margin-top: 12px;
      display: none;
      flex-direction: column;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--sumi-light);
    }

    .analysis-checklist.visible {
      display: flex;
    }

    .analysis-checklist-item {
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.5;
      transition: opacity 0.3s ease;
    }

    .analysis-checklist-item.processing {
      opacity: 1;
    }

    .analysis-checklist-item.completed {
      opacity: 1;
      color: var(--sumi);
    }

    .analysis-checklist-item .check-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .analysis-checklist-item .check-icon svg {
      width: 14px;
      height: 14px;
      color: var(--shu);
    }

    .analysis-checklist-item .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--kage);
      border-top-color: var(--shu);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* ========== HTTPS警告 ========== */
    .https-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 0.75rem 1rem;
      padding-top: calc(0.75rem + var(--safe-area-top));
      background: rgba(201, 74, 74, 0.95);
      color: white;
      font-size: 0.85rem;
      text-align: center;
      z-index: 200;
    }

    .https-warning.visible {
      display: block;
    }

    /* ========== レスポンシブ ========== */
    @media (min-width: 481px) {
      .app-container {
        padding: 0 2rem 3rem;
      }

      .logo {
        font-size: 3rem;
      }

      .scan-area {
        aspect-ratio: 4 / 5;
      }
    }

    /* 小さい画面用の調整 */
    @media (max-height: 700px) {
      header {
        padding: 1rem 0 0.5rem;
      }

      .logo {
        font-size: 2rem;
      }

      .logo-sub {
        font-size: 0.7rem;
        margin-top: 0.25rem;
      }

      .scan-section {
        margin: 1rem 0;
      }

      .scan-area {
        aspect-ratio: 4 / 5;
      }
    }

    /* ========== ダッシュボード画面 ========== */
    .dashboard-screen {
      padding: 1rem 0;
    }

    .dashboard-summary {
      background: var(--washi);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px var(--kage);
    }

    .dashboard-summary h2 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.3rem;
      color: var(--sumi);
      margin-bottom: 1rem;
      text-align: center;
    }

    .dashboard-sub-label {
      text-align: center;
      font-size: 0.85rem;
      color: var(--sumi-light);
      margin-bottom: 1rem;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat-card {
      background: var(--kinari);
      padding: 1rem;
      border-radius: 6px;
      text-align: center;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--sumi-light);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--shu);
    }

    .stat-value.count {
      color: var(--ai);
    }

    .category-breakdown {
      background: var(--washi);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px var(--kage);
    }

    .category-breakdown h3 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.1rem;
      color: var(--sumi);
      margin-bottom: 1rem;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--kage);
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .category-item-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .category-icon {
      font-size: 1.5rem;
    }

    .category-name {
      font-size: 0.95rem;
      color: var(--sumi);
    }

    .category-amount {
      font-size: 1rem;
      font-weight: 600;
      color: var(--ai);
    }

    .goal-section {
      background: var(--washi);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px var(--kage);
    }

    .goal-section h3 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.1rem;
      color: var(--sumi);
      margin-bottom: 0.9rem;
    }

    .goal-controls {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 0.75rem;
      align-items: end;
    }

    .goal-field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .goal-field label {
      font-size: 0.85rem;
      color: var(--sumi-light);
      font-weight: 600;
    }

    .goal-field select,
    .goal-field input {
      border: 1.5px solid var(--kage);
      border-radius: 6px;
      padding: 0.65rem 0.75rem;
      font-size: 1rem;
      background: white;
      color: var(--sumi);
    }

    .goal-field select:focus,
    .goal-field input:focus {
      outline: none;
      border-color: var(--ai);
      box-shadow: 0 0 0 3px rgba(139, 169, 195, 0.15);
    }

    .goal-save-btn {
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, var(--ai) 0%, #7b9dbc 100%);
      color: #fff;
      font-weight: 700;
      padding: 0.7rem 1rem;
      cursor: pointer;
      min-width: 86px;
      transition: transform 0.2s, opacity 0.2s;
    }

    .goal-save-btn:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    .goal-hint {
      margin-top: 0.7rem;
      font-size: 0.82rem;
      color: var(--sumi-light);
    }

    .marimo-section {
      background: linear-gradient(180deg, #f8fbff 0%, #eef7ff 55%, #e7efe1 100%);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px var(--kage);
      border: 1px solid rgba(139, 169, 195, 0.22);
    }

    .marimo-section h3 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.1rem;
      color: var(--sumi);
      margin-bottom: 0.7rem;
    }

    .marimo-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.6rem;
      padding: 0.8rem 0;
    }

    .marimo-character {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #8cd689 0%, #2f9f4a 70%, #256d37 100%);
      box-shadow: inset -10px -14px 0 rgba(22, 90, 40, 0.25), 0 10px 16px rgba(21, 73, 42, 0.24);
      position: relative;
      transition: transform 0.35s ease, filter 0.35s ease, background 0.35s ease;
    }

    .marimo-eye {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #12331f;
      top: 44%;
    }

    .marimo-eye.left {
      left: 38%;
    }

    .marimo-eye.right {
      right: 38%;
    }

    .marimo-mouth {
      position: absolute;
      width: 30px;
      height: 16px;
      border: 3px solid #12331f;
      border-top: none;
      border-left: none;
      border-right: none;
      border-radius: 0 0 20px 20px;
      left: 50%;
      transform: translateX(-50%);
      top: 58%;
    }

    .marimo-badges {
      display: flex;
      gap: 0.45rem;
      min-height: 1.4rem;
      align-items: center;
      justify-content: center;
    }

    .marimo-badge {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 999px;
      font-size: 0.78rem;
      color: var(--sumi);
      padding: 0.2rem 0.55rem;
    }

    .marimo-status {
      text-align: center;
      font-size: 0.9rem;
      color: var(--sumi);
      line-height: 1.5;
    }

    .marimo-character.growth-small {
      transform: scale(0.78);
    }

    .marimo-character.growth-mid {
      transform: scale(1);
    }

    .marimo-character.growth-large {
      transform: scale(1.18);
    }

    .marimo-character.state-charming {
      filter: saturate(1.2) brightness(1.05);
    }

    .marimo-character.state-charming::after {
      content: '✨';
      position: absolute;
      top: -12px;
      right: -6px;
      font-size: 1.1rem;
    }

    .marimo-character.state-ugly {
      background: radial-gradient(circle at 30% 30%, #8a9665 0%, #676443 70%, #4e412c 100%);
      filter: saturate(0.75) contrast(1.1);
      transform: scale(1.2) rotate(-4deg);
    }

    .marimo-character.state-ugly .marimo-mouth {
      width: 26px;
      height: 10px;
      border-top: 3px solid #2f2418;
      border-bottom: none;
      border-left: none;
      border-right: none;
      border-radius: 18px 18px 0 0;
      top: 61%;
    }

    @media (max-width: 420px) {
      .goal-controls {
        grid-template-columns: 1fr;
      }

      .goal-save-btn {
        width: 100%;
      }
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--sumi-light);
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .empty-state p {
      font-size: 1rem;
      line-height: 1.6;
    }

    /* ========== 履歴画面 ========== */
    .history-screen {
      padding: 1rem 0;
    }

    .history-header {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .history-header h2 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.5rem;
      color: var(--sumi);
      margin-bottom: 0.5rem;
    }

    .history-count {
      font-size: 0.9rem;
      color: var(--sumi-light);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .history-card {
      background: var(--washi);
      border-radius: 8px;
      padding: 1.25rem;
      box-shadow: 0 2px 10px var(--kage);
      transition: all 0.3s ease;
    }

    .history-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--kage);
    }

    .history-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .history-store {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--sumi);
    }

    .history-amount {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--shu);
    }

    .history-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--sumi-light);
    }

    .history-date {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .history-category {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      background: var(--kinari);
      border-radius: 12px;
      font-size: 0.8rem;
    }

    /* ========== カレンダー画面 ========== */
    .calendar-screen {
      padding: 1rem 0;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 0 1rem;
    }

    .calendar-month {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.3rem;
      color: var(--sumi);
      font-weight: 600;
    }

    .calendar-nav-btn {
      background: var(--kinari);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px var(--kage);
    }

    .calendar-nav-btn:hover {
      background: var(--ai);
    }

    .calendar-nav-btn:hover svg {
      stroke: white;
    }

    .calendar-nav-btn svg {
      width: 20px;
      height: 20px;
      stroke: var(--sumi);
      transition: stroke 0.2s;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      padding: 0 0.5rem;
    }

    .weekday {
      text-align: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--sumi-light);
      padding: 0.5rem 0;
    }

    .weekday:first-child {
      color: var(--shu);
    }

    .weekday:last-child {
      color: var(--ai);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      padding: 0 0.5rem;
    }

    .calendar-day {
      background: var(--washi);
      border-radius: 6px;
      padding: 0.5rem;
      min-height: 70px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px var(--kage);
      position: relative;
    }

    .calendar-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--kage);
    }

    .calendar-day.other-month {
      background: var(--kinari);
      opacity: 0.5;
    }

    .calendar-day.today {
      border: 2px solid var(--shu);
      background: rgba(217, 83, 79, 0.05);
    }

    .calendar-day.has-receipts {
      background: linear-gradient(135deg, var(--washi) 0%, rgba(139, 169, 195, 0.1) 100%);
    }

    .calendar-day-number {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--sumi);
      margin-bottom: 0.25rem;
    }

    .calendar-day.other-month .calendar-day-number {
      color: var(--sumi-light);
    }

    .calendar-day-info {
      font-size: 0.7rem;
      color: var(--ai);
      line-height: 1.3;
    }

    .calendar-day-count {
      display: block;
      font-weight: 600;
    }

    .calendar-day-total {
      display: block;
      color: var(--shu);
    }

    /* 日付詳細モーダル */
    .calendar-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      padding: 1rem;
      overflow-y: auto;
    }

    .calendar-detail-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-detail-content {
      background: var(--washi);
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .calendar-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 2px solid var(--kage);
    }

    .calendar-detail-header h3 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.3rem;
      color: var(--sumi);
      margin: 0;
    }

    .calendar-detail-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: var(--sumi-light);
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .calendar-detail-close:hover {
      background: var(--kage);
      color: var(--shu);
    }

    .calendar-detail-summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding: 1.5rem;
      background: var(--kinari);
    }

    .calendar-detail-stat {
      text-align: center;
    }

    .calendar-detail-stat .label {
      display: block;
      font-size: 0.85rem;
      color: var(--sumi-light);
      margin-bottom: 0.5rem;
    }

    .calendar-detail-stat .value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--shu);
    }

    .calendar-detail-stat .value.count {
      color: var(--ai);
    }

    .calendar-detail-list {
      padding: 1rem;
    }

    .calendar-detail-item {
      background: white;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 3px var(--kage);
      transition: all 0.2s;
    }

    .calendar-detail-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 6px var(--kage);
    }

    .calendar-detail-item:last-child {
      margin-bottom: 0;
    }

    .calendar-detail-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .calendar-detail-store {
      font-weight: 600;
      color: var(--sumi);
      font-size: 1rem;
    }

    .calendar-detail-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--shu);
    }

    .calendar-detail-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: var(--sumi-light);
    }

    .calendar-detail-category {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .calendar-detail-open {
      margin-top: 0.75rem;
      width: 100%;
      border: 1px solid var(--ai);
      background: rgba(139, 169, 195, 0.08);
      color: var(--ai);
      border-radius: 6px;
      padding: 0.55rem 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-detail-open:hover {
      background: rgba(139, 169, 195, 0.16);
    }

    .history-card {
      cursor: pointer;
    }

    .receipt-edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1100;
      padding: 1rem;
      overflow-y: auto;
    }

    .receipt-edit-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .receipt-edit-content {
      background: var(--washi);
      border-radius: 12px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .receipt-edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 2px solid var(--kage);
    }

    .receipt-edit-header h3 {
      margin: 0;
      font-family: 'Noto Serif JP', serif;
      color: var(--sumi);
    }

    .receipt-edit-form {
      padding: 1.25rem 1.5rem;
      display: grid;
      gap: 1rem;
    }

    .receipt-edit-field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .receipt-edit-field label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--sumi);
    }

    .receipt-edit-field input,
    .receipt-edit-field select {
      border: 1.5px solid var(--kage);
      border-radius: 6px;
      padding: 0.65rem 0.8rem;
      font-size: 1rem;
      background: white;
      color: var(--sumi);
    }

    .receipt-edit-field input:focus,
    .receipt-edit-field select:focus {
      outline: none;
      border-color: var(--ai);
      box-shadow: 0 0 0 3px rgba(139, 169, 195, 0.15);
    }

    .receipt-edit-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      padding: 0 1.5rem 1.5rem;
    }
  </style>
</head>
<body>
  <!-- HTTPS警告 -->
  <div class="https-warning" id="httpsWarning">
    カメラ機能を使用するには、HTTPS接続が必要です
  </div>

  <div class="app-container">
    <!-- ヘッダー -->
    <header>
      <h1 class="logo">
        領収読
        <span class="logo-sub">りょうしゅうよみ</span>
      </h1>
    </header>

    <!-- モード切り替えタブ -->
    <div class="mode-tabs">
      <button class="mode-tab active" id="cameraModeTab" aria-label="カメラモード">
        <svg class="mode-tab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2v11z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        カメラ
      </button>
      <button class="mode-tab" id="galleryModeTab" aria-label="ギャラリーモード">
        <svg class="mode-tab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M3 15l5-5 4 4 5-5 4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
        </svg>
        ギャラリー
      </button>
    </div>

    <!-- ナビゲーションバー -->
    <nav class="main-nav">
      <button class="nav-btn active" data-screen="camera" id="navCamera">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2v11z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
        <span>カメラ</span>
      </button>
      <button class="nav-btn" data-screen="dashboard" id="navDashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
        <span>ダッシュボード</span>
      </button>
      <button class="nav-btn" data-screen="calendar" id="navCalendar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span>カレンダー</span>
      </button>
      <button class="nav-btn" data-screen="history" id="navHistory">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3h7l2 3h9a2 2 0 012 2v11a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"/>
        </svg>
        <span>履歴</span>
      </button>
    </nav>

    <!-- カメラ画面 -->
    <div id="cameraScreen" class="screen active">
      <!-- スキャンエリア -->
      <section class="scan-section" aria-label="レシートスキャンエリア">
      <div class="scan-area" id="scanArea" role="button" tabindex="0" aria-label="クリックしてレシートを撮影または選択">
        <!-- 障子風グロー -->
        <div class="scan-glow"></div>

        <!-- フレーム -->
        <div class="scan-frame">
          <div class="scan-frame-corner scan-frame-corner--tl"></div>
          <div class="scan-frame-corner scan-frame-corner--tr"></div>
          <div class="scan-frame-corner scan-frame-corner--bl"></div>
          <div class="scan-frame-corner scan-frame-corner--br"></div>
        </div>

        <!-- プレースホルダーコンテンツ -->
        <div class="scan-content" id="scanContent">
          <svg class="scan-icon" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="15" width="60" height="50" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M20 55 L32 40 L42 48 L55 32 L65 45" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="30" cy="30" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M40 5 L40 12 M40 68 L40 75 M5 40 L12 40 M68 40 L75 40" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
          </svg>
          <p class="scan-text">タップしてレシートを読み込む</p>
        </div>

        <!-- カメラビデオ -->
        <video class="camera-video" id="cameraVideo" autoplay playsinline muted></video>

        <!-- キャプチャプレビュー（撮影後の静止画） -->
        <img class="capture-preview" id="capturePreview" alt="撮影プレビュー">

        <!-- 画像プレビュー（ギャラリーから） -->
        <img class="scan-preview" id="scanPreview" alt="レシートプレビュー">

        <!-- キャプチャ用キャンバス -->
        <canvas class="capture-canvas" id="captureCanvas"></canvas>

        <!-- シャッターエフェクト -->
        <div class="shutter-effect" id="shutterEffect"></div>

        <!-- カメラ切り替えボタン -->
        <button class="camera-switch-btn" id="cameraSwitchBtn" aria-label="カメラを切り替え">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 5h-3.17L15 3H9L7.17 5H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V7a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M12 17a4 4 0 100-8 4 4 0 000 8z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M9 12h6M12 9l-2 3 2 3M12 9l2 3-2 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- 撮り直しボタン -->
        <button class="retake-btn" id="retakeBtn">撮り直す</button>

        <!-- カメラエラー表示 -->
        <div class="camera-error" id="cameraError">
          <svg class="camera-error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <h3 class="camera-error-title" id="cameraErrorTitle">カメラにアクセスできません</h3>
          <p class="camera-error-message" id="cameraErrorMessage">カメラへのアクセスが拒否されました。設定からカメラへのアクセスを許可してください。</p>
          <!-- カメラ操作ボタン群 -->
          <div class="camera-error-buttons">
            <button class="camera-error-retry" id="cameraErrorRetry">再試行</button>
            <button class="camera-error-fallback" id="cameraErrorFallback">ギャラリーから選択</button>
          </div>
        </div>

        <!-- スキャンライン -->
        <div class="scan-line" id="scanLine"></div>
      </div>
    </section>

    <!-- アクションボタン（ギャラリーモード用） -->
    <div class="action-buttons hidden" id="actionButtons">
      <button class="btn btn-primary" id="cameraBtn" aria-label="カメラで撮影">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2v11z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        撮影
      </button>
      <button class="btn btn-secondary" id="galleryBtn" aria-label="ギャラリーから選択">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M3 15l5-5 4 4 5-5 4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
        </svg>
        選択
      </button>
    </div>

    <!-- 撮影モード選択（横並び） -->
    <div class="capture-mode-section" id="captureModeSection">
      <div class="capture-mode-buttons">
        <button class="capture-mode-btn active" id="singleModeBtn" data-mode="single">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <span>1枚撮影</span>
        </button>
        <button class="capture-mode-btn" id="continuousModeBtn" data-mode="continuous">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="4" width="14" height="14" rx="2"/>
            <rect x="6" y="2" width="14" height="14" rx="2"/>
            <rect x="10" y="6" width="14" height="14" rx="2"/>
          </svg>
          <span id="continuousModeText">まとめ撮り</span>
          <span class="frame-count" id="frameCount">0</span>
        </button>
      </div>

      <!-- シャッターボタン -->
      <button class="shutter-btn" id="shutterBtn" aria-label="シャッター"></button>
    </div>

    <!-- 解析ボタン -->
    <div class="analyze-section">
      <button class="btn btn-analyze" id="analyzeBtn" disabled aria-label="レシートを解析">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 2v6h6M9 15h6M9 11h6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
        レシートを解析する
      </button>
    </div>

    <!-- まとめ撮り結果表示エリア -->
    <section class="batch-results-section" id="batchResultsSection" aria-label="まとめ撮り結果">
      <div class="batch-results-header">
        <h2>まとめ撮り完了</h2>
        <p class="batch-count"><span id="batchCount">0</span>件のレシートを検出しました</p>
      </div>
      <div class="batch-results-grid" id="batchResultsGrid">
        <!-- レシートカードが動的に追加される -->
      </div>
      <div class="batch-actions">
        <button class="btn btn-primary" id="saveAllBtn">すべて保存</button>
        <button class="btn btn-secondary" id="closeBatchBtn">閉じる</button>
      </div>
    </section>

    <!-- 結果表示エリア -->
    <section class="result-section" id="resultSection" aria-label="読み取り結果">
      <div class="result-card" id="resultCard">
        <div class="result-header">
          <div class="result-edit-section">
            <div class="edit-field">
              <label>店舗名</label>
              <input type="text" class="store-name-input" id="storeNameInput" placeholder="店舗名を入力">
            </div>
            <div class="edit-field">
              <label>日付</label>
              <input type="date" class="receipt-date-input" id="receiptDateInput">
            </div>
            <div class="edit-field">
              <label>合計金額</label>
              <input type="number" class="total-amount-input" id="totalAmountInput" placeholder="金額を入力">
            </div>
          </div>
        </div>
        <div class="category-section" id="categorySection">
          <p class="category-label">カテゴリ</p>
          <div class="category-buttons" id="categoryButtons">
            <!-- 動的に追加 -->
          </div>
        </div>
        <ul class="result-items" id="resultItems">
          <!-- 動的に追加 -->
        </ul>
        <div class="result-actions">
          <button class="btn btn-primary btn-register" id="registerReceiptBtn">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            登録
          </button>
        </div>
      </div>
    </section>

      <!-- 履歴リンク -->
      <div class="history-section">
        <a href="#" class="history-link" id="historyLink" aria-label="履歴を見る">
          <svg class="history-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          過去の履歴を見る
        </a>
      </div>
    </div>

    <!-- ダッシュボード画面 -->
    <div id="dashboardScreen" class="screen">
      <div class="dashboard-screen">
        <div class="dashboard-summary">
          <h2 id="dashboardPeriodTitle">今月の集計</h2>
          <p class="dashboard-sub-label" id="dashboardPeriodLabel">集計期間: 今月</p>
          <div class="summary-stats">
            <div class="stat-card">
              <div class="stat-label">合計金額</div>
              <div class="stat-value" id="dashboardTotal">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">レシート数</div>
              <div class="stat-value count" id="dashboardCount">0</div>
            </div>
          </div>
        </div>

        <div class="goal-section">
          <h3>予算目標</h3>
          <div class="goal-controls">
            <div class="goal-field">
              <label for="goalPeriodSelect">期間</label>
              <select id="goalPeriodSelect">
                <option value="week">1週間</option>
                <option value="month">1か月</option>
              </select>
            </div>
            <div class="goal-field">
              <label for="goalAmountInput">目標金額（円）</label>
              <input type="number" id="goalAmountInput" min="1" step="1" placeholder="例: 30000">
            </div>
            <button class="goal-save-btn" id="saveGoalBtn">保存</button>
          </div>
          <p class="goal-hint" id="goalHintText">目標に近づくとマリもが魅力的に育ちます。</p>
        </div>

        <div class="marimo-section">
          <h3>マリもの成長</h3>
          <div class="marimo-wrap">
            <div class="marimo-character growth-mid" id="marimoCharacter">
              <span class="marimo-eye left"></span>
              <span class="marimo-eye right"></span>
              <span class="marimo-mouth"></span>
            </div>
            <div class="marimo-badges" id="marimoBadges"></div>
            <p class="marimo-status" id="marimoStatusText">まずは目標を設定してください。</p>
          </div>
        </div>

        <div class="category-breakdown">
          <h3 id="categoryBreakdownTitle">カテゴリ別集計</h3>
          <div id="categoryBreakdownList">
            <!-- 動的に追加 -->
          </div>
        </div>
      </div>
    </div>

    <!-- カレンダー画面 -->
    <div id="calendarScreen" class="screen">
      <div class="calendar-screen">
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prevMonthBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h2 class="calendar-month" id="calendarMonth">2026年1月</h2>
          <button class="calendar-nav-btn" id="nextMonthBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>

        <div class="calendar-weekdays">
          <div class="weekday">日</div>
          <div class="weekday">月</div>
          <div class="weekday">火</div>
          <div class="weekday">水</div>
          <div class="weekday">木</div>
          <div class="weekday">金</div>
          <div class="weekday">土</div>
        </div>

        <div class="calendar-grid" id="calendarGrid">
          <!-- 動的に生成 -->
        </div>

        <!-- 日付詳細モーダル -->
        <div class="calendar-detail-modal" id="calendarDetailModal">
          <div class="calendar-detail-content">
            <div class="calendar-detail-header">
              <h3 id="calendarDetailDate">2026年1月18日</h3>
              <button class="calendar-detail-close" id="calendarDetailClose">×</button>
            </div>
            <div class="calendar-detail-summary">
              <div class="calendar-detail-stat">
                <span class="label">合計</span>
                <span class="value" id="calendarDetailTotal">¥0</span>
              </div>
              <div class="calendar-detail-stat">
                <span class="label">件数</span>
                <span class="value count" id="calendarDetailCount">0件</span>
              </div>
            </div>
            <div class="calendar-detail-list" id="calendarDetailList">
              <!-- 動的に生成 -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 履歴画面 -->
    <div id="historyScreen" class="screen">
      <div class="history-screen">
        <div class="history-header">
          <h2>保存済みレシート</h2>
          <p class="history-count"><span id="historyCount">0</span>件</p>
        </div>
        <div class="history-list" id="historyList">
          <!-- 動的に追加 -->
        </div>
      </div>
    </div>

    <!-- 隠しファイル入力 -->
    <input type="file" class="hidden-input" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" class="hidden-input" id="galleryInput" accept="image/*">
  </div>

  <!-- レシート詳細・編集モーダル -->
  <div class="receipt-edit-modal" id="receiptEditModal">
    <div class="receipt-edit-content">
      <div class="receipt-edit-header">
        <h3>レシート詳細・編集</h3>
        <button class="calendar-detail-close" id="receiptEditClose">×</button>
      </div>
      <div class="receipt-edit-form">
        <div class="receipt-edit-field">
          <label for="editStoreNameInput">店舗名</label>
          <input type="text" id="editStoreNameInput" placeholder="店舗名">
        </div>
        <div class="receipt-edit-field">
          <label for="editReceiptDateInput">日付</label>
          <input type="date" id="editReceiptDateInput">
        </div>
        <div class="receipt-edit-field">
          <label for="editTotalAmountInput">合計金額</label>
          <input type="number" id="editTotalAmountInput" placeholder="金額">
        </div>
        <div class="receipt-edit-field">
          <label for="editCategorySelect">カテゴリ</label>
          <select id="editCategorySelect">
            <option value="">カテゴリを選択</option>
          </select>
        </div>
      </div>
      <div class="receipt-edit-actions">
        <button class="btn btn-secondary" id="receiptEditCancelBtn">キャンセル</button>
        <button class="btn btn-primary" id="receiptEditSaveBtn">保存</button>
      </div>
    </div>
  </div>

  <!-- ローディングオーバーレイ（解析中表示） -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-circle"></div>
    <p class="loading-text">解析中...</p>
    <!-- プログレスバー（連続スキャン時の進捗表示） -->
    <div class="progress-bar-container" id="progressBarContainer">
      <div class="progress-bar" id="analysisProgressBar"></div>
    </div>
    <!-- 完了チェックリスト（各フレーム解析状況） -->
    <div class="analysis-checklist" id="analysisChecklist"></div>
  </div>

  <script>
    // ========== DOM要素 ==========
    const scanArea = document.getElementById('scanArea');
    const scanContent = document.getElementById('scanContent');
    const scanPreview = document.getElementById('scanPreview');
    const scanLine = document.getElementById('scanLine');
    const cameraBtn = document.getElementById('cameraBtn');
    const galleryBtn = document.getElementById('galleryBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const cameraInput = document.getElementById('cameraInput');
    const galleryInput = document.getElementById('galleryInput');
    const resultSection = document.getElementById('resultSection');
    const resultCard = document.getElementById('resultCard');
    const storeNameInput = document.getElementById('storeNameInput');
    const receiptDateInput = document.getElementById('receiptDateInput');
    const totalAmountInput = document.getElementById('totalAmountInput');
    const resultItems = document.getElementById('resultItems');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const categorySection = document.getElementById('categorySection');
    const categoryButtons = document.getElementById('categoryButtons');
    const registerReceiptBtn = document.getElementById('registerReceiptBtn');

    // まとめ撮り結果表示要素
    const batchResultsSection = document.getElementById('batchResultsSection');
    const batchCount = document.getElementById('batchCount');
    const batchResultsGrid = document.getElementById('batchResultsGrid');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const closeBatchBtn = document.getElementById('closeBatchBtn');

    // カメラ関連要素
    const cameraVideo = document.getElementById('cameraVideo');
    const captureCanvas = document.getElementById('captureCanvas');
    const capturePreview = document.getElementById('capturePreview');
    const shutterEffect = document.getElementById('shutterEffect');
    const cameraSwitchBtn = document.getElementById('cameraSwitchBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const cameraError = document.getElementById('cameraError');
    const cameraErrorTitle = document.getElementById('cameraErrorTitle');
    const cameraErrorMessage = document.getElementById('cameraErrorMessage');
    const cameraErrorRetry = document.getElementById('cameraErrorRetry');
    const cameraErrorFallback = document.getElementById('cameraErrorFallback');
    const httpsWarning = document.getElementById('httpsWarning');

    // モード切り替え要素
    const cameraModeTab = document.getElementById('cameraModeTab');
    const galleryModeTab = document.getElementById('galleryModeTab');
    const actionButtons = document.getElementById('actionButtons');
    const captureModeSection = document.getElementById('captureModeSection');
    const singleModeBtn = document.getElementById('singleModeBtn');
    const continuousModeBtn = document.getElementById('continuousModeBtn');
    const continuousModeText = document.getElementById('continuousModeText');
    const frameCount = document.getElementById('frameCount');
    const shutterBtn = document.getElementById('shutterBtn');

    // 画面切り替え要素
    const navCamera = document.getElementById('navCamera');
    const navDashboard = document.getElementById('navDashboard');
    const navCalendar = document.getElementById('navCalendar');
    const navHistory = document.getElementById('navHistory');
    const cameraScreen = document.getElementById('cameraScreen');
    const dashboardScreen = document.getElementById('dashboardScreen');
    const calendarScreen = document.getElementById('calendarScreen');
    const historyScreen = document.getElementById('historyScreen');

    // ダッシュボード要素
    const dashboardTotal = document.getElementById('dashboardTotal');
    const dashboardCount = document.getElementById('dashboardCount');
    const categoryBreakdownList = document.getElementById('categoryBreakdownList');
    const categoryBreakdownTitle = document.getElementById('categoryBreakdownTitle');
    const dashboardPeriodTitle = document.getElementById('dashboardPeriodTitle');
    const dashboardPeriodLabel = document.getElementById('dashboardPeriodLabel');
    const goalPeriodSelect = document.getElementById('goalPeriodSelect');
    const goalAmountInput = document.getElementById('goalAmountInput');
    const saveGoalBtn = document.getElementById('saveGoalBtn');
    const goalHintText = document.getElementById('goalHintText');
    const marimoCharacter = document.getElementById('marimoCharacter');
    const marimoBadges = document.getElementById('marimoBadges');
    const marimoStatusText = document.getElementById('marimoStatusText');

    // 履歴要素
    const historyCount = document.getElementById('historyCount');
    const historyList = document.getElementById('historyList');
    const historyLink = document.getElementById('historyLink');

    // カレンダー要素
    const calendarMonth = document.getElementById('calendarMonth');
    const calendarGrid = document.getElementById('calendarGrid');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const calendarDetailModal = document.getElementById('calendarDetailModal');
    const calendarDetailDate = document.getElementById('calendarDetailDate');
    const calendarDetailTotal = document.getElementById('calendarDetailTotal');
    const calendarDetailCount = document.getElementById('calendarDetailCount');
    const calendarDetailList = document.getElementById('calendarDetailList');
    const calendarDetailClose = document.getElementById('calendarDetailClose');
    const receiptEditModal = document.getElementById('receiptEditModal');
    const receiptEditClose = document.getElementById('receiptEditClose');
    const receiptEditCancelBtn = document.getElementById('receiptEditCancelBtn');
    const receiptEditSaveBtn = document.getElementById('receiptEditSaveBtn');
    const editStoreNameInput = document.getElementById('editStoreNameInput');
    const editReceiptDateInput = document.getElementById('editReceiptDateInput');
    const editTotalAmountInput = document.getElementById('editTotalAmountInput');
    const editCategorySelect = document.getElementById('editCategorySelect');

    // ========== 状態管理 ==========
    let hasImage = false;
    let isStreaming = false;
    let currentFacingMode = 'environment'; // 'environment'（背面）or 'user'（前面）
    let capturedImageData = null;
    let currentStream = null;
    let currentMode = 'camera'; // 'camera' or 'gallery'
    let availableCameras = [];
    let currentReceiptData = null;
    let selectedCategory = null;
    let isContinuousMode = false;
    let isContinuousRunning = false;
    let continuousIntervalId = null;
    let continuousFrames = []; // { dataUrl, thumbUrl, score }
    let isAnalyzing = false; // 解析中フラグ（重複防止）
    let receiptResults = []; // 複数のレシート解析結果を保存
    let lastReceiptDetectionTime = 0; // 最後のレシート検出時刻
    let currentScreen = 'camera'; // 'camera', 'dashboard', 'calendar', 'history'
    let currentCalendarYear = new Date().getFullYear();
    let currentCalendarMonth = new Date().getMonth() + 1; // 1-12
    let editingReceiptId = null;
    let goalSettings = {
      period: 'week',
      amount: 0
    };

    // ========== カテゴリ定義 ==========
    const categories = [
      { id: 'food', name: '食費', icon: '🍽️', class: 'category-food' },
      { id: 'transport', name: '交通費', icon: '🚃', class: 'category-transport' },
      { id: 'daily', name: '日用品', icon: '🛒', class: 'category-daily' },
      { id: 'entertainment', name: '娯楽', icon: '🎬', class: 'category-entertainment' },
      { id: 'medical', name: '医療', icon: '🏥', class: 'category-medical' },
      { id: 'education', name: '教育', icon: '📚', class: 'category-education' },
      { id: 'other', name: 'その他', icon: '📝', class: 'category-other' }
    ];

    // ========== LocalStorage管理クラス ==========
    class ReceiptStorage {
      constructor() {
        this.storageKey = 'receipts';
        this.settingsKey = 'settings';
        this.maxReceipts = 100; // 最大保存件数
      }

      // すべてのレシートを取得
      getAll() {
        try {
          const data = localStorage.getItem(this.storageKey);
          return data ? JSON.parse(data) : [];
        } catch (error) {
          console.error('LocalStorage読み込みエラー:', error);
          return [];
        }
      }

      // レシートを保存
      save(receipt) {
        try {
          const receipts = this.getAll();

          // IDがない場合は生成
          if (!receipt.id) {
            receipt.id = 'receipt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          }

          // タイムスタンプがない場合は追加
          if (!receipt.timestamp) {
            receipt.timestamp = Date.now();
          }

          if (!receipt.createdAt) {
            receipt.createdAt = new Date().toISOString();
          }

          receipts.push(receipt);

          // 最大件数を超えたら古いものを削除
          if (receipts.length > this.maxReceipts) {
            receipts.sort((a, b) => a.timestamp - b.timestamp);
            receipts.splice(0, receipts.length - this.maxReceipts);
          }

          localStorage.setItem(this.storageKey, JSON.stringify(receipts));
          console.log('レシートを保存しました:', receipt.id);
          return receipt.id;
        } catch (error) {
          console.error('LocalStorage保存エラー:', error);
          if (error.name === 'QuotaExceededError') {
            // 容量超過の場合、古いデータを削除してリトライ
            this.cleanupOldData();
            return this.save(receipt);
          }
          throw error;
        }
      }

      // 指定日付のレシートを取得
      getByDate(dateString) {
        const receipts = this.getAll();
        return receipts.filter(r => r.date === dateString);
      }

      // 指定月のレシートを取得
      getByMonth(year, month) {
        const receipts = this.getAll();
        const targetMonth = `${year}-${String(month).padStart(2, '0')}`;
        return receipts.filter(r => r.date && r.date.startsWith(targetMonth));
      }

      // IDでレシートを取得
      getById(id) {
        const receipts = this.getAll();
        return receipts.find(r => r.id === id);
      }

      // レシートを削除
      delete(id) {
        try {
          const receipts = this.getAll();
          const filtered = receipts.filter(r => r.id !== id);
          localStorage.setItem(this.storageKey, JSON.stringify(filtered));
          console.log('レシートを削除しました:', id);
          return true;
        } catch (error) {
          console.error('削除エラー:', error);
          return false;
        }
      }

      // レシートを更新
      update(id, updates) {
        try {
          const receipts = this.getAll();
          const index = receipts.findIndex(r => r.id === id);
          if (index === -1) return false;

          receipts[index] = {
            ...receipts[index],
            ...updates,
            updatedAt: new Date().toISOString()
          };
          localStorage.setItem(this.storageKey, JSON.stringify(receipts));
          return true;
        } catch (error) {
          console.error('更新エラー:', error);
          return false;
        }
      }

      // 古いデータをクリーンアップ
      cleanupOldData() {
        const receipts = this.getAll();
        if (receipts.length > 50) {
          receipts.sort((a, b) => a.timestamp - b.timestamp);
          const keep = receipts.slice(-50);
          localStorage.setItem(this.storageKey, JSON.stringify(keep));
          console.log('古いデータを削除しました');
        }
      }

      // 全データをクリア
      clearAll() {
        localStorage.removeItem(this.storageKey);
        console.log('全データをクリアしました');
      }

      getSettings() {
        try {
          const raw = localStorage.getItem(this.settingsKey);
          return raw ? JSON.parse(raw) : {};
        } catch (error) {
          console.error('設定読み込みエラー:', error);
          return {};
        }
      }

      saveSettings(settings) {
        try {
          const current = this.getSettings();
          const merged = { ...current, ...settings };
          localStorage.setItem(this.settingsKey, JSON.stringify(merged));
          return true;
        } catch (error) {
          console.error('設定保存エラー:', error);
          return false;
        }
      }
    }

    // ストレージインスタンスを作成
    const storage = new ReceiptStorage();

    // ========== 初期化 ==========
    async function init() {
      // HTTPS チェック
      checkHttps();

      // カメラの利用可能性をチェック
      await checkCameraAvailability();

      // イベントリスナーの設定
      setupEventListeners();

      // 目標設定の初期値をロード
      loadGoalSettings();

      // カメラモードで初期化
      if (isCameraSupported()) {
        switchToMode('camera');
      } else {
        // カメラが使えない場合はギャラリーモードに
        switchToMode('gallery');
      }
    }

    // HTTPSチェック
    function checkHttps() {
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (!isSecure) {
        httpsWarning.classList.add('visible');
      }
    }

    // カメラサポートチェック
    function isCameraSupported() {
      return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    }

    // カメラの利用可能性をチェック
    async function checkCameraAvailability() {
      if (!isCameraSupported()) {
        return;
      }

      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        availableCameras = devices.filter(device => device.kind === 'videoinput');

        // カメラが2つ以上ある場合のみ切り替えボタンを表示可能に
        if (availableCameras.length <= 1) {
          cameraSwitchBtn.style.display = 'none';
        }
      } catch (error) {
        console.warn('カメラ情報の取得に失敗:', error);
      }
    }

    // イベントリスナーの設定
    function setupEventListeners() {
      // ナビゲーションボタン
      navCamera.addEventListener('click', () => switchScreen('camera'));
      navDashboard.addEventListener('click', () => switchScreen('dashboard'));
      navCalendar.addEventListener('click', () => switchScreen('calendar'));
      navHistory.addEventListener('click', () => switchScreen('history'));

      // カレンダーナビゲーション
      prevMonthBtn.addEventListener('click', prevMonth);
      nextMonthBtn.addEventListener('click', nextMonth);
      calendarDetailClose.addEventListener('click', closeCalendarDetail);

      // カレンダーモーダルの背景クリックで閉じる
      calendarDetailModal.addEventListener('click', (e) => {
        if (e.target === calendarDetailModal) {
          closeCalendarDetail();
        }
      });

      // カレンダー詳細からレシート詳細を開く
      calendarDetailList.addEventListener('click', (e) => {
        const target = e.target.closest('.calendar-detail-open');
        if (!target) return;
        const { receiptId } = target.dataset;
        if (receiptId) {
          openReceiptEditor(receiptId);
        }
      });

      // モード切り替えタブ
      cameraModeTab.addEventListener('click', () => switchToMode('camera'));
      galleryModeTab.addEventListener('click', () => switchToMode('gallery'));

      // ギャラリーモードのボタン
      cameraBtn.addEventListener('click', () => cameraInput.click());
      galleryBtn.addEventListener('click', () => galleryInput.click());

      // スキャンエリアクリック（ギャラリーモード時のみ）
      scanArea.addEventListener('click', handleScanAreaClick);
      scanArea.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter' || e.key === ' ') && currentMode === 'gallery') {
          e.preventDefault();
          galleryInput.click();
        }
      });

      // ファイル選択
      cameraInput.addEventListener('change', handleFileSelect);
      galleryInput.addEventListener('change', handleFileSelect);

      // カメラ関連
      shutterBtn.addEventListener('click', capturePhoto);
      cameraSwitchBtn.addEventListener('click', switchCamera);
      retakeBtn.addEventListener('click', retakePhoto);

      // カメラエラー時の再試行ボタン
      cameraErrorRetry.addEventListener('click', () => {
        cameraError.classList.remove('visible');
        startCamera();
      });

      // カメラエラー時のギャラリー選択ボタン
      cameraErrorFallback.addEventListener('click', () => {
        switchToMode('gallery');
        galleryInput.click();
      });

      // 解析ボタン
      analyzeBtn.addEventListener('click', analyzeReceipt);

      // 撮影モード切り替え
      singleModeBtn.addEventListener('click', () => selectCaptureMode('single'));
      continuousModeBtn.addEventListener('click', () => selectCaptureMode('continuous'));

      // バッチ結果の保存・閉じる
      saveAllBtn.addEventListener('click', saveAllReceipts);
      closeBatchBtn.addEventListener('click', closeBatchResults);

      // バッチ結果グリッド内のボタン（イベント委譲）
      batchResultsGrid.addEventListener('click', handleBatchCardClick);

      // 1枚撮影の登録ボタン
      if (registerReceiptBtn) {
        registerReceiptBtn.addEventListener('click', registerSingleReceipt);
      }

      // ページ非表示時にカメラを停止
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && isStreaming) {
          stopCamera();
        } else if (!document.hidden && currentMode === 'camera' && !capturedImageData) {
          startCamera();
        }
      });

      // 履歴リンク
      if (historyLink) {
        historyLink.addEventListener('click', (e) => {
          e.preventDefault();
          switchScreen('history');
        });
      }

      // 履歴カードからレシート詳細を開く
      historyList.addEventListener('click', (e) => {
        const card = e.target.closest('.history-card');
        if (!card) return;
        const { receiptId } = card.dataset;
        if (receiptId) {
          openReceiptEditor(receiptId);
        }
      });

      // 編集モーダル制御
      receiptEditClose.addEventListener('click', closeReceiptEditor);
      receiptEditCancelBtn.addEventListener('click', closeReceiptEditor);
      receiptEditSaveBtn.addEventListener('click', saveReceiptEdit);
      receiptEditModal.addEventListener('click', (e) => {
        if (e.target === receiptEditModal) {
          closeReceiptEditor();
        }
      });

      // カテゴリ選択肢を初期化
      editCategorySelect.innerHTML = `
        <option value="">カテゴリを選択</option>
        ${categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('')}
      `;

      if (saveGoalBtn) {
        saveGoalBtn.addEventListener('click', handleSaveGoalSettings);
      }

      if (goalPeriodSelect) {
        goalPeriodSelect.addEventListener('change', () => {
          goalSettings.period = goalPeriodSelect.value === 'month' ? 'month' : 'week';
          if (currentScreen === 'dashboard') {
            loadDashboard();
          }
        });
      }
    }

    // スキャンエリアのクリック処理
    function handleScanAreaClick() {
      if (currentMode === 'gallery' && !hasImage) {
        galleryInput.click();
      }
    }

    // ========== 画面切り替え ==========
    function switchScreen(screenName) {
      try {
        // 現在の画面を記録
        currentScreen = screenName;

        // すべてのナビゲーションボタンとスクリーンを非アクティブに
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));

        // 選択された画面をアクティブに
        const selectedNavBtn = document.querySelector(`.nav-btn[data-screen="${screenName}"]`);
        if (selectedNavBtn) {
          selectedNavBtn.classList.add('active');
        }

        // 画面を表示
        switch (screenName) {
          case 'camera':
            cameraScreen.classList.add('active');
            break;
          case 'dashboard':
            dashboardScreen.classList.add('active');
            loadDashboard();
            break;
          case 'calendar':
            calendarScreen.classList.add('active');
            loadCalendar();
            break;
          case 'history':
            historyScreen.classList.add('active');
            loadHistory();
            break;
        }
      } catch (error) {
        console.error('画面切り替えエラー:', error);
      }
    }

    // ========== ダッシュボード表示 ==========
    function loadGoalSettings() {
      const settings = storage.getSettings();
      const rawGoal = settings.goal || {};

      goalSettings = {
        period: rawGoal.period === 'month' ? 'month' : 'week',
        amount: Math.max(0, parseInt(rawGoal.amount, 10) || 0)
      };

      if (goalPeriodSelect) {
        goalPeriodSelect.value = goalSettings.period;
      }
      if (goalAmountInput) {
        goalAmountInput.value = goalSettings.amount > 0 ? goalSettings.amount : '';
      }
    }

    function handleSaveGoalSettings() {
      const period = goalPeriodSelect && goalPeriodSelect.value === 'month' ? 'month' : 'week';
      const amount = goalAmountInput ? Math.max(0, parseInt(goalAmountInput.value, 10) || 0) : 0;

      if (amount <= 0) {
        alert('目標金額は1円以上で入力してください');
        if (goalAmountInput) goalAmountInput.focus();
        return;
      }

      goalSettings = { period, amount };
      storage.saveSettings({ goal: goalSettings });
      loadDashboard();
    }

    function getDashboardPeriodRange(period) {
      const now = new Date();

      if (period === 'month') {
        const start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
        const end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
        return { start, end, label: `${now.getMonth() + 1}月`, title: '今月の集計' };
      }

      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
      const start = new Date(end);
      start.setDate(start.getDate() - 6);
      start.setHours(0, 0, 0, 0);
      return { start, end, label: '直近7日間', title: '1週間の集計' };
    }

    function getReceiptsForPeriod(receipts, period) {
      const range = getDashboardPeriodRange(period);
      const filtered = receipts.filter((receipt) => {
        const date = parseReceiptDateToTime(receipt.date);
        if (!date) return false;
        return date >= range.start && date <= range.end;
      });
      return { filtered, range };
    }

    function formatRatioPercent(ratio) {
      if (!Number.isFinite(ratio)) return '0';
      return (ratio * 100).toFixed(0);
    }

    function renderMarimoStatus(totalAmount, goalAmount, period) {
      if (!marimoCharacter || !marimoStatusText || !marimoBadges) return;

      marimoCharacter.className = 'marimo-character';
      marimoBadges.innerHTML = '';
      const periodText = period === 'month' ? '1か月' : '1週間';

      if (!goalAmount || goalAmount <= 0) {
        marimoCharacter.classList.add('growth-mid');
        marimoStatusText.textContent = `${periodText}目標を設定すると、マリもが成長を始めます。`;
        goalHintText.textContent = '目標に近づくとマリもが魅力的に育ちます。';
        return;
      }

      const ratio = totalAmount / goalAmount;

      if (ratio >= 0.9 && ratio <= 1.05) {
        marimoCharacter.classList.add('growth-large', 'state-charming');
        marimoStatusText.textContent = `最高の状態です。目標にほぼ一致（達成率 ${formatRatioPercent(ratio)}%）。`;
        marimoBadges.innerHTML = '<span class="marimo-badge">魅力MAX</span><span class="marimo-badge">キラキラ</span>';
      } else if (ratio <= 0.7) {
        marimoCharacter.classList.add('growth-small');
        marimoStatusText.textContent = `まだ小さめです。使った金額は目標の ${formatRatioPercent(ratio)}%。`;
        marimoBadges.innerHTML = '<span class="marimo-badge">成長途中</span>';
      } else if (ratio <= 1.3) {
        marimoCharacter.classList.add('growth-mid');
        marimoStatusText.textContent = `少し膨らみ気味です。目標比 ${formatRatioPercent(ratio)}%。`;
        marimoBadges.innerHTML = '<span class="marimo-badge">注意</span>';
      } else {
        marimoCharacter.classList.add('growth-large', 'state-ugly');
        marimoStatusText.textContent = `大きく超過しています（目標比 ${formatRatioPercent(ratio)}%）。マリもが醜悪化しています。`;
        marimoBadges.innerHTML = '<span class="marimo-badge">超過警告</span><span class="marimo-badge">要節約</span>';
      }

      goalHintText.textContent = `目標 ${goalAmount.toLocaleString()}円 / 実績 ${Math.round(totalAmount).toLocaleString()}円（${periodText}）`;
    }

    function loadDashboard() {
      try {
        const receipts = storage.getAll();
        const period = goalSettings.period === 'month' ? 'month' : 'week';
        const { filtered, range } = getReceiptsForPeriod(receipts, period);

        // 合計金額と件数を計算
        let totalAmount = 0;
        const categoryTotals = {};

        filtered.forEach(receipt => {
          const amount = parseFloat(receipt.total) || 0;
          totalAmount += amount;

          // カテゴリ別に集計
          const category = getReceiptCategoryId(receipt);
          if (!categoryTotals[category]) {
            categoryTotals[category] = 0;
          }
          categoryTotals[category] += amount;
        });

        // 表示を更新
        dashboardTotal.textContent = `¥${totalAmount.toLocaleString()}`;
        dashboardCount.textContent = filtered.length;
        dashboardPeriodTitle.textContent = range.title;
        dashboardPeriodLabel.textContent = `集計期間: ${range.label}`;
        categoryBreakdownTitle.textContent = `カテゴリ別集計（${range.label}）`;
        if (goalPeriodSelect && goalPeriodSelect.value !== period) {
          goalPeriodSelect.value = period;
        }

        // カテゴリ別集計を表示
        renderCategoryBreakdown(categoryTotals);
        renderMarimoStatus(totalAmount, goalSettings.amount, period);

      } catch (error) {
        console.error('ダッシュボード読み込みエラー:', error);
        showEmptyState(categoryBreakdownList, 'データの読み込みに失敗しました');
      }
    }

    function renderCategoryBreakdown(categoryTotals) {
      if (Object.keys(categoryTotals).length === 0) {
        showEmptyState(categoryBreakdownList, 'まだレシートが登録されていません');
        return;
      }

      // カテゴリを金額の大きい順にソート
      const sortedCategories = Object.entries(categoryTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([id, amount]) => ({ id, amount }));

      const html = sortedCategories.map(({ id, amount }) => {
        const category = categories.find(c => c.id === id) || categories.find(c => c.id === 'other');
        return `
          <div class="category-item">
            <div class="category-item-left">
              <span class="category-icon">${category.icon}</span>
              <span class="category-name">${category.name}</span>
            </div>
            <span class="category-amount">¥${amount.toLocaleString()}</span>
          </div>
        `;
      }).join('');

      categoryBreakdownList.innerHTML = html;
    }

    // ========== 履歴表示 ==========
    function getReceiptStoreName(receipt) {
      return receipt?.storeName || receipt?.store || '店舗名不明';
    }

    function getReceiptCategoryId(receipt) {
      return receipt?.categoryId || receipt?.category || 'other';
    }

    function parseReceiptDateToTime(dateValue) {
      if (!dateValue) return null;
      const parsed = new Date(dateValue);
      if (!Number.isNaN(parsed.getTime())) {
        return parsed;
      }

      const normalized = toInputDateValue(dateValue);
      const normalizedDate = new Date(normalized);
      if (!Number.isNaN(normalizedDate.getTime())) {
        return normalizedDate;
      }

      return null;
    }

    function loadHistory() {
      try {
        const receipts = storage.getAll();

        // 日付降順でソート
        const sortedReceipts = [...receipts].sort((a, b) => {
          const bTime = parseReceiptDateToTime(b.date)?.getTime() || 0;
          const aTime = parseReceiptDateToTime(a.date)?.getTime() || 0;
          return bTime - aTime;
        });

        historyCount.textContent = sortedReceipts.length;

        if (sortedReceipts.length === 0) {
          showEmptyState(historyList, 'まだレシートが登録されていません');
          return;
        }

        // レシートカードを生成
        const html = sortedReceipts.map(receipt => {
          const categoryId = getReceiptCategoryId(receipt);
          const category = categories.find(c => c.id === categoryId) || categories.find(c => c.id === 'other');
          const date = parseReceiptDateToTime(receipt.date);
          const formattedDate = date
            ? `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`
            : '日付不明';

          return `
            <div class="history-card" data-receipt-id="${receipt.id || ''}">
              <div class="history-card-header">
                <div class="history-store">${escapeHtml(getReceiptStoreName(receipt))}</div>
                <div class="history-amount">¥${parseFloat(receipt.total || 0).toLocaleString()}</div>
              </div>
              <div class="history-card-footer">
                <div class="history-date">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  ${formattedDate}
                </div>
                <div class="history-category">
                  <span>${category.icon}</span>
                  <span>${category.name}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

        historyList.innerHTML = html;

      } catch (error) {
        console.error('履歴読み込みエラー:', error);
        showEmptyState(historyList, 'データの読み込みに失敗しました');
      }
    }

    // 空の状態を表示
    function showEmptyState(container, message) {
      container.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M9 9h6M9 15h6" stroke-linecap="round"/>
          </svg>
          <p>${message}</p>
        </div>
      `;
    }

    // ========== カレンダー表示 ==========
    function loadCalendar() {
      try {
        // 年月を表示
        calendarMonth.textContent = `${currentCalendarYear}年${currentCalendarMonth}月`;

        // カレンダーグリッドを生成
        renderCalendarGrid();
      } catch (error) {
        console.error('カレンダー読み込みエラー:', error);
      }
    }

    function renderCalendarGrid() {
      // 月の最初の日と最後の日を取得
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth - 1, 1);
      const lastDay = new Date(currentCalendarYear, currentCalendarMonth, 0);

      // 月の最初の曜日（0=日曜, 1=月曜, ...）
      const firstDayOfWeek = firstDay.getDay();

      // 月の日数
      const daysInMonth = lastDay.getDate();

      // 前月の日数
      const prevMonthLastDay = new Date(currentCalendarYear, currentCalendarMonth - 1, 0);
      const prevMonthDays = prevMonthLastDay.getDate();

      // すべてのレシートを取得して日付ごとに集計
      const receipts = storage.getAll();
      const receiptsByDate = {};

      receipts.forEach(receipt => {
        const date = new Date(receipt.date);
        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        if (!receiptsByDate[dateKey]) {
          receiptsByDate[dateKey] = {
            count: 0,
            total: 0,
            receipts: []
          };
        }

        receiptsByDate[dateKey].count++;
        receiptsByDate[dateKey].total += parseFloat(receipt.total || 0);
        receiptsByDate[dateKey].receipts.push(receipt);
      });

      // カレンダーグリッドHTML生成
      let html = '';

      // 前月の日付を追加（グレーアウト）
      for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthDays - i;
        html += `
          <div class="calendar-day other-month">
            <div class="calendar-day-number">${day}</div>
          </div>
        `;
      }

      // 今日の日付
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === currentCalendarYear && (today.getMonth() + 1) === currentCalendarMonth;
      const todayDate = today.getDate();

      // 当月の日付を追加
      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${currentCalendarYear}-${String(currentCalendarMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = receiptsByDate[dateKey];
        const hasReceipts = dayData && dayData.count > 0;
        const isToday = isCurrentMonth && day === todayDate;

        let classes = ['calendar-day'];
        if (isToday) classes.push('today');
        if (hasReceipts) classes.push('has-receipts');

        html += `
          <div class="${classes.join(' ')}" data-date="${dateKey}">
            <div class="calendar-day-number">${day}</div>
            ${hasReceipts ? `
              <div class="calendar-day-info">
                <span class="calendar-day-count">${dayData.count}件</span>
                <span class="calendar-day-total">¥${Math.round(dayData.total).toLocaleString()}</span>
              </div>
            ` : ''}
          </div>
        `;
      }

      // 次月の日付を追加（グレーアウト）
      const totalCells = firstDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);

      for (let day = 1; day <= remainingCells; day++) {
        html += `
          <div class="calendar-day other-month">
            <div class="calendar-day-number">${day}</div>
          </div>
        `;
      }

      calendarGrid.innerHTML = html;

      // 日付セルにクリックイベントを追加
      document.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayCell => {
        dayCell.addEventListener('click', function() {
          const dateKey = this.dataset.date;
          if (dateKey) {
            showDateDetail(dateKey);
          }
        });
      });
    }

    // 日付詳細を表示
    function showDateDetail(dateKey) {
      const receipts = storage.getAll();
      const dayReceipts = receipts.filter(receipt => {
        const date = parseReceiptDateToTime(receipt.date);
        if (!date) return false;
        const receiptDateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        return receiptDateKey === dateKey;
      });

      if (dayReceipts.length === 0) {
        return; // レシートがない日付はクリックしても何も起こらない
      }

      // 日付をフォーマット
      const [year, month, day] = dateKey.split('-');
      calendarDetailDate.textContent = `${year}年${parseInt(month)}月${parseInt(day)}日`;

      // 合計と件数を計算
      const total = dayReceipts.reduce((sum, r) => sum + (parseFloat(r.total) || 0), 0);
      calendarDetailTotal.textContent = `¥${Math.round(total).toLocaleString()}`;
      calendarDetailCount.textContent = `${dayReceipts.length}件`;

      // レシートリストを生成
      const html = dayReceipts.map(receipt => {
        const categoryId = getReceiptCategoryId(receipt);
        const category = categories.find(c => c.id === categoryId) || categories.find(c => c.id === 'other');
        const parsed = parseReceiptDateToTime(receipt.date);
        const time = parsed ? parsed.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '--:--';

        return `
          <div class="calendar-detail-item">
            <div class="calendar-detail-item-header">
              <div class="calendar-detail-store">${escapeHtml(getReceiptStoreName(receipt))}</div>
              <div class="calendar-detail-amount">¥${Math.round(parseFloat(receipt.total) || 0).toLocaleString()}</div>
            </div>
            <div class="calendar-detail-meta">
              <div class="calendar-detail-time">${time}</div>
              <div class="calendar-detail-category">
                <span>${category.icon}</span>
                <span>${category.name}</span>
              </div>
            </div>
            <button class="calendar-detail-open" data-receipt-id="${receipt.id || ''}">詳細を表示・編集</button>
          </div>
        `;
      }).join('');

      calendarDetailList.innerHTML = html;

      // モーダルを表示
      calendarDetailModal.classList.add('active');
    }

    // 前月へ
    function prevMonth() {
      currentCalendarMonth--;
      if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
      }
      loadCalendar();
    }

    // 次月へ
    function nextMonth() {
      currentCalendarMonth++;
      if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
      }
      loadCalendar();
    }

    // カレンダー詳細モーダルを閉じる
    function closeCalendarDetail() {
      calendarDetailModal.classList.remove('active');
    }

    function openReceiptEditor(receiptId) {
      const receipt = storage.getById(receiptId);
      if (!receipt) {
        alert('対象のレシートが見つかりませんでした');
        return;
      }

      editingReceiptId = receiptId;
      editStoreNameInput.value = getReceiptStoreName(receipt);
      editReceiptDateInput.value = toInputDateValue(receipt.date);
      editTotalAmountInput.value = toNumberInputValue(receipt.total);
      editCategorySelect.value = getReceiptCategoryId(receipt);

      receiptEditModal.classList.add('active');
    }

    function closeReceiptEditor() {
      receiptEditModal.classList.remove('active');
      editingReceiptId = null;
    }

    function saveReceiptEdit() {
      if (!editingReceiptId) return;

      const storeName = editStoreNameInput.value.trim();
      const date = editReceiptDateInput.value;
      const total = parseFloat(editTotalAmountInput.value) || 0;
      const categoryId = editCategorySelect.value || 'other';

      if (!storeName) {
        alert('店舗名を入力してください');
        editStoreNameInput.focus();
        return;
      }

      if (!date) {
        alert('日付を入力してください');
        editReceiptDateInput.focus();
        return;
      }

      const updated = storage.update(editingReceiptId, {
        storeName,
        store: storeName,
        date,
        total,
        categoryId,
        category: categoryId
      });

      if (!updated) {
        alert('レシートの更新に失敗しました');
        return;
      }

      closeReceiptEditor();
      loadHistory();
      loadDashboard();
      loadCalendar();
    }

    // ========== モード切り替え ==========
    function switchToMode(mode) {
      currentMode = mode;

      if (mode === 'camera') {
        cameraModeTab.classList.add('active');
        galleryModeTab.classList.remove('active');
        actionButtons.classList.add('hidden');
        captureModeSection.classList.add('visible');
        scanArea.classList.add('camera-active');

        // ギャラリープレビューを非表示
        scanPreview.classList.remove('visible');

        // カメラを開始
        startCamera();
      } else {
        cameraModeTab.classList.remove('active');
        galleryModeTab.classList.add('active');
        actionButtons.classList.remove('hidden');
        captureModeSection.classList.remove('visible');
        if (isContinuousRunning) {
          stopContinuousCapture();
        }
        scanArea.classList.remove('camera-active');

        // カメラを停止
        stopCamera();

        // カメラ関連UIを非表示
        cameraVideo.classList.remove('visible');
        capturePreview.classList.remove('visible');
        cameraSwitchBtn.classList.remove('visible');
        retakeBtn.classList.remove('visible');
        cameraError.classList.remove('visible');

        // キャプチャした画像があれば表示
        if (capturedImageData) {
          scanPreview.src = capturedImageData;
          scanPreview.classList.add('visible');
          scanContent.style.opacity = '0';
        } else if (!hasImage) {
          scanContent.style.opacity = '1';
        }
      }
    }

    // ========== カメラ機能 ==========
    async function startCamera() {
      if (!isCameraSupported()) {
        showCameraError('カメラがサポートされていません', 'お使いのブラウザはカメラ機能をサポートしていません。ギャラリーから画像を選択してください。');
        return;
      }

      // 既存のストリームを停止
      stopCamera();

      // キャプチャプレビューがある場合は表示しない
      if (capturedImageData) {
        capturePreview.src = capturedImageData;
        capturePreview.classList.add('visible');
        retakeBtn.classList.add('visible');
        return;
      }

      try {
        const constraints = {
          video: {
            facingMode: currentFacingMode,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraVideo.srcObject = currentStream;

        // ビデオ再生開始を待つ
        await new Promise((resolve, reject) => {
          let settled = false;
          let timeoutId = null;

          const finalizeResolve = () => {
            if (settled) return;
            settled = true;
            if (timeoutId) clearTimeout(timeoutId);
            resolve();
          };

          const finalizeReject = (err) => {
            if (settled) return;
            settled = true;
            if (timeoutId) clearTimeout(timeoutId);
            reject(err);
          };

          cameraVideo.onloadedmetadata = () => {
            cameraVideo.play()
              .then(() => {
                isStreaming = true;
                finalizeResolve();
              })
              .catch((playError) => {
                console.error('ビデオ再生エラー:', playError);
                // play()失敗時はユーザーフレンドリーなエラーを表示
                showCameraError(
                  'カメラ映像を表示できません',
                  '映像の再生に失敗しました。再試行するか、ギャラリーから画像を選択してください。'
                );
                finalizeReject(playError);
              });
          };

          // メタデータ読み込みタイムアウト（5秒）
          timeoutId = setTimeout(() => {
            if (!settled) {
              showCameraError(
                'カメラの読み込みがタイムアウトしました',
                'カメラの応答がありません。再試行するか、ギャラリーから画像を選択してください。'
              );
              finalizeReject(new Error('Camera metadata load timeout'));
            }
          }, 5000);
        });

        // UI更新
        cameraVideo.classList.add('visible');
        scanContent.style.opacity = '0';
        cameraError.classList.remove('visible');

        // カメラが複数ある場合は切り替えボタンを表示
        if (availableCameras.length > 1) {
          cameraSwitchBtn.classList.add('visible');
        }

        // カメラ情報を再取得（初回は権限がないと空になるため）
        if (availableCameras.length === 0) {
          await checkCameraAvailability();
          if (availableCameras.length > 1) {
            cameraSwitchBtn.classList.add('visible');
          }
        }

      } catch (error) {
        console.error('カメラ起動エラー:', error);
        handleCameraError(error);
      }
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      cameraVideo.srcObject = null;
      isStreaming = false;
    }

    // カメラエラーハンドリング
    function handleCameraError(error) {
      let title = 'カメラにアクセスできません';
      let message = 'カメラへのアクセスに問題が発生しました。';

      switch (error.name) {
        case 'NotAllowedError':
        case 'PermissionDeniedError':
          title = 'カメラへのアクセスが拒否されました';
          message = 'カメラを使用するには、ブラウザの設定からカメラへのアクセスを許可してください。';
          break;
        case 'NotFoundError':
        case 'DevicesNotFoundError':
          title = 'カメラが見つかりません';
          message = 'お使いのデバイスにカメラが接続されていないか、使用できません。';
          break;
        case 'NotReadableError':
        case 'TrackStartError':
          title = 'カメラにアクセスできません';
          message = 'カメラが他のアプリケーションで使用されている可能性があります。';
          break;
        case 'OverconstrainedError':
          title = 'カメラの設定エラー';
          message = '指定されたカメラ設定がサポートされていません。';
          break;
        case 'SecurityError':
          title = 'セキュリティエラー';
          message = 'HTTPS接続が必要です。安全な接続でアクセスしてください。';
          break;
      }

      showCameraError(title, message);
    }

    function showCameraError(title, message) {
      cameraErrorTitle.textContent = title;
      cameraErrorMessage.textContent = message;
      cameraError.classList.add('visible');
      cameraVideo.classList.remove('visible');
      cameraSwitchBtn.classList.remove('visible');
    }

    // カメラ切り替え
    async function switchCamera() {
      currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';

      // 切り替えアニメーション
      cameraSwitchBtn.style.transform = 'rotate(180deg)';
      setTimeout(() => {
        cameraSwitchBtn.style.transform = '';
      }, 300);

      await startCamera();
    }

    // 撮影
    function capturePhoto() {
      if (!isStreaming) return;

      // まとめ撮りモードの場合
      if (isContinuousMode) {
        // 録画中の場合は停止
        if (isContinuousRunning) {
          stopContinuousCapture();
        } else {
          // 録画開始
          startContinuousCapture();
        }
        return;
      }

      // 1枚撮影モードの場合
      // シャッターエフェクト
      shutterEffect.classList.add('flash');
      setTimeout(() => shutterEffect.classList.remove('flash'), 200);

      // キャンバスに描画
      const ctx = captureCanvas.getContext('2d');
      captureCanvas.width = cameraVideo.videoWidth;
      captureCanvas.height = cameraVideo.videoHeight;
      ctx.drawImage(cameraVideo, 0, 0);

      // 画像データを取得
      capturedImageData = captureCanvas.toDataURL('image/jpeg', 0.9);

      // カメラを停止
      stopCamera();

      // プレビューを表示
      capturePreview.src = capturedImageData;
      capturePreview.classList.add('visible');
      cameraVideo.classList.remove('visible');
      cameraSwitchBtn.classList.remove('visible');
      retakeBtn.classList.add('visible');

      // 解析ボタンを有効化
      hasImage = true;
      analyzeBtn.disabled = false;

      // 結果をリセット
      resultSection.classList.remove('visible');
      resultCard.classList.remove('animate');

      // 単独撮影モードの場合、自動で解析を開始
      if (!isContinuousMode) {
        analyzeReceipt();
      }
    }

    // 撮り直し
    function retakePhoto() {
      capturedImageData = null;
      hasImage = false;
      analyzeBtn.disabled = true;

      // プレビューを非表示
      capturePreview.classList.remove('visible');
      retakeBtn.classList.remove('visible');

      // カメラを再開
      startCamera();
    }

    // ========== 撮影モード選択 ==========
    function selectCaptureMode(mode) {
      // 録画中はモード切り替え不可
      if (isContinuousRunning) return;

      if (mode === 'single') {
        // 1枚撮影モードに切り替え
        isContinuousMode = false;
        singleModeBtn.classList.add('active');
        continuousModeBtn.classList.remove('active');
        stopContinuousCapture();
      } else if (mode === 'continuous') {
        // まとめ撮りモードに切り替え
        isContinuousMode = true;
        singleModeBtn.classList.remove('active');
        continuousModeBtn.classList.add('active');
        // 撮影ボタンを押すまで録画は開始しない
      }
    }

    function startContinuousCapture() {
      if (!isCameraSupported()) return;

      // 状態リセット
      receiptResults = [];
      isAnalyzing = false;
      lastReceiptDetectionTime = 0;
      updateContinuousCount();
      isContinuousRunning = true;

      // UIを録画中に変更
      shutterBtn.classList.add('recording');
      continuousModeText.textContent = '撮影中';

      // カメラが止まっていたら再開
      if (!isStreaming && !capturedImageData) {
        startCamera();
      }

      // 500msごとにフレームをチェック（レシート検出）
      if (continuousIntervalId) {
        clearInterval(continuousIntervalId);
      }

      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      // レシート検出用の解像度
      const TARGET_WIDTH = 640;
      const TARGET_HEIGHT = 480;

      continuousIntervalId = setInterval(async () => {
        if (!isStreaming || cameraVideo.videoWidth === 0) return;
        if (isAnalyzing) return; // 解析中は次の判定をスキップ

        // 最後の検出から3秒以内はスキップ（同じレシートを複数回解析しない）
        const now = Date.now();
        if (now - lastReceiptDetectionTime < 3000) {
          return;
        }

        // フレームをキャプチャ
        tempCanvas.width = TARGET_WIDTH;
        tempCanvas.height = TARGET_HEIGHT;
        tempCtx.drawImage(cameraVideo, 0, 0, TARGET_WIDTH, TARGET_HEIGHT);

        const imageData = tempCtx.getImageData(0, 0, TARGET_WIDTH, TARGET_HEIGHT);
        const current = {
          data: imageData.data,
          w: TARGET_WIDTH,
          h: TARGET_HEIGHT,
        };

        // レシート判定
        const isReceipt = detectReceipt(current);

        if (isReceipt) {
          console.log('レシートを検出！自動解析を開始します');
          lastReceiptDetectionTime = now;
          isAnalyzing = true;

          // 高品質な画像を取得（解析用）
          const fullCanvas = document.createElement('canvas');
          const fullCtx = fullCanvas.getContext('2d');
          fullCanvas.width = cameraVideo.videoWidth;
          fullCanvas.height = cameraVideo.videoHeight;
          fullCtx.drawImage(cameraVideo, 0, 0);
          const fullDataUrl = fullCanvas.toDataURL('image/jpeg', 0.9);

          // シャッターエフェクト
          shutterEffect.classList.add('flash');
          setTimeout(() => shutterEffect.classList.remove('flash'), 200);

          // 自動解析を実行
          try {
            await autoAnalyzeReceipt(fullDataUrl);
          } catch (error) {
            console.error('自動解析エラー:', error);
          } finally {
            isAnalyzing = false;
          }
        }
      }, 500); // 500msごとにチェック
    }

    function stopContinuousCapture() {
      isContinuousRunning = false;
      isAnalyzing = false;

      if (continuousIntervalId) {
        clearInterval(continuousIntervalId);
        continuousIntervalId = null;
      }

      // UIを元に戻す
      shutterBtn.classList.remove('recording');
      continuousModeText.textContent = 'まとめ撮り';

      console.log(`まとめ撮り停止。解析済みレシート数: ${receiptResults.length}`);

      // 解析済みレシートがある場合、バッチ結果UIを表示
      if (receiptResults.length > 0) {
        console.log(`${receiptResults.length}件のレシートを解析しました`);
        displayBatchResults(receiptResults);
      } else {
        console.log('レシートが検出されませんでした');
      }
    }

    // バッチ結果を表示
    function displayBatchResults(results) {
      // カウント表示
      batchCount.textContent = results.length;

      // グリッドをクリア
      batchResultsGrid.innerHTML = '';

      // 各レシートのカードを生成
      results.forEach((result, index) => {
        const card = createBatchReceiptCard(result, index);
        batchResultsGrid.appendChild(card);
      });

      // バッチ結果セクションを表示
      resultSection.classList.remove('visible');
      batchResultsSection.classList.add('visible');

      // スクロール
      setTimeout(() => {
        batchResultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }

    function toInputDateValue(rawDate) {
      const today = new Date().toISOString().split('T')[0];
      if (!rawDate) return today;

      const value = String(rawDate).trim();
      if (!value) return today;

      if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
        return value;
      }

      const ymdMatch = value.match(/(\d{4})\s*[年\/.\-]\s*(\d{1,2})\s*[月\/.\-]\s*(\d{1,2})/);
      if (ymdMatch) {
        const y = ymdMatch[1];
        const m = String(parseInt(ymdMatch[2], 10)).padStart(2, '0');
        const d = String(parseInt(ymdMatch[3], 10)).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      const mdMatch = value.match(/(\d{1,2})\s*[月\/.\-]\s*(\d{1,2})/);
      if (mdMatch) {
        const y = new Date().getFullYear();
        const m = String(parseInt(mdMatch[1], 10)).padStart(2, '0');
        const d = String(parseInt(mdMatch[2], 10)).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      const parsed = new Date(value.replace(/年/g, '/').replace(/月/g, '/').replace(/日/g, ''));
      if (!Number.isNaN(parsed.getTime())) {
        const y = parsed.getFullYear();
        const m = String(parsed.getMonth() + 1).padStart(2, '0');
        const d = String(parsed.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      return today;
    }

    function toNumberInputValue(rawAmount) {
      if (rawAmount === null || rawAmount === undefined) return '';

      const cleaned = String(rawAmount).replace(/[^0-9.-]/g, '');
      if (!cleaned || cleaned === '-' || cleaned === '.') return '';

      const numeric = Number(cleaned);
      if (!Number.isFinite(numeric)) return '';

      return String(Math.round(numeric));
    }

    // バッチレシートカードを生成
    function createBatchReceiptCard(result, index) {
      const card = document.createElement('div');
      card.className = 'batch-receipt-card';
      card.dataset.index = index;

      const data = result.data;
      const storeName = data.storeName || '';
      const date = toInputDateValue(data.date);
      const total = toNumberInputValue(data.total);

      card.innerHTML = `
        <img src="${result.imageDataUrl}" alt="レシート画像" class="batch-receipt-thumbnail">
        <div class="batch-receipt-edit">
          <div class="batch-edit-field">
            <label>店舗名</label>
            <input type="text" class="batch-store-input" data-index="${index}" value="${escapeHtml(storeName)}" placeholder="店舗名">
          </div>
          <div class="batch-edit-field">
            <label>日付</label>
            <input type="date" class="batch-date-input" data-index="${index}" value="${date}">
          </div>
          <div class="batch-edit-field">
            <label>金額</label>
            <input type="number" class="batch-amount-input" data-index="${index}" value="${total}" placeholder="金額">
          </div>
          <div class="batch-edit-field">
            <label>カテゴリ</label>
            <select class="batch-category-select" data-index="${index}">
              <option value="">カテゴリを選択</option>
              ${categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('')}
            </select>
          </div>
        </div>
        <button class="batch-save-btn" data-index="${index}">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          登録
        </button>
      `;

      return card;
    }

    // バッチカード内のクリックイベント処理
    function handleBatchCardClick(e) {
      const saveBtn = e.target.closest('.batch-save-btn');
      if (saveBtn) {
        const index = parseInt(saveBtn.dataset.index);
        saveSingleReceipt(index);
      }
    }

    // 単一レシートを保存
    async function saveSingleReceipt(index) {
      const result = receiptResults[index];
      if (!result) return;

      // 編集された値を取得
      const storeInput = batchResultsGrid.querySelector(`.batch-store-input[data-index="${index}"]`);
      const dateInput = batchResultsGrid.querySelector(`.batch-date-input[data-index="${index}"]`);
      const amountInput = batchResultsGrid.querySelector(`.batch-amount-input[data-index="${index}"]`);
      const selectElement = batchResultsGrid.querySelector(`.batch-category-select[data-index="${index}"]`);

      const storeName = storeInput ? storeInput.value.trim() : '';
      const date = dateInput ? dateInput.value : '';
      const total = amountInput ? parseFloat(amountInput.value) || 0 : 0;
      const categoryId = selectElement ? selectElement.value : '';

      // バリデーション
      if (!storeName) {
        alert('店舗名を入力してください');
        storeInput.focus();
        return;
      }

      if (!categoryId) {
        alert('カテゴリを選択してください');
        return;
      }

      const saveBtn = batchResultsGrid.querySelector(`.batch-save-btn[data-index="${index}"]`);
      saveBtn.disabled = true;
      saveBtn.innerHTML = '登録中...';

      try {
        // レシートデータを構築
        const receiptData = {
          imageDataUrl: result.imageDataUrl,
          storeName: storeName,
          date: date || new Date().toISOString().split('T')[0],
          total: total,
          items: result.data.items || [],
          categoryId: categoryId,
          timestamp: result.timestamp || Date.now(),
          createdAt: new Date().toISOString()
        };

        // LocalStorageに保存
        const savedId = storage.save(receiptData);
        console.log('レシートを保存しました:', savedId);

        // ボタンの表示を変更
        saveBtn.innerHTML = '登録済み';
        saveBtn.classList.add('saved');

        // ダッシュボードと履歴を更新
        if (currentScreen === 'dashboard') {
          loadDashboard();
        } else if (currentScreen === 'history') {
          loadHistory();
        }

      } catch (error) {
        console.error('保存エラー:', error);
        alert('保存に失敗しました: ' + error.message);
        saveBtn.disabled = false;
        saveBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          登録
        `;
      }
    }

    // すべてのレシートを保存
    async function saveAllReceipts() {
      const selects = batchResultsGrid.querySelectorAll('.batch-category-select');
      let hasEmptyCategory = false;

      // すべてカテゴリが選択されているかチェック
      selects.forEach(select => {
        if (!select.value) {
          hasEmptyCategory = true;
        }
      });

      if (hasEmptyCategory) {
        alert('すべてのレシートのカテゴリを選択してください');
        return;
      }

      saveAllBtn.disabled = true;
      saveAllBtn.textContent = '保存中...';

      try {
        // すべてのレシートを順番に保存
        for (let i = 0; i < receiptResults.length; i++) {
          const saveBtn = batchResultsGrid.querySelector(`.batch-save-btn[data-index="${i}"]`);
          if (!saveBtn.classList.contains('saved')) {
            await saveSingleReceipt(i);
          }
        }

        alert(`${receiptResults.length}件のレシートを保存しました`);
        closeBatchResults();

        // ダッシュボードと履歴を更新
        if (currentScreen === 'dashboard') {
          loadDashboard();
        } else if (currentScreen === 'history') {
          loadHistory();
        }

      } catch (error) {
        console.error('一括保存エラー:', error);
        alert('一括保存に失敗しました');
        saveAllBtn.disabled = false;
        saveAllBtn.textContent = 'すべて保存';
      }
    }

    // バッチ結果を閉じる
    function closeBatchResults() {
      batchResultsSection.classList.remove('visible');
      receiptResults = [];
      updateContinuousCount();
      console.log('バッチ結果を閉じました');
    }

    // 自動解析関数（レシート検出時に呼ばれる）
    async function autoAnalyzeReceipt(imageDataUrl) {
      try {
        console.log('自動解析開始...', new Date().toISOString());

        // OCR解析を実行（サーバー経由）
        const data = await callOpenAiReceiptOcr(imageDataUrl, (msg) => {
          console.log('解析進捗:', msg);
        });

        console.log('OCR解析完了:', data);

        // 解析結果を保存
        receiptResults.push({
          imageDataUrl,
          data,
          timestamp: Date.now()
        });

        console.log(`解析結果を保存しました。現在の解析済み数: ${receiptResults.length}`);

        // カウンターを更新
        updateContinuousCount();

        // 結果を表示
        displayResults(data);

        console.log(`解析完了！現在の解析済み数: ${receiptResults.length}`);
      } catch (error) {
        console.error('自動解析でエラーが発生:', error);
        // エラーが発生してもまとめ撮りは継続
      }
    }

    function computeFrameDifference(prev, current) {
      // 簡易的に、数十ピクセルだけサンプリングして差分率を出す
      const step = 24; // サンプリング間隔
      let total = 0;
      let diffSum = 0;

      for (let y = 0; y < current.h; y += step) {
        for (let x = 0; x < current.w; x += step) {
          const idx = (y * current.w + x) * 4;
          const r1 = prev.data[idx];
          const g1 = prev.data[idx + 1];
          const b1 = prev.data[idx + 2];

          const r2 = current.data[idx];
          const g2 = current.data[idx + 1];
          const b2 = current.data[idx + 2];

          const l1 = 0.299 * r1 + 0.587 * g1 + 0.114 * b1;
          const l2 = 0.299 * r2 + 0.587 * g2 + 0.114 * b2;

          const diff = Math.abs(l1 - l2) / 255;
          diffSum += diff;
          total++;
        }
      }

      if (!total) return 0;
      return diffSum / total;
    }

    // シャープネス（鮮明度）スコアを計算
    // Laplacian variance を簡易計算（エッジ強度の分散が高いほど鮮明）
    function computeSharpnessScore(imageData) {
      const data = imageData.data;
      const w = imageData.w;
      const h = imageData.h;
      const step = 4; // サンプリング間隔（計算負荷軽減のため）

      let laplacianSum = 0;
      let laplacianSqSum = 0;
      let count = 0;

      // グレースケール変換しながらLaplacianカーネル適用
      for (let y = step; y < h - step; y += step) {
        for (let x = step; x < w - step; x += step) {
          // 中心ピクセルと周囲のグレースケール値を取得
          const getGray = (px, py) => {
            const idx = (py * w + px) * 4;
            return 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
          };

          const center = getGray(x, y);
          const top = getGray(x, y - 1);
          const bottom = getGray(x, y + 1);
          const left = getGray(x - 1, y);
          const right = getGray(x + 1, y);

          // Laplacianフィルタ: 中心*4 - 上下左右の合計
          const laplacian = Math.abs(4 * center - top - bottom - left - right);

          laplacianSum += laplacian;
          laplacianSqSum += laplacian * laplacian;
          count++;
        }
      }

      if (count === 0) return 0;

      // 分散を計算（高いほど鮮明）
      const mean = laplacianSum / count;
      const variance = (laplacianSqSum / count) - (mean * mean);

      return variance;
    }

    function updateContinuousCount() {
      const count = receiptResults.length;
      frameCount.textContent = count;
    }

    // レシート判定関数（シンプルな画像解析）
    function detectReceipt(imageData) {
      const data = imageData.data;
      const w = imageData.w;
      const h = imageData.h;

      // 1. 明るさとコントラストのチェック
      let brightnessSum = 0;
      let pixelCount = 0;
      const step = 8; // サンプリング間隔

      for (let y = 0; y < h; y += step) {
        for (let x = 0; x < w; x += step) {
          const idx = (y * w + x) * 4;
          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];
          const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
          brightnessSum += brightness;
          pixelCount++;
        }
      }

      const avgBrightness = brightnessSum / pixelCount;

      // レシートは白い背景が多いので、平均明るさが一定以上（しきい値を緩和）
      if (avgBrightness < 80) {
        console.log('レシート判定失敗: 明るさ不足', avgBrightness.toFixed(1));
        return false; // 暗すぎる
      }

      // 2. エッジ密度のチェック（テキストが多いか）
      let edgeCount = 0;
      const edgeStep = 8;
      const edgeThreshold = 25; // エッジと判定する閾値（緩和）

      for (let y = edgeStep; y < h - edgeStep; y += edgeStep) {
        for (let x = edgeStep; x < w - edgeStep; x += edgeStep) {
          const idx = (y * w + x) * 4;

          // 中心ピクセルの明度
          const centerGray = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];

          // 周囲ピクセルとの差分（簡易Sobelフィルタ）
          const rightIdx = (y * w + (x + edgeStep)) * 4;
          const bottomIdx = ((y + edgeStep) * w + x) * 4;

          const rightGray = 0.299 * data[rightIdx] + 0.587 * data[rightIdx + 1] + 0.114 * data[rightIdx + 2];
          const bottomGray = 0.299 * data[bottomIdx] + 0.587 * data[bottomIdx + 1] + 0.114 * data[bottomIdx + 2];

          const gx = Math.abs(rightGray - centerGray);
          const gy = Math.abs(bottomGray - centerGray);
          const gradient = Math.sqrt(gx * gx + gy * gy);

          if (gradient > edgeThreshold) {
            edgeCount++;
          }
        }
      }

      const totalSamplePixels = ((h - 2 * edgeStep) / edgeStep) * ((w - 2 * edgeStep) / edgeStep);
      const edgeDensity = edgeCount / totalSamplePixels;

      // エッジ密度が一定以上（テキストが多い）（しきい値を緩和）
      if (edgeDensity < 0.05) {
        console.log('レシート判定失敗: エッジ密度不足', edgeDensity.toFixed(3));
        return false; // エッジが少なすぎる
      }

      // 3. 中央部分にコンテンツがあるかチェック
      const centerX = Math.floor(w / 2);
      const centerY = Math.floor(h / 2);
      const centerSize = Math.min(w, h) / 4;

      let centerEdgeCount = 0;
      let centerPixelCount = 0;

      for (let y = centerY - centerSize / 2; y < centerY + centerSize / 2; y += edgeStep) {
        for (let x = centerX - centerSize / 2; x < centerX + centerSize / 2; x += edgeStep) {
          if (y >= 0 && y < h && x >= 0 && x < w) {
            const idx = (Math.floor(y) * w + Math.floor(x)) * 4;
            const gray = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];

            // 近隣との差分チェック
            if (x + edgeStep < w && y + edgeStep < h) {
              const rightIdx = (Math.floor(y) * w + Math.floor(x + edgeStep)) * 4;
              const bottomIdx = (Math.floor(y + edgeStep) * w + Math.floor(x)) * 4;

              const rightGray = 0.299 * data[rightIdx] + 0.587 * data[rightIdx + 1] + 0.114 * data[rightIdx + 2];
              const bottomGray = 0.299 * data[bottomIdx] + 0.587 * data[bottomIdx + 1] + 0.114 * data[bottomIdx + 2];

              const gx = Math.abs(rightGray - gray);
              const gy = Math.abs(bottomGray - gray);
              const gradient = Math.sqrt(gx * gx + gy * gy);

              if (gradient > edgeThreshold) {
                centerEdgeCount++;
              }
            }
            centerPixelCount++;
          }
        }
      }

      const centerEdgeDensity = centerEdgeCount / centerPixelCount;

      // 中央にもコンテンツがある（しきい値を緩和）
      if (centerEdgeDensity < 0.03) {
        console.log('レシート判定失敗: 中央エッジ密度不足', centerEdgeDensity.toFixed(3));
        return false;
      }

      console.log('✅ レシート検出成功!', {
        avgBrightness: avgBrightness.toFixed(1),
        edgeDensity: edgeDensity.toFixed(3),
        centerEdgeDensity: centerEdgeDensity.toFixed(3)
      });

      return true; // レシートと判定
    }

    // ========== ファイル選択 ==========
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          // キャプチャデータをクリア
          capturedImageData = null;
          capturePreview.classList.remove('visible');

          // プレビューを表示
          scanPreview.src = e.target.result;
          scanPreview.classList.add('visible');
          scanContent.style.opacity = '0';
          hasImage = true;
          analyzeBtn.disabled = false;

          // ギャラリーモードに切り替え
          if (currentMode === 'camera') {
            switchToMode('gallery');
          }

          // 結果をリセット
          resultSection.classList.remove('visible');
          resultCard.classList.remove('animate');
        };
        reader.readAsDataURL(file);
      }
      // inputをリセット（同じファイルを再選択できるように）
      event.target.value = '';
    }

    // ========== OpenAI による OCR & 解析（サーバー経由） ==========
    async function callOpenAiReceiptOcr(imageSrc, onProgress) {
      if (onProgress) {
        onProgress('サーバーに送信中...');
      }

      const response = await fetch('/api/receipt-ocr', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ imageSrc })
      });

      const text = await response.text();

      if (!response.ok) {
        let errorMessage = `サーバー側でエラーが発生しました (${response.status})`;
        try {
          const errorJson = JSON.parse(text);
          if (errorJson.error) {
            errorMessage += `: ${errorJson.error}`;
          } else {
            errorMessage += `: ${text}`;
          }
        } catch {
          errorMessage += `: ${text}`;
        }
        console.error('サーバー側 OCR エラー:', { status: response.status, body: text });
        throw new Error(errorMessage);
      }

      let data;
      try {
        data = JSON.parse(text);
        console.log('サーバーからの解析結果:', data);
      } catch (e) {
        console.error('サーバー応答 JSON パースエラー:', e, text);
        throw new Error('サーバーからの応答を JSON として解釈できませんでした。');
      }

      return data;
    }

    // ========== 解析処理 ==========
    async function analyzeReceipt() {
      if (!hasImage) return;

      // まとめ撮りモードでは自動解析されるため、解析ボタンは使用しない
      if (isContinuousMode) {
        console.log('まとめ撮りモードでは自動解析されます');
        return;
      }

      // ローディング表示
      loadingOverlay.classList.add('visible');
      const loadingText = loadingOverlay.querySelector('.loading-text');

      // スキャンライン開始
      scanLine.classList.add('scanning');

      // プログレスバー・チェックリスト要素を取得
      const progressBarContainer = document.getElementById('progressBarContainer');
      const progressBar = document.getElementById('analysisProgressBar');
      const checklist = document.getElementById('analysisChecklist');

      try {
        // まとめ撮りモードでは自動解析されるため、この分岐は不要
        if (false && isContinuousMode && continuousFrames.length > 0) {
          console.log('連続スキャンモードで解析開始。フレーム数:', continuousFrames.length);

          // ベストショット選択: シャープネス（鮮明度）スコアで降順ソート
          // 最も鮮明なフレームから優先的に解析
          const sortedFrames = [...continuousFrames].sort((a, b) => {
            return (b.sharpness || 0) - (a.sharpness || 0);
          });
          console.log('シャープネスでソート済み:', sortedFrames.map(f => f.sharpness));

          const results = [];
          const frameCount = sortedFrames.length;

          // プログレスバーとチェックリストを初期化・表示
          progressBarContainer.classList.add('visible');
          progressBar.style.width = '0%';
          checklist.classList.add('visible');
          checklist.innerHTML = '';

          // チェックリスト項目を生成
          for (let j = 0; j < frameCount; j++) {
            const item = document.createElement('div');
            item.className = 'analysis-checklist-item';
            item.id = `checklist-item-${j}`;
            item.innerHTML = `
              <div class="check-icon">
                <div class="spinner"></div>
              </div>
              <span>フレーム ${j + 1}</span>
            `;
            checklist.appendChild(item);
          }

          // フレームごとに順次解析（API料金を抑えるため同時ではなく直列）
          // ソート済みフレームを使用（鮮明度の高い順）
          for (let i = 0; i < frameCount; i++) {
            const frame = sortedFrames[i];
            loadingText.textContent = `レシートを解析中... (${i + 1}/${frameCount}) [鮮明度: ${Math.round(frame.sharpness || 0)}]`;
            console.log(`フレーム${i + 1}解析開始 - 画像サイズ:`, frame.dataUrl.length, '文字, シャープネス:', frame.sharpness);

            // 現在処理中のチェックリスト項目をハイライト
            const currentItem = document.getElementById(`checklist-item-${i}`);
            if (currentItem) {
              currentItem.classList.add('processing');
            }

            const receiptData = await callOpenAiReceiptOcr(frame.dataUrl, (msg) => {
              loadingText.textContent = `${msg} (${i + 1}/${frameCount})`;
            });
            results.push(receiptData);

            // 完了したらチェックマークに変更
            if (currentItem) {
              currentItem.classList.remove('processing');
              currentItem.classList.add('completed');
              currentItem.querySelector('.check-icon').innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              `;
            }

            // プログレスバーを更新
            const progress = ((i + 1) / frameCount) * 100;
            progressBar.style.width = `${progress}%`;
          }

          console.log('連続スキャン解析完了:', results);

          // プログレスバーとチェックリストを非表示にリセット
          progressBarContainer.classList.remove('visible');
          checklist.classList.remove('visible');

          // 最後の結果を画面に表示（UIは1枚分を引き継ぎつつ、中身は配列で保持）
          const last = results[results.length - 1];
          currentReceiptData = {
            isBatch: true,
            receipts: results,
          };
          displayResults(last);

          // 連続キャプチャは一旦停止し、1枚撮影モードに戻す
          stopContinuousCapture();
          isContinuousMode = false;
          singleModeBtn.classList.add('active');
          continuousModeBtn.classList.remove('active');

          // 連続フレームはクリア（料金対策）
          continuousFrames = [];
          updateContinuousCount();
        } else {
          // 通常モード：1枚だけ解析
          // 画像を取得
          let imageSrc = capturedImageData || scanPreview.src;
          if (!imageSrc) {
            throw new Error('画像が見つかりません');
          }

          loadingText.textContent = 'OpenAIで画像を解析中...';
          console.log('解析開始 - 画像サイズ:', imageSrc.length, '文字');
          const receiptData = await callOpenAiReceiptOcr(imageSrc, (msg) => {
            loadingText.textContent = msg;
            console.log('進捗:', msg);
          });
          console.log('解析完了:', receiptData);

          currentReceiptData = receiptData;
          displayResults(receiptData);
        }

        // スキャンライン停止
        scanLine.classList.remove('scanning');

        // ローディング非表示
        loadingOverlay.classList.remove('visible');
      } catch (error) {
        console.error('解析エラー:', error);
        console.error('エラー詳細:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        scanLine.classList.remove('scanning');
        loadingOverlay.classList.remove('visible');
        
        // より詳細なエラーメッセージ
        let errorMsg = 'レシートの解析に失敗しました。\n\n';
        if (error.message.includes('API キー')) {
          errorMsg += 'APIキーが正しく設定されているか確認してください。';
        } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
          errorMsg += 'APIキーが無効です。正しいキーを設定してください。';
        } else if (error.message.includes('429') || error.message.includes('rate limit')) {
          errorMsg += 'APIの利用制限に達しました。しばらく待ってから再試行してください。';
        } else if (error.message.includes('画像')) {
          errorMsg += '画像が正しく読み込まれていません。もう一度お試しください。';
        } else {
          errorMsg += `エラー: ${error.message}`;
        }
        errorMsg += '\n\nブラウザのコンソール（F12）で詳細を確認できます。';
        
        alert(errorMsg);
      }
    }

    // ========== レシートテキスト解析 ==========
    function parseReceiptText(text) {
      const lines = text.split('\n').filter(line => line.trim().length > 0);
      
      let storeName = '店舗名不明';
      let date = new Date().toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      let total = '0';
      const items = [];

      // 店舗名の検出（最初の数行から）
      for (let i = 0; i < Math.min(5, lines.length); i++) {
        const line = lines[i].trim();
        // 店舗名らしい行（長さが適切で、金額パターンを含まない）
        if (line.length > 2 && line.length < 30 && !/\d{3,}/.test(line)) {
          // 一般的な店舗名のキーワードを除外
          if (!line.match(/^(領収|レシート|合計|小計|税|日付|時刻)/)) {
            storeName = line;
            break;
          }
        }
      }

      // 日付の検出
      const datePatterns = [
        /(\d{4})[年\/\-](\d{1,2})[月\/\-](\d{1,2})/,
        /(\d{1,2})[月\/\-](\d{1,2})[日\/\-]/,
        /(\d{4})\/(\d{2})\/(\d{2})/
      ];
      for (const line of lines) {
        for (const pattern of datePatterns) {
          const match = line.match(pattern);
          if (match) {
            try {
              const year = match[1]?.length === 4 ? match[1] : new Date().getFullYear();
              const month = match[2] || match[1];
              const day = match[3] || match[2];
              const timeMatch = line.match(/(\d{1,2}):(\d{2})/);
              const hour = timeMatch ? timeMatch[1] : new Date().getHours();
              const minute = timeMatch ? timeMatch[2] : new Date().getMinutes();
              date = `${year}年${month}月${day}日 ${hour}:${minute}`;
              break;
            } catch (e) {
              // 日付解析エラーは無視
            }
          }
        }
        if (date !== '') break;
      }

      // 金額と明細の抽出
      const pricePattern = /[¥￥]?\s*(\d{1,3}(?:[,，]\d{3})*)/g;
      const totalPatterns = [/合計[¥￥]?\s*(\d{1,3}(?:[,，]\d{3})*)/, /計[¥￥]?\s*(\d{1,3}(?:[,，]\d{3})*)/, /TOTAL[¥￥]?\s*(\d{1,3}(?:[,，]\d{3})*)/i];
      
      // 合計金額の検出
      for (const line of lines) {
        for (const pattern of totalPatterns) {
          const match = line.match(pattern);
          if (match) {
            total = match[1].replace(/[,，]/g, '');
            break;
          }
        }
        if (total !== '0') break;
      }

      // 最後の大きな金額を合計として使用（合計が見つからない場合）
      if (total === '0') {
        const allPrices = [];
        for (const line of lines) {
          const matches = [...line.matchAll(pricePattern)];
          for (const match of matches) {
            const price = parseInt(match[1].replace(/[,，]/g, ''));
            if (price > 100) allPrices.push(price);
          }
        }
        if (allPrices.length > 0) {
          total = Math.max(...allPrices).toString();
        }
      }

      // 明細の抽出（金額が含まれる行から）
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const priceMatches = [...line.matchAll(pricePattern)];
        
        if (priceMatches.length > 0) {
          // 合計や税などの行は除外
          if (line.match(/^(合計|小計|税|消費税|内税|外税|TOTAL|SUB)/)) {
            continue;
          }

          // 金額を抽出
          const prices = priceMatches.map(m => parseInt(m[1].replace(/[,，]/g, '')));
          const itemPrice = prices[prices.length - 1]; // 最後の金額を使用

          if (itemPrice > 0 && itemPrice < 1000000) { // 妥当な範囲
            // 商品名を抽出（金額の前の部分）
            const priceIndex = line.lastIndexOf(priceMatches[priceMatches.length - 1][0]);
            let itemName = line.substring(0, priceIndex).trim();
            
            // 商品名が空の場合は行全体から金額を除いた部分
            if (!itemName || itemName.length < 2) {
              itemName = line.replace(pricePattern, '').trim();
            }

            // 商品名が取得できた場合のみ追加
            if (itemName && itemName.length > 0) {
              items.push({
                name: itemName,
                price: itemPrice.toLocaleString('ja-JP')
              });
            }
          }
        }
      }

      // 明細が取得できなかった場合のフォールバック
      if (items.length === 0 && total !== '0') {
        items.push({
          name: '商品',
          price: total
        });
      }

      return {
        storeName: storeName || '店舗名不明',
        date: date,
        total: parseInt(total).toLocaleString('ja-JP'),
        items: items.slice(0, 20) // 最大20項目
      };
    }

    // 結果表示関数
    function displayResults(data) {
      // 編集可能な入力フィールドにデータをセット
      const storeNameInput = document.getElementById('storeNameInput');
      const receiptDateInput = document.getElementById('receiptDateInput');
      const totalAmountInput = document.getElementById('totalAmountInput');

      const normalizedDate = toInputDateValue(data.date);
      const normalizedTotal = toNumberInputValue(data.total);

      if (storeNameInput) storeNameInput.value = data.storeName || '';
      if (receiptDateInput) receiptDateInput.value = normalizedDate;
      if (totalAmountInput) totalAmountInput.value = normalizedTotal;

      // 現在のレシートデータを保存
      currentReceiptData = {
        storeName: data.storeName,
        date: data.date,
        total: data.total,
        items: data.items || []
      };

      // カテゴリボタンを生成
      categoryButtons.innerHTML = '';
      categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = `category-btn ${category.class}`;
        btn.textContent = `${category.icon} ${category.name}`;
        btn.dataset.categoryId = category.id;
        btn.addEventListener('click', () => selectCategory(category.id));
        categoryButtons.appendChild(btn);
      });

      // 明細をクリア
      resultItems.innerHTML = '';

      // 明細を追加
      data.items.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'result-item';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'item-name';
        nameSpan.textContent = item.name;

        // 品目ごとのカテゴリバッジ
        if (item.categoryId) {
          const cat = categories.find((c) => c.id === item.categoryId);
          const badge = document.createElement('span');
          badge.className = 'item-category';
          badge.textContent = cat ? cat.name : 'その他';
          nameSpan.appendChild(badge);
        }

        const priceSpan = document.createElement('span');
        priceSpan.className = 'item-price';
        priceSpan.textContent = `¥${item.price}`;

        li.appendChild(nameSpan);
        li.appendChild(priceSpan);

        resultItems.appendChild(li);
      });

      // セクションを表示
      resultSection.classList.add('visible');
      categorySection.style.display = 'block';

      // レシート全体のカテゴリがあれば自動選択
      if (data.categoryId) {
        selectCategory(data.categoryId);
      }

      // カードアニメーション
      requestAnimationFrame(() => {
        resultCard.classList.add('animate');

        // 明細アニメーション（順次）
        const items = resultItems.querySelectorAll('.result-item');
        items.forEach((item, index) => {
          setTimeout(() => {
            item.classList.add('animate');
          }, 600 + (index * 100));
        });
      });

      // 結果セクションにスクロール
      setTimeout(() => {
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }

    // カテゴリ選択
    function selectCategory(categoryId) {
      selectedCategory = categoryId;
      
      // ボタンの状態を更新
      categoryButtons.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.categoryId === categoryId) {
          btn.classList.add('active');
        }
      });

      // カテゴリ情報を保存（将来の履歴機能用）
      if (currentReceiptData) {
        currentReceiptData.category = categoryId;
        // ローカルストレージに保存（オプション）
        try {
          const history = JSON.parse(localStorage.getItem('receiptHistory') || '[]');
          history.push({
            ...currentReceiptData,
            timestamp: new Date().toISOString()
          });
          // 最新100件のみ保持
          localStorage.setItem('receiptHistory', JSON.stringify(history.slice(-100)));
        } catch (e) {
          console.warn('履歴の保存に失敗:', e);
        }
      }
    }

    // 1枚撮影のレシート登録
    async function registerSingleReceipt() {
      // 編集された値を取得
      const storeName = storeNameInput ? storeNameInput.value.trim() : '';
      const date = receiptDateInput ? receiptDateInput.value : '';
      const total = totalAmountInput ? parseFloat(totalAmountInput.value) || 0 : 0;
      const categoryId = selectedCategory;

      // バリデーション
      if (!storeName) {
        alert('店舗名を入力してください');
        if (storeNameInput) storeNameInput.focus();
        return;
      }

      if (!categoryId) {
        alert('カテゴリを選択してください');
        return;
      }

      // ボタンを無効化
      registerReceiptBtn.disabled = true;
      registerReceiptBtn.innerHTML = '登録中...';

      try {
        // レシートデータを構築
        const receiptData = {
          imageDataUrl: capturedImageData || '',
          storeName: storeName,
          date: date || new Date().toISOString().split('T')[0],
          total: total,
          items: currentReceiptData?.items || [],
          categoryId: categoryId,
          timestamp: Date.now(),
          createdAt: new Date().toISOString()
        };

        // LocalStorageに保存
        const savedId = storage.save(receiptData);
        console.log('レシートを保存しました:', savedId);

        // 成功メッセージを表示
        registerReceiptBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          登録完了
        `;
        registerReceiptBtn.classList.add('saved');

        // ダッシュボードと履歴を更新
        if (currentScreen === 'dashboard') {
          loadDashboard();
        } else if (currentScreen === 'history') {
          loadHistory();
        }

        // 2秒後に結果を閉じてカメラに戻る
        setTimeout(() => {
          resultSection.classList.remove('visible');
          registerReceiptBtn.disabled = false;
          registerReceiptBtn.innerHTML = `
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            登録
          `;
          registerReceiptBtn.classList.remove('saved');
          selectedCategory = null;

          // カメラを再開
          if (currentMode === 'camera') {
            retakePhoto();
          }
        }, 2000);

      } catch (error) {
        console.error('保存エラー:', error);
        alert('保存に失敗しました: ' + error.message);
        registerReceiptBtn.disabled = false;
        registerReceiptBtn.innerHTML = `
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          登録
        `;
      }
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== 初期化実行 ==========
    init();

    // ========== Service Worker 登録 ==========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
