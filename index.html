<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>È†òÂèéË™≠ - „É¨„Ç∑„Éº„ÉàË™≠„ÅøÂèñ„Çä</title>
  <meta name="description" content="Âíå„É¢„ÉÄ„É≥„Å™„É¨„Ç∑„Éº„ÉàË™≠„ÅøÂèñ„Çä„Ç¢„Éó„É™">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#c94a4a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="È†òÂèéË™≠">
  <link rel="apple-touch-icon" href="icons/icon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sumi: #2d2d2d;
      --sumi-light: #4a4a4a;
      --shu: #c94a4a;
      --shu-dark: #a33a3a;
      --shu-glow: rgba(201, 74, 74, 0.4);
      --ai: #3d5a6e;
      --ai-light: #5a7a8e;
      --kinari: #f5f1eb;
      --washi: #faf8f5;
      --kage: rgba(45, 45, 45, 0.08);
      --kage-deep: rgba(45, 45, 45, 0.15);
      /* safe-areaÁî®Â§âÊï∞ */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      background-color: var(--kinari);
      color: var(--sumi);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      position: relative;
      overflow-x: hidden;
      padding-top: var(--safe-area-top);
      padding-bottom: var(--safe-area-bottom);
      padding-left: var(--safe-area-left);
      padding-right: var(--safe-area-right);
    }

    /* ÂíåÁ¥ô„ÉÜ„ÇØ„Çπ„ÉÅ„É£ËÉåÊôØ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }

    /* Ë£ÖÈ£æÁöÑ„Å™Ê≥¢Á¥ã„Éë„Çø„Éº„É≥ */
    body::after {
      content: '';
      position: fixed;
      top: -50%;
      right: -30%;
      width: 80%;
      height: 80%;
      background: radial-gradient(ellipse, var(--shu-glow) 0%, transparent 70%);
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
    }

    .app-container {
      position: relative;
      z-index: 1;
      max-width: 480px;
      margin: 0 auto;
      padding: 0 1.25rem 2rem;
      min-height: 100vh;
    }

    /* ========== „Éò„ÉÉ„ÉÄ„Éº ========== */
    header {
      padding: 1.5rem 0 1rem;
      text-align: center;
      opacity: 0;
      animation: fadeSlideDown 0.8s ease-out 0.2s forwards;
    }

    .logo {
      font-family: 'Noto Serif JP', serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--sumi);
      letter-spacing: 0.3em;
      position: relative;
      display: inline-block;
    }

    .logo::before {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--shu), transparent);
    }

    .logo-sub {
      display: block;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--sumi-light);
      letter-spacing: 0.2em;
      margin-top: 0.5rem;
    }

    /* ========== „Çπ„Ç≠„É£„É≥„Ç®„É™„Ç¢ ========== */
    .scan-section {
      margin: 1.5rem 0;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.4s forwards;
    }

    .scan-area {
      position: relative;
      aspect-ratio: 3 / 4;
      background: var(--washi);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      touch-action: manipulation;
    }

    .scan-area:hover {
      transform: scale(1.01);
    }

    .scan-area.camera-active {
      cursor: default;
    }

    .scan-area.camera-active:hover {
      transform: none;
    }

    /* ÈöúÂ≠êÈ¢®„Éï„É¨„Éº„É† */
    .scan-frame {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }

    .scan-frame::before {
      content: '';
      position: absolute;
      inset: 8px;
      border: 2px solid var(--sumi);
      border-radius: 2px;
      opacity: 0.15;
    }

    /* Â¢®„ÅßÊèè„ÅÑ„Åü„Çà„ÅÜ„Å™‰∏çÂùá‰∏Ä„Å™„Éú„Éº„ÉÄ„Éº */
    .scan-frame-corner {
      position: absolute;
      width: 40px;
      height: 40px;
      opacity: 0.8;
    }

    .scan-frame-corner--tl {
      top: 12px;
      left: 12px;
      border-top: 3px solid var(--sumi);
      border-left: 3px solid var(--sumi);
      border-top-left-radius: 2px;
    }

    .scan-frame-corner--tr {
      top: 12px;
      right: 12px;
      border-top: 3px solid var(--sumi);
      border-right: 3px solid var(--sumi);
      border-top-right-radius: 2px;
    }

    .scan-frame-corner--bl {
      bottom: 12px;
      left: 12px;
      border-bottom: 3px solid var(--sumi);
      border-left: 3px solid var(--sumi);
      border-bottom-left-radius: 2px;
    }

    .scan-frame-corner--br {
      bottom: 12px;
      right: 12px;
      border-bottom: 3px solid var(--sumi);
      border-right: 3px solid var(--sumi);
      border-bottom-right-radius: 2px;
    }

    /* ÈöúÂ≠ê„ÅÆÂÖâ„Ç∞„É≠„ÉºÂäπÊûú */
    .scan-glow {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.6) 0%, transparent 70%);
      animation: pulseGlow 3s ease-in-out infinite;
      pointer-events: none;
    }

    .camera-active .scan-glow {
      display: none;
    }

    @keyframes pulseGlow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    .scan-content {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transition: opacity 0.3s ease;
    }

    .scan-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    .scan-area:hover .scan-icon {
      opacity: 0.6;
    }

    .scan-text {
      font-family: 'Noto Serif JP', serif;
      font-size: 1rem;
      color: var(--sumi-light);
      letter-spacing: 0.1em;
    }

    .scan-preview {
      position: absolute;
      inset: 0;
      object-fit: contain;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
      padding: 20px;
    }

    .scan-preview.visible {
      opacity: 1;
    }

    /* ========== „Ç´„É°„É©„Éì„Éá„Ç™Ë¶ÅÁ¥† ========== */
    .camera-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
      background: #000;
    }

    .camera-video.visible {
      opacity: 1;
    }

    /* „Ç≠„É£„Éó„ÉÅ„É£„Éó„É¨„Éì„É•„ÉºÔºàÊíÆÂΩ±Âæå„ÅÆÈùôÊ≠¢ÁîªÔºâ */
    .capture-preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .capture-preview.visible {
      opacity: 1;
    }

    /* „Ç≠„É£„Éó„ÉÅ„É£Áî®„Ç≠„É£„É≥„Éê„ÇπÔºàÈùûË°®Á§∫Ôºâ */
    .capture-canvas {
      display: none;
    }

    /* „Ç∑„É£„ÉÉ„Çø„Éº„Ç®„Éï„Çß„ÇØ„Éà */
    .shutter-effect {
      position: absolute;
      inset: 0;
      background: white;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
    }

    .shutter-effect.flash {
      animation: shutterFlash 0.2s ease-out;
    }

    @keyframes shutterFlash {
      0% { opacity: 0.9; }
      100% { opacity: 0; }
    }

    /* „Ç´„É°„É©Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ */
    .camera-switch-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(45, 45, 45, 0.6);
      border: none;
      cursor: pointer;
      z-index: 5;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      touch-action: manipulation;
    }

    .camera-switch-btn.visible {
      display: flex;
    }

    .camera-switch-btn:hover {
      background: rgba(45, 45, 45, 0.8);
      transform: scale(1.05);
    }

    .camera-switch-btn:active {
      transform: scale(0.95);
    }

    .camera-switch-btn svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    /* ÊíÆ„ÇäÁõ¥„Åó„Éú„Çø„É≥ */
    .retake-btn {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.75rem 1.5rem;
      background: rgba(250, 248, 245, 0.95);
      border: none;
      border-radius: 20px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      color: var(--ai);
      cursor: pointer;
      z-index: 5;
      display: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      touch-action: manipulation;
    }

    .retake-btn.visible {
      display: block;
    }

    .retake-btn:hover {
      background: white;
      color: var(--shu);
    }

    .retake-btn:active {
      transform: translateX(-50%) scale(0.95);
    }

    /* „Ç´„É°„É©„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ */
    .camera-error {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3;
      padding: 20px;
      text-align: center;
      background: rgba(250, 248, 245, 0.95);
    }

    .camera-error.visible {
      display: flex;
    }

    .camera-error-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 1rem;
      color: var(--shu);
      opacity: 0.8;
    }

    .camera-error-title {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.1rem;
      color: var(--sumi);
      margin-bottom: 0.5rem;
    }

    .camera-error-message {
      font-size: 0.85rem;
      color: var(--sumi-light);
      line-height: 1.6;
      max-width: 280px;
    }

    /* „Ç´„É°„É©„Ç®„É©„ÉºÊôÇ„ÅÆ„Éú„Çø„É≥Áæ§ */
    .camera-error-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1rem;
      width: 100%;
      max-width: 200px;
    }

    .camera-error-retry {
      padding: 0.75rem 1.5rem;
      background: var(--shu);
      color: white;
      border: none;
      border-radius: 4px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .camera-error-retry:hover {
      background: var(--shu-dark);
    }

    .camera-error-fallback {
      padding: 0.75rem 1.5rem;
      background: var(--ai);
      color: white;
      border: none;
      border-radius: 4px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .camera-error-fallback:hover {
      background: var(--ai-light);
    }

    /* „Çπ„Ç≠„É£„É≥„É©„Ç§„É≥ÂäπÊûú */
    .scan-line {
      position: absolute;
      left: 20px;
      right: 20px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--shu), transparent);
      box-shadow: 0 0 20px var(--shu-glow), 0 0 40px var(--shu-glow);
      z-index: 3;
      opacity: 0;
      pointer-events: none;
    }

    .scan-line.scanning {
      opacity: 1;
      animation: scanMove 2s ease-in-out infinite;
    }

    @keyframes scanMove {
      0% { top: 20px; }
      50% { top: calc(100% - 23px); }
      100% { top: 20px; }
    }

    /* ========== „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Çø„Éñ ========== */
    .mode-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1rem;
      background: var(--kage);
      border-radius: 8px;
      padding: 4px;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.5s forwards;
    }

    .mode-tab {
      flex: 1;
      padding: 0.75rem 1rem;
      min-height: 48px;
      border: none;
      border-radius: 6px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--sumi-light);
      background: transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      touch-action: manipulation;
    }

    .mode-tab.active {
      background: var(--washi);
      color: var(--sumi);
      box-shadow: 0 2px 8px var(--kage);
    }

    .mode-tab:not(.active):hover {
      color: var(--sumi);
    }

    .mode-tab-icon {
      width: 20px;
      height: 20px;
    }

    /* ========== „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ ========== */
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin: 1.5rem 0;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.6s forwards;
    }

    /* „Ç´„É°„É©„É¢„Éº„ÉâÊôÇ„ÅØÈùûË°®Á§∫ */
    .action-buttons.hidden {
      display: none;
    }

    .btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      min-height: 48px;
      border: none;
      border-radius: 4px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    .btn-primary {
      background: var(--shu);
      color: white;
      box-shadow: 0 4px 15px var(--shu-glow);
    }

    .btn-primary:hover {
      background: var(--shu-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shu-glow);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* Êú±Âç∞„Ç®„Éï„Çß„ÇØ„Éà */
    .btn-primary::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transform: scale(0);
      transition: all 0.4s ease;
    }

    .btn-primary:active::after {
      opacity: 1;
      transform: scale(2);
    }

    .btn-secondary {
      background: var(--washi);
      color: var(--ai);
      border: 1px solid var(--kage-deep);
    }

    .btn-secondary:hover {
      background: white;
      border-color: var(--ai);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--kage);
    }

    .btn-icon {
      width: 24px;
      height: 24px;
    }

    /* ========== ÊíÆÂΩ±„É¢„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Ç´„É°„É©„É¢„Éº„ÉâÁî®Ôºâ ========== */
    .capture-mode-section {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1.25rem;
      margin: 1.5rem 0 0.5rem;
      opacity: 0;
      animation: fadeSlideUp 0.4s ease-out forwards;
    }

    .capture-mode-section.visible {
      display: flex;
    }

    .capture-mode-buttons {
      display: flex;
      gap: 0.75rem;
      background: rgba(245, 241, 235, 0.9);
      padding: 0.375rem;
      border-radius: 999px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .capture-mode-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: none;
      background: transparent;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.85rem;
      color: var(--sumi-light);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .capture-mode-btn.active {
      background: var(--shu);
      color: white;
      box-shadow: 0 2px 8px var(--shu-glow);
    }

    .capture-mode-btn svg {
      flex-shrink: 0;
    }

    .frame-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.25rem;
      height: 1.25rem;
      padding: 0 0.35rem;
      border-radius: 999px;
      background: var(--kage);
      color: var(--kinari);
      font-size: 0.7rem;
      font-weight: 600;
    }

    .capture-mode-btn.active .frame-count {
      background: rgba(255,255,255,0.3);
    }

    @keyframes pulse-recording {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .shutter-btn {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: var(--shu);
      border: 4px solid white;
      box-shadow: 0 4px 20px var(--shu-glow), 0 0 0 4px var(--shu);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      touch-action: manipulation;
    }

    .shutter-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 25px var(--shu-glow), 0 0 0 4px var(--shu-dark);
    }

    .shutter-btn:active {
      transform: scale(0.95);
    }

    .shutter-btn::before {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      background: white;
      opacity: 0;
      transition: opacity 0.1s ease;
    }

    .shutter-btn:active::before {
      opacity: 0.3;
    }

    /* Èå≤Áîª‰∏≠„ÅÆ„Ç∑„É£„ÉÉ„Çø„Éº„Éú„Çø„É≥ÔºàÂõõËßí„ÅÑ„Éá„Ç∂„Ç§„É≥Ôºâ */
    .shutter-btn.recording {
      border-radius: 12px;
      animation: pulse-recording 1.5s ease-in-out infinite;
    }

    .shutter-btn.recording::before {
      border-radius: 4px;
    }

    /* Ëß£Êûê„Éú„Çø„É≥ */
    .analyze-section {
      margin: 1rem 0;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.7s forwards;
    }

    .btn-analyze {
      width: 100%;
      padding: 1.2rem;
      background: var(--ai);
      color: white;
      box-shadow: 0 4px 15px rgba(61, 90, 110, 0.3);
    }

    .btn-analyze:hover {
      background: var(--ai-light);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(61, 90, 110, 0.4);
    }

    .btn-analyze:disabled {
      background: var(--kage-deep);
      color: var(--sumi-light);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ========== „Åæ„Å®„ÇÅÊíÆ„ÇäÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ ========== */
    .batch-results-section {
      margin: 2rem 0;
      display: none;
      opacity: 0;
      transform: translateY(20px);
    }

    .batch-results-section.visible {
      display: block;
      animation: fadeSlideUp 0.6s ease-out forwards;
    }

    .batch-results-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .batch-results-header h2 {
      color: var(--sumi);
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .batch-count {
      color: var(--sumi-light);
      font-size: 1rem;
    }

    .batch-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .batch-receipt-card {
      background: var(--washi);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 10px var(--kage);
      transition: all 0.3s ease;
    }

    .batch-receipt-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--kage);
    }

    .batch-receipt-thumbnail {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 0.75rem;
      background: var(--kage-light);
    }

    .batch-receipt-info h3 {
      color: var(--sumi);
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .batch-receipt-info .amount {
      color: var(--shu);
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 0.75rem;
    }

    .batch-receipt-info .date {
      color: var(--sumi-light);
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }

    .batch-category-select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid var(--kage-light);
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      background: white;
    }

    .batch-save-btn {
      width: 100%;
      padding: 0.6rem;
      background: var(--ai);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .batch-save-btn:hover {
      background: var(--ai-light);
      transform: translateY(-1px);
    }

    .batch-save-btn:disabled {
      background: var(--kage);
      cursor: not-allowed;
    }

    .batch-save-btn.saved {
      background: var(--success);
    }

    .batch-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .batch-actions .btn {
      padding: 0.8rem 2rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .batch-actions .btn-primary {
      background: var(--shu);
      color: white;
    }

    .batch-actions .btn-primary:hover {
      background: var(--shu-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--shu-glow);
    }

    .batch-actions .btn-secondary {
      background: var(--kage-light);
      color: var(--sumi);
    }

    .batch-actions .btn-secondary:hover {
      background: var(--kage);
    }

    /* ========== ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ ========== */
    .result-section {
      margin: 2rem 0;
      display: none;
    }

    .result-section.visible {
      display: block;
    }

    .result-card {
      background: var(--washi);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px var(--kage);
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: translateY(20px);
    }

    .result-card.animate {
      animation: slideUp 0.6s ease-out forwards;
    }

    @keyframes slideUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ÂíåÁ¥ôÈ¢®„ÉÜ„ÇØ„Çπ„ÉÅ„É£ on „Ç´„Éº„Éâ */
    .result-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity: 0.02;
      pointer-events: none;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--kage);
    }

    .store-name {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--sumi);
    }

    .receipt-date {
      font-size: 0.85rem;
      color: var(--sumi-light);
    }

    .result-total {
      text-align: right;
      margin-bottom: 1.5rem;
    }

    .total-label {
      font-size: 0.8rem;
      color: var(--sumi-light);
      margin-bottom: 0.25rem;
    }

    .total-amount {
      font-family: 'Noto Serif JP', serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--shu);
    }

    .total-amount::before {
      content: '¬•';
      font-size: 1.2rem;
      margin-right: 0.1rem;
    }

    .result-items {
      list-style: none;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px dashed var(--kage);
      opacity: 0;
      transform: translateX(-10px);
    }

    .result-item.animate {
      animation: slideRight 0.4s ease-out forwards;
    }

    @keyframes slideRight {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .item-name {
      font-size: 0.95rem;
      color: var(--sumi);
    }

    .item-price {
      font-weight: 500;
      color: var(--ai);
    }

    /* ========== „Ç´„ÉÜ„Ç¥„É™ÂàÜÈ°û ========== */
    .category-section {
      margin-bottom: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--kage);
    }

    .category-label {
      font-size: 0.85rem;
      color: var(--sumi-light);
      margin-bottom: 0.75rem;
      font-weight: 500;
    }

    .category-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .category-btn {
      padding: 0.5rem 1rem;
      border: 1.5px solid var(--kage-deep);
      border-radius: 20px;
      background: var(--washi);
      color: var(--sumi);
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .category-btn:hover {
      border-color: var(--ai);
      background: rgba(61, 90, 110, 0.05);
      transform: translateY(-1px);
    }

    .category-btn.active {
      background: var(--ai);
      color: white;
      border-color: var(--ai);
      box-shadow: 0 2px 8px rgba(61, 90, 110, 0.3);
    }

    .category-btn.category-food.active {
      background: #e74c3c;
      border-color: #e74c3c;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
    }

    .category-btn.category-transport.active {
      background: #3498db;
      border-color: #3498db;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }

    .category-btn.category-daily.active {
      background: #2ecc71;
      border-color: #2ecc71;
      box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
    }

    .category-btn.category-entertainment.active {
      background: #9b59b6;
      border-color: #9b59b6;
      box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);
    }

    .category-btn.category-medical.active {
      background: #e67e22;
      border-color: #e67e22;
      box-shadow: 0 2px 8px rgba(230, 126, 34, 0.3);
    }

    .category-btn.category-education.active {
      background: #1abc9c;
      border-color: #1abc9c;
      box-shadow: 0 2px 8px rgba(26, 188, 156, 0.3);
    }

    .category-btn.category-other.active {
      background: var(--sumi-light);
      border-color: var(--sumi-light);
      box-shadow: 0 2px 8px rgba(45, 45, 45, 0.3);
    }

    .item-category {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      margin-left: 0.5rem;
      font-size: 0.7rem;
      border-radius: 10px;
      background: var(--kage);
      color: var(--sumi-light);
    }

    /* ========== Â±•Ê≠¥„Éú„Çø„É≥ ========== */
    .history-section {
      margin: 2rem 0;
      text-align: center;
      opacity: 0;
      animation: fadeSlideUp 0.8s ease-out 0.8s forwards;
    }

    .history-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      min-height: 48px;
      font-family: 'Zen Kaku Gothic New', sans-serif;
      font-size: 0.9rem;
      color: var(--sumi-light);
      text-decoration: none;
      border: 1px dashed var(--kage-deep);
      border-radius: 30px;
      transition: all 0.3s ease;
    }

    .history-link:hover {
      color: var(--ai);
      border-color: var(--ai);
      background: rgba(61, 90, 110, 0.05);
    }

    .history-icon {
      width: 18px;
      height: 18px;
    }

    /* ========== Èö†„Åóinput ========== */
    .hidden-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* ========== „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ ========== */
    @keyframes fadeSlideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========== „É≠„Éº„Éá„Ç£„É≥„Ç∞ ========== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(245, 241, 235, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .loading-circle {
      width: 60px;
      height: 60px;
      border: 3px solid var(--kage);
      border-top-color: var(--shu);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 1rem;
      font-family: 'Noto Serif JP', serif;
      font-size: 1rem;
      color: var(--sumi-light);
      letter-spacing: 0.1em;
    }

    /* „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÔºàÈÄ£Á∂ö„Çπ„Ç≠„É£„É≥Ëß£ÊûêÈÄ≤ÊçóÁî®Ôºâ */
    .progress-bar-container {
      width: 80%;
      max-width: 280px;
      height: 6px;
      background: rgba(45, 45, 45, 0.15);
      border-radius: 3px;
      margin-top: 16px;
      display: none;
      overflow: hidden;
    }

    .progress-bar-container.visible {
      display: block;
    }

    .progress-bar {
      height: 100%;
      background: var(--shu);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Ëß£Êûê„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„ÉàÔºàÂêÑ„Éï„É¨„Éº„É†„ÅÆÁä∂Ê≥ÅË°®Á§∫Ôºâ */
    .analysis-checklist {
      margin-top: 12px;
      display: none;
      flex-direction: column;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--sumi-light);
    }

    .analysis-checklist.visible {
      display: flex;
    }

    .analysis-checklist-item {
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.5;
      transition: opacity 0.3s ease;
    }

    .analysis-checklist-item.processing {
      opacity: 1;
    }

    .analysis-checklist-item.completed {
      opacity: 1;
      color: var(--sumi);
    }

    .analysis-checklist-item .check-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .analysis-checklist-item .check-icon svg {
      width: 14px;
      height: 14px;
      color: var(--shu);
    }

    .analysis-checklist-item .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--kage);
      border-top-color: var(--shu);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* ========== HTTPSË≠¶Âëä ========== */
    .https-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 0.75rem 1rem;
      padding-top: calc(0.75rem + var(--safe-area-top));
      background: rgba(201, 74, 74, 0.95);
      color: white;
      font-size: 0.85rem;
      text-align: center;
      z-index: 200;
    }

    .https-warning.visible {
      display: block;
    }

    /* ========== „É¨„Çπ„Éù„É≥„Ç∑„Éñ ========== */
    @media (min-width: 481px) {
      .app-container {
        padding: 0 2rem 3rem;
      }

      .logo {
        font-size: 3rem;
      }

      .scan-area {
        aspect-ratio: 4 / 5;
      }
    }

    /* Â∞è„Åï„ÅÑÁîªÈù¢Áî®„ÅÆË™øÊï¥ */
    @media (max-height: 700px) {
      header {
        padding: 1rem 0 0.5rem;
      }

      .logo {
        font-size: 2rem;
      }

      .logo-sub {
        font-size: 0.7rem;
        margin-top: 0.25rem;
      }

      .scan-section {
        margin: 1rem 0;
      }

      .scan-area {
        aspect-ratio: 4 / 5;
      }
    }
  </style>
</head>
<body>
  <!-- HTTPSË≠¶Âëä -->
  <div class="https-warning" id="httpsWarning">
    „Ç´„É°„É©Ê©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅHTTPSÊé•Á∂ö„ÅåÂøÖË¶Å„Åß„Åô
  </div>

  <div class="app-container">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header>
      <h1 class="logo">
        È†òÂèéË™≠
        <span class="logo-sub">„Çä„Çá„ÅÜ„Åó„ÇÖ„ÅÜ„Çà„Åø</span>
      </h1>
    </header>

    <!-- „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Çø„Éñ -->
    <div class="mode-tabs">
      <button class="mode-tab active" id="cameraModeTab" aria-label="„Ç´„É°„É©„É¢„Éº„Éâ">
        <svg class="mode-tab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2v11z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        „Ç´„É°„É©
      </button>
      <button class="mode-tab" id="galleryModeTab" aria-label="„ÇÆ„É£„É©„É™„Éº„É¢„Éº„Éâ">
        <svg class="mode-tab-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M3 15l5-5 4 4 5-5 4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
        </svg>
        „ÇÆ„É£„É©„É™„Éº
      </button>
    </div>

    <!-- „Çπ„Ç≠„É£„É≥„Ç®„É™„Ç¢ -->
    <section class="scan-section" aria-label="„É¨„Ç∑„Éº„Éà„Çπ„Ç≠„É£„É≥„Ç®„É™„Ç¢">
      <div class="scan-area" id="scanArea" role="button" tabindex="0" aria-label="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„É¨„Ç∑„Éº„Éà„ÇíÊíÆÂΩ±„Åæ„Åü„ÅØÈÅ∏Êäû">
        <!-- ÈöúÂ≠êÈ¢®„Ç∞„É≠„Éº -->
        <div class="scan-glow"></div>

        <!-- „Éï„É¨„Éº„É† -->
        <div class="scan-frame">
          <div class="scan-frame-corner scan-frame-corner--tl"></div>
          <div class="scan-frame-corner scan-frame-corner--tr"></div>
          <div class="scan-frame-corner scan-frame-corner--bl"></div>
          <div class="scan-frame-corner scan-frame-corner--br"></div>
        </div>

        <!-- „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="scan-content" id="scanContent">
          <svg class="scan-icon" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="15" width="60" height="50" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M20 55 L32 40 L42 48 L55 32 L65 45" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="30" cy="30" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M40 5 L40 12 M40 68 L40 75 M5 40 L12 40 M68 40 L75 40" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
          </svg>
          <p class="scan-text">„Çø„ÉÉ„Éó„Åó„Å¶„É¨„Ç∑„Éº„Éà„ÇíË™≠„ÅøËæº„ÇÄ</p>
        </div>

        <!-- „Ç´„É°„É©„Éì„Éá„Ç™ -->
        <video class="camera-video" id="cameraVideo" autoplay playsinline muted></video>

        <!-- „Ç≠„É£„Éó„ÉÅ„É£„Éó„É¨„Éì„É•„ÉºÔºàÊíÆÂΩ±Âæå„ÅÆÈùôÊ≠¢ÁîªÔºâ -->
        <img class="capture-preview" id="capturePreview" alt="ÊíÆÂΩ±„Éó„É¨„Éì„É•„Éº">

        <!-- ÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÔºà„ÇÆ„É£„É©„É™„Éº„Åã„ÇâÔºâ -->
        <img class="scan-preview" id="scanPreview" alt="„É¨„Ç∑„Éº„Éà„Éó„É¨„Éì„É•„Éº">

        <!-- „Ç≠„É£„Éó„ÉÅ„É£Áî®„Ç≠„É£„É≥„Éê„Çπ -->
        <canvas class="capture-canvas" id="captureCanvas"></canvas>

        <!-- „Ç∑„É£„ÉÉ„Çø„Éº„Ç®„Éï„Çß„ÇØ„Éà -->
        <div class="shutter-effect" id="shutterEffect"></div>

        <!-- „Ç´„É°„É©Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ -->
        <button class="camera-switch-btn" id="cameraSwitchBtn" aria-label="„Ç´„É°„É©„ÇíÂàá„ÇäÊõø„Åà">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 5h-3.17L15 3H9L7.17 5H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V7a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M12 17a4 4 0 100-8 4 4 0 000 8z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M9 12h6M12 9l-2 3 2 3M12 9l2 3-2 3" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- ÊíÆ„ÇäÁõ¥„Åó„Éú„Çø„É≥ -->
        <button class="retake-btn" id="retakeBtn">ÊíÆ„ÇäÁõ¥„Åô</button>

        <!-- „Ç´„É°„É©„Ç®„É©„ÉºË°®Á§∫ -->
        <div class="camera-error" id="cameraError">
          <svg class="camera-error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <h3 class="camera-error-title" id="cameraErrorTitle">„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì</h3>
          <p class="camera-error-message" id="cameraErrorMessage">„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„Åã„Çâ„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
          <!-- „Ç´„É°„É©Êìç‰Ωú„Éú„Çø„É≥Áæ§ -->
          <div class="camera-error-buttons">
            <button class="camera-error-retry" id="cameraErrorRetry">ÂÜçË©¶Ë°å</button>
            <button class="camera-error-fallback" id="cameraErrorFallback">„ÇÆ„É£„É©„É™„Éº„Åã„ÇâÈÅ∏Êäû</button>
          </div>
        </div>

        <!-- „Çπ„Ç≠„É£„É≥„É©„Ç§„É≥ -->
        <div class="scan-line" id="scanLine"></div>
      </div>
    </section>

    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ôºà„ÇÆ„É£„É©„É™„Éº„É¢„Éº„ÉâÁî®Ôºâ -->
    <div class="action-buttons hidden" id="actionButtons">
      <button class="btn btn-primary" id="cameraBtn" aria-label="„Ç´„É°„É©„ÅßÊíÆÂΩ±">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2v11z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        ÊíÆÂΩ±
      </button>
      <button class="btn btn-secondary" id="galleryBtn" aria-label="„ÇÆ„É£„É©„É™„Éº„Åã„ÇâÈÅ∏Êäû">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M3 15l5-5 4 4 5-5 4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
        </svg>
        ÈÅ∏Êäû
      </button>
    </div>

    <!-- ÊíÆÂΩ±„É¢„Éº„ÉâÈÅ∏ÊäûÔºàÊ®™‰∏¶„Å≥Ôºâ -->
    <div class="capture-mode-section" id="captureModeSection">
      <div class="capture-mode-buttons">
        <button class="capture-mode-btn active" id="singleModeBtn" data-mode="single">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <span>1ÊûöÊíÆÂΩ±</span>
        </button>
        <button class="capture-mode-btn" id="continuousModeBtn" data-mode="continuous">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="4" width="14" height="14" rx="2"/>
            <rect x="6" y="2" width="14" height="14" rx="2"/>
            <rect x="10" y="6" width="14" height="14" rx="2"/>
          </svg>
          <span id="continuousModeText">„Åæ„Å®„ÇÅÊíÆ„Çä</span>
          <span class="frame-count" id="frameCount">0</span>
        </button>
      </div>

      <!-- „Ç∑„É£„ÉÉ„Çø„Éº„Éú„Çø„É≥ -->
      <button class="shutter-btn" id="shutterBtn" aria-label="„Ç∑„É£„ÉÉ„Çø„Éº"></button>
    </div>

    <!-- Ëß£Êûê„Éú„Çø„É≥ -->
    <div class="analyze-section">
      <button class="btn btn-analyze" id="analyzeBtn" disabled aria-label="„É¨„Ç∑„Éº„Éà„ÇíËß£Êûê">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 2v6h6M9 15h6M9 11h6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
        „É¨„Ç∑„Éº„Éà„ÇíËß£Êûê„Åô„Çã
      </button>
    </div>

    <!-- „Åæ„Å®„ÇÅÊíÆ„ÇäÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
    <section class="batch-results-section" id="batchResultsSection" aria-label="„Åæ„Å®„ÇÅÊíÆ„ÇäÁµêÊûú">
      <div class="batch-results-header">
        <h2>„Åæ„Å®„ÇÅÊíÆ„ÇäÂÆå‰∫Ü</h2>
        <p class="batch-count"><span id="batchCount">0</span>‰ª∂„ÅÆ„É¨„Ç∑„Éº„Éà„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü</p>
      </div>
      <div class="batch-results-grid" id="batchResultsGrid">
        <!-- „É¨„Ç∑„Éº„Éà„Ç´„Éº„Éâ„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
      </div>
      <div class="batch-actions">
        <button class="btn btn-primary" id="saveAllBtn">„Åô„Åπ„Å¶‰øùÂ≠ò</button>
        <button class="btn btn-secondary" id="closeBatchBtn">Èñâ„Åò„Çã</button>
      </div>
    </section>

    <!-- ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
    <section class="result-section" id="resultSection" aria-label="Ë™≠„ÅøÂèñ„ÇäÁµêÊûú">
      <div class="result-card" id="resultCard">
        <div class="result-header">
          <div>
            <h2 class="store-name" id="storeName">-</h2>
            <p class="receipt-date" id="receiptDate">-</p>
          </div>
        </div>
        <div class="result-total">
          <p class="total-label">ÂêàË®àÈáëÈ°ç</p>
          <p class="total-amount" id="totalAmount">-</p>
        </div>
        <div class="category-section" id="categorySection">
          <p class="category-label">„Ç´„ÉÜ„Ç¥„É™</p>
          <div class="category-buttons" id="categoryButtons">
            <!-- ÂãïÁöÑ„Å´ËøΩÂä† -->
          </div>
        </div>
        <ul class="result-items" id="resultItems">
          <!-- ÂãïÁöÑ„Å´ËøΩÂä† -->
        </ul>
      </div>
    </section>

    <!-- Â±•Ê≠¥„É™„É≥„ÇØ -->
    <div class="history-section">
      <a href="#" class="history-link" aria-label="Â±•Ê≠¥„ÇíË¶ã„Çã">
        <svg class="history-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
        ÈÅéÂéª„ÅÆÂ±•Ê≠¥„ÇíË¶ã„Çã
      </a>
    </div>

    <!-- Èö†„Åó„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
    <input type="file" class="hidden-input" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" class="hidden-input" id="galleryInput" accept="image/*">
  </div>

  <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ÔºàËß£Êûê‰∏≠Ë°®Á§∫Ôºâ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-circle"></div>
    <p class="loading-text">Ëß£Êûê‰∏≠...</p>
    <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÔºàÈÄ£Á∂ö„Çπ„Ç≠„É£„É≥ÊôÇ„ÅÆÈÄ≤ÊçóË°®Á§∫Ôºâ -->
    <div class="progress-bar-container" id="progressBarContainer">
      <div class="progress-bar" id="analysisProgressBar"></div>
    </div>
    <!-- ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„ÉàÔºàÂêÑ„Éï„É¨„Éº„É†Ëß£ÊûêÁä∂Ê≥ÅÔºâ -->
    <div class="analysis-checklist" id="analysisChecklist"></div>
  </div>

  <script>
    // ========== DOMË¶ÅÁ¥† ==========
    const scanArea = document.getElementById('scanArea');
    const scanContent = document.getElementById('scanContent');
    const scanPreview = document.getElementById('scanPreview');
    const scanLine = document.getElementById('scanLine');
    const cameraBtn = document.getElementById('cameraBtn');
    const galleryBtn = document.getElementById('galleryBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const cameraInput = document.getElementById('cameraInput');
    const galleryInput = document.getElementById('galleryInput');
    const resultSection = document.getElementById('resultSection');
    const resultCard = document.getElementById('resultCard');
    const storeName = document.getElementById('storeName');
    const receiptDate = document.getElementById('receiptDate');
    const totalAmount = document.getElementById('totalAmount');
    const resultItems = document.getElementById('resultItems');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const categorySection = document.getElementById('categorySection');
    const categoryButtons = document.getElementById('categoryButtons');

    // „Åæ„Å®„ÇÅÊíÆ„ÇäÁµêÊûúË°®Á§∫Ë¶ÅÁ¥†
    const batchResultsSection = document.getElementById('batchResultsSection');
    const batchCount = document.getElementById('batchCount');
    const batchResultsGrid = document.getElementById('batchResultsGrid');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const closeBatchBtn = document.getElementById('closeBatchBtn');

    // „Ç´„É°„É©Èñ¢ÈÄ£Ë¶ÅÁ¥†
    const cameraVideo = document.getElementById('cameraVideo');
    const captureCanvas = document.getElementById('captureCanvas');
    const capturePreview = document.getElementById('capturePreview');
    const shutterEffect = document.getElementById('shutterEffect');
    const cameraSwitchBtn = document.getElementById('cameraSwitchBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const cameraError = document.getElementById('cameraError');
    const cameraErrorTitle = document.getElementById('cameraErrorTitle');
    const cameraErrorMessage = document.getElementById('cameraErrorMessage');
    const cameraErrorRetry = document.getElementById('cameraErrorRetry');
    const cameraErrorFallback = document.getElementById('cameraErrorFallback');
    const httpsWarning = document.getElementById('httpsWarning');

    // „É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàË¶ÅÁ¥†
    const cameraModeTab = document.getElementById('cameraModeTab');
    const galleryModeTab = document.getElementById('galleryModeTab');
    const actionButtons = document.getElementById('actionButtons');
    const captureModeSection = document.getElementById('captureModeSection');
    const singleModeBtn = document.getElementById('singleModeBtn');
    const continuousModeBtn = document.getElementById('continuousModeBtn');
    const continuousModeText = document.getElementById('continuousModeText');
    const frameCount = document.getElementById('frameCount');
    const shutterBtn = document.getElementById('shutterBtn');

    // ========== Áä∂ÊÖãÁÆ°ÁêÜ ==========
    let hasImage = false;
    let isStreaming = false;
    let currentFacingMode = 'environment'; // 'environment'ÔºàËÉåÈù¢Ôºâor 'user'ÔºàÂâçÈù¢Ôºâ
    let capturedImageData = null;
    let currentStream = null;
    let currentMode = 'camera'; // 'camera' or 'gallery'
    let availableCameras = [];
    let currentReceiptData = null;
    let selectedCategory = null;
    let isContinuousMode = false;
    let isContinuousRunning = false;
    let continuousIntervalId = null;
    let continuousFrames = []; // { dataUrl, thumbUrl, score }
    let isAnalyzing = false; // Ëß£Êûê‰∏≠„Éï„É©„Ç∞ÔºàÈáçË§áÈò≤Ê≠¢Ôºâ
    let receiptResults = []; // Ë§áÊï∞„ÅÆ„É¨„Ç∑„Éº„ÉàËß£ÊûêÁµêÊûú„Çí‰øùÂ≠ò
    let lastReceiptDetectionTime = 0; // ÊúÄÂæå„ÅÆ„É¨„Ç∑„Éº„ÉàÊ§úÂá∫ÊôÇÂàª

    // ========== „Ç´„ÉÜ„Ç¥„É™ÂÆöÁæ© ==========
    const categories = [
      { id: 'food', name: 'È£üË≤ª', icon: 'üçΩÔ∏è', class: 'category-food' },
      { id: 'transport', name: '‰∫§ÈÄöË≤ª', icon: 'üöÉ', class: 'category-transport' },
      { id: 'daily', name: 'Êó•Áî®ÂìÅ', icon: 'üõí', class: 'category-daily' },
      { id: 'entertainment', name: 'Â®ØÊ•Ω', icon: 'üé¨', class: 'category-entertainment' },
      { id: 'medical', name: 'ÂåªÁôÇ', icon: 'üè•', class: 'category-medical' },
      { id: 'education', name: 'ÊïôËÇ≤', icon: 'üìö', class: 'category-education' },
      { id: 'other', name: '„Åù„ÅÆ‰ªñ', icon: 'üìù', class: 'category-other' }
    ];

    // ========== LocalStorageÁÆ°ÁêÜ„ÇØ„É©„Çπ ==========
    class ReceiptStorage {
      constructor() {
        this.storageKey = 'receipts';
        this.settingsKey = 'settings';
        this.maxReceipts = 100; // ÊúÄÂ§ß‰øùÂ≠ò‰ª∂Êï∞
      }

      // „Åô„Åπ„Å¶„ÅÆ„É¨„Ç∑„Éº„Éà„ÇíÂèñÂæó
      getAll() {
        try {
          const data = localStorage.getItem(this.storageKey);
          return data ? JSON.parse(data) : [];
        } catch (error) {
          console.error('LocalStorageË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
          return [];
        }
      }

      // „É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò
      save(receipt) {
        try {
          const receipts = this.getAll();

          // ID„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁîüÊàê
          if (!receipt.id) {
            receipt.id = 'receipt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          }

          // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
          if (!receipt.timestamp) {
            receipt.timestamp = Date.now();
          }

          if (!receipt.createdAt) {
            receipt.createdAt = new Date().toISOString();
          }

          receipts.push(receipt);

          // ÊúÄÂ§ß‰ª∂Êï∞„ÇíË∂Ö„Åà„Åü„ÇâÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
          if (receipts.length > this.maxReceipts) {
            receipts.sort((a, b) => a.timestamp - b.timestamp);
            receipts.splice(0, receipts.length - this.maxReceipts);
          }

          localStorage.setItem(this.storageKey, JSON.stringify(receipts));
          console.log('„É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', receipt.id);
          return receipt.id;
        } catch (error) {
          console.error('LocalStorage‰øùÂ≠ò„Ç®„É©„Éº:', error);
          if (error.name === 'QuotaExceededError') {
            // ÂÆπÈáèË∂ÖÈÅé„ÅÆÂ†¥Âêà„ÄÅÂè§„ÅÑ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„É™„Éà„É©„Ç§
            this.cleanupOldData();
            return this.save(receipt);
          }
          throw error;
        }
      }

      // ÊåáÂÆöÊó•‰ªò„ÅÆ„É¨„Ç∑„Éº„Éà„ÇíÂèñÂæó
      getByDate(dateString) {
        const receipts = this.getAll();
        return receipts.filter(r => r.date === dateString);
      }

      // ÊåáÂÆöÊúà„ÅÆ„É¨„Ç∑„Éº„Éà„ÇíÂèñÂæó
      getByMonth(year, month) {
        const receipts = this.getAll();
        const targetMonth = `${year}-${String(month).padStart(2, '0')}`;
        return receipts.filter(r => r.date && r.date.startsWith(targetMonth));
      }

      // ID„Åß„É¨„Ç∑„Éº„Éà„ÇíÂèñÂæó
      getById(id) {
        const receipts = this.getAll();
        return receipts.find(r => r.id === id);
      }

      // „É¨„Ç∑„Éº„Éà„ÇíÂâäÈô§
      delete(id) {
        try {
          const receipts = this.getAll();
          const filtered = receipts.filter(r => r.id !== id);
          localStorage.setItem(this.storageKey, JSON.stringify(filtered));
          console.log('„É¨„Ç∑„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü:', id);
          return true;
        } catch (error) {
          console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
          return false;
        }
      }

      // Âè§„ÅÑ„Éá„Éº„Çø„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      cleanupOldData() {
        const receipts = this.getAll();
        if (receipts.length > 50) {
          receipts.sort((a, b) => a.timestamp - b.timestamp);
          const keep = receipts.slice(-50);
          localStorage.setItem(this.storageKey, JSON.stringify(keep));
          console.log('Âè§„ÅÑ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
      }

      // ÂÖ®„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
      clearAll() {
        localStorage.removeItem(this.storageKey);
        console.log('ÂÖ®„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
      }
    }

    // „Çπ„Éà„É¨„Éº„Ç∏„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
    const storage = new ReceiptStorage();

    // ========== ÂàùÊúüÂåñ ==========
    async function init() {
      // HTTPS „ÉÅ„Çß„ÉÉ„ÇØ
      checkHttps();

      // „Ç´„É°„É©„ÅÆÂà©Áî®ÂèØËÉΩÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
      await checkCameraAvailability();

      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
      setupEventListeners();

      // „Ç´„É°„É©„É¢„Éº„Éâ„ÅßÂàùÊúüÂåñ
      if (isCameraSupported()) {
        switchToMode('camera');
      } else {
        // „Ç´„É°„É©„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØ„ÇÆ„É£„É©„É™„Éº„É¢„Éº„Éâ„Å´
        switchToMode('gallery');
      }
    }

    // HTTPS„ÉÅ„Çß„ÉÉ„ÇØ
    function checkHttps() {
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (!isSecure) {
        httpsWarning.classList.add('visible');
      }
    }

    // „Ç´„É°„É©„Çµ„Éù„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ
    function isCameraSupported() {
      return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    }

    // „Ç´„É°„É©„ÅÆÂà©Áî®ÂèØËÉΩÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    async function checkCameraAvailability() {
      if (!isCameraSupported()) {
        return;
      }

      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        availableCameras = devices.filter(device => device.kind === 'videoinput');

        // „Ç´„É°„É©„Åå2„Å§‰ª•‰∏ä„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÇíË°®Á§∫ÂèØËÉΩ„Å´
        if (availableCameras.length <= 1) {
          cameraSwitchBtn.style.display = 'none';
        }
      } catch (error) {
        console.warn('„Ç´„É°„É©ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
      }
    }

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
    function setupEventListeners() {
      // „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Çø„Éñ
      cameraModeTab.addEventListener('click', () => switchToMode('camera'));
      galleryModeTab.addEventListener('click', () => switchToMode('gallery'));

      // „ÇÆ„É£„É©„É™„Éº„É¢„Éº„Éâ„ÅÆ„Éú„Çø„É≥
      cameraBtn.addEventListener('click', () => cameraInput.click());
      galleryBtn.addEventListener('click', () => galleryInput.click());

      // „Çπ„Ç≠„É£„É≥„Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÔºà„ÇÆ„É£„É©„É™„Éº„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ
      scanArea.addEventListener('click', handleScanAreaClick);
      scanArea.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter' || e.key === ' ') && currentMode === 'gallery') {
          e.preventDefault();
          galleryInput.click();
        }
      });

      // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû
      cameraInput.addEventListener('change', handleFileSelect);
      galleryInput.addEventListener('change', handleFileSelect);

      // „Ç´„É°„É©Èñ¢ÈÄ£
      shutterBtn.addEventListener('click', capturePhoto);
      cameraSwitchBtn.addEventListener('click', switchCamera);
      retakeBtn.addEventListener('click', retakePhoto);

      // „Ç´„É°„É©„Ç®„É©„ÉºÊôÇ„ÅÆÂÜçË©¶Ë°å„Éú„Çø„É≥
      cameraErrorRetry.addEventListener('click', () => {
        cameraError.classList.remove('visible');
        startCamera();
      });

      // „Ç´„É°„É©„Ç®„É©„ÉºÊôÇ„ÅÆ„ÇÆ„É£„É©„É™„ÉºÈÅ∏Êäû„Éú„Çø„É≥
      cameraErrorFallback.addEventListener('click', () => {
        switchToMode('gallery');
        galleryInput.click();
      });

      // Ëß£Êûê„Éú„Çø„É≥
      analyzeBtn.addEventListener('click', analyzeReceipt);

      // ÊíÆÂΩ±„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
      singleModeBtn.addEventListener('click', () => selectCaptureMode('single'));
      continuousModeBtn.addEventListener('click', () => selectCaptureMode('continuous'));

      // „Éê„ÉÉ„ÉÅÁµêÊûú„ÅÆ‰øùÂ≠ò„ÉªÈñâ„Åò„Çã
      saveAllBtn.addEventListener('click', saveAllReceipts);
      closeBatchBtn.addEventListener('click', closeBatchResults);

      // „Éê„ÉÉ„ÉÅÁµêÊûú„Ç∞„É™„ÉÉ„ÉâÂÜÖ„ÅÆ„Éú„Çø„É≥Ôºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
      batchResultsGrid.addEventListener('click', handleBatchCardClick);

      // „Éö„Éº„Ç∏ÈùûË°®Á§∫ÊôÇ„Å´„Ç´„É°„É©„ÇíÂÅúÊ≠¢
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && isStreaming) {
          stopCamera();
        } else if (!document.hidden && currentMode === 'camera' && !capturedImageData) {
          startCamera();
        }
      });
    }

    // „Çπ„Ç≠„É£„É≥„Ç®„É™„Ç¢„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
    function handleScanAreaClick() {
      if (currentMode === 'gallery' && !hasImage) {
        galleryInput.click();
      }
    }

    // ========== „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà ==========
    function switchToMode(mode) {
      currentMode = mode;

      if (mode === 'camera') {
        cameraModeTab.classList.add('active');
        galleryModeTab.classList.remove('active');
        actionButtons.classList.add('hidden');
        captureModeSection.classList.add('visible');
        scanArea.classList.add('camera-active');

        // „ÇÆ„É£„É©„É™„Éº„Éó„É¨„Éì„É•„Éº„ÇíÈùûË°®Á§∫
        scanPreview.classList.remove('visible');

        // „Ç´„É°„É©„ÇíÈñãÂßã
        startCamera();
      } else {
        cameraModeTab.classList.remove('active');
        galleryModeTab.classList.add('active');
        actionButtons.classList.remove('hidden');
        captureModeSection.classList.remove('visible');
        if (isContinuousRunning) {
          stopContinuousCapture();
        }
        scanArea.classList.remove('camera-active');

        // „Ç´„É°„É©„ÇíÂÅúÊ≠¢
        stopCamera();

        // „Ç´„É°„É©Èñ¢ÈÄ£UI„ÇíÈùûË°®Á§∫
        cameraVideo.classList.remove('visible');
        capturePreview.classList.remove('visible');
        cameraSwitchBtn.classList.remove('visible');
        retakeBtn.classList.remove('visible');
        cameraError.classList.remove('visible');

        // „Ç≠„É£„Éó„ÉÅ„É£„Åó„ÅüÁîªÂÉè„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
        if (capturedImageData) {
          scanPreview.src = capturedImageData;
          scanPreview.classList.add('visible');
          scanContent.style.opacity = '0';
        } else if (!hasImage) {
          scanContent.style.opacity = '1';
        }
      }
    }

    // ========== „Ç´„É°„É©Ê©üËÉΩ ==========
    async function startCamera() {
      if (!isCameraSupported()) {
        showCameraError('„Ç´„É°„É©„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', '„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Ç´„É°„É©Ê©üËÉΩ„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÇÆ„É£„É©„É™„Éº„Åã„ÇâÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      // Êó¢Â≠ò„ÅÆ„Çπ„Éà„É™„Éº„É†„ÇíÂÅúÊ≠¢
      stopCamera();

      // „Ç≠„É£„Éó„ÉÅ„É£„Éó„É¨„Éì„É•„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫„Åó„Å™„ÅÑ
      if (capturedImageData) {
        capturePreview.src = capturedImageData;
        capturePreview.classList.add('visible');
        retakeBtn.classList.add('visible');
        return;
      }

      try {
        const constraints = {
          video: {
            facingMode: currentFacingMode,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraVideo.srcObject = currentStream;

        // „Éì„Éá„Ç™ÂÜçÁîüÈñãÂßã„ÇíÂæÖ„Å§
        await new Promise((resolve, reject) => {
          cameraVideo.onloadedmetadata = () => {
            cameraVideo.play()
              .then(resolve)
              .catch((playError) => {
                console.error('„Éì„Éá„Ç™ÂÜçÁîü„Ç®„É©„Éº:', playError);
                // play()Â§±ÊïóÊôÇ„ÅØ„É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„Å™„Ç®„É©„Éº„ÇíË°®Á§∫
                showCameraError(
                  '„Ç´„É°„É©Êò†ÂÉè„ÇíË°®Á§∫„Åß„Åç„Åæ„Åõ„Çì',
                  'Êò†ÂÉè„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å„Åô„Çã„Åã„ÄÅ„ÇÆ„É£„É©„É™„Éº„Åã„ÇâÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                );
                reject(playError);
              });
          };

          // „É°„Çø„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºà5ÁßíÔºâ
          setTimeout(() => {
            if (!isStreaming) {
              showCameraError(
                '„Ç´„É°„É©„ÅÆË™≠„ÅøËæº„Åø„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü',
                '„Ç´„É°„É©„ÅÆÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÜçË©¶Ë°å„Åô„Çã„Åã„ÄÅ„ÇÆ„É£„É©„É™„Éº„Åã„ÇâÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
              );
              reject(new Error('Camera metadata load timeout'));
            }
          }, 5000);
        });

        // UIÊõ¥Êñ∞
        isStreaming = true;
        cameraVideo.classList.add('visible');
        scanContent.style.opacity = '0';
        cameraError.classList.remove('visible');

        // „Ç´„É°„É©„ÅåË§áÊï∞„ÅÇ„ÇãÂ†¥Âêà„ÅØÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÇíË°®Á§∫
        if (availableCameras.length > 1) {
          cameraSwitchBtn.classList.add('visible');
        }

        // „Ç´„É°„É©ÊÉÖÂ†±„ÇíÂÜçÂèñÂæóÔºàÂàùÂõû„ÅØÊ®©Èôê„Åå„Å™„ÅÑ„Å®Á©∫„Å´„Å™„Çã„Åü„ÇÅÔºâ
        if (availableCameras.length === 0) {
          await checkCameraAvailability();
          if (availableCameras.length > 1) {
            cameraSwitchBtn.classList.add('visible');
          }
        }

      } catch (error) {
        console.error('„Ç´„É°„É©Ëµ∑Âãï„Ç®„É©„Éº:', error);
        handleCameraError(error);
      }
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      cameraVideo.srcObject = null;
      isStreaming = false;
    }

    // „Ç´„É°„É©„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
    function handleCameraError(error) {
      let title = '„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì';
      let message = '„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Å´ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';

      switch (error.name) {
        case 'NotAllowedError':
        case 'PermissionDeniedError':
          title = '„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü';
          message = '„Ç´„É°„É©„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åã„Çâ„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          break;
        case 'NotFoundError':
        case 'DevicesNotFoundError':
          title = '„Ç´„É°„É©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
          message = '„Åä‰Ωø„ÅÑ„ÅÆ„Éá„Éê„Ç§„Çπ„Å´„Ç´„É°„É©„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÄÅ‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ';
          break;
        case 'NotReadableError':
        case 'TrackStartError':
          title = '„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì';
          message = '„Ç´„É°„É©„Åå‰ªñ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
          break;
        case 'OverconstrainedError':
          title = '„Ç´„É°„É©„ÅÆË®≠ÂÆö„Ç®„É©„Éº';
          message = 'ÊåáÂÆö„Åï„Çå„Åü„Ç´„É°„É©Ë®≠ÂÆö„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
          break;
        case 'SecurityError':
          title = '„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç®„É©„Éº';
          message = 'HTTPSÊé•Á∂ö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÂÆâÂÖ®„Å™Êé•Á∂ö„Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          break;
      }

      showCameraError(title, message);
    }

    function showCameraError(title, message) {
      cameraErrorTitle.textContent = title;
      cameraErrorMessage.textContent = message;
      cameraError.classList.add('visible');
      cameraVideo.classList.remove('visible');
      cameraSwitchBtn.classList.remove('visible');
    }

    // „Ç´„É°„É©Âàá„ÇäÊõø„Åà
    async function switchCamera() {
      currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';

      // Âàá„ÇäÊõø„Åà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      cameraSwitchBtn.style.transform = 'rotate(180deg)';
      setTimeout(() => {
        cameraSwitchBtn.style.transform = '';
      }, 300);

      await startCamera();
    }

    // ÊíÆÂΩ±
    function capturePhoto() {
      if (!isStreaming) return;

      // „Åæ„Å®„ÇÅÊíÆ„Çä„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
      if (isContinuousMode) {
        // Èå≤Áîª‰∏≠„ÅÆÂ†¥Âêà„ÅØÂÅúÊ≠¢
        if (isContinuousRunning) {
          stopContinuousCapture();
        } else {
          // Èå≤ÁîªÈñãÂßã
          startContinuousCapture();
        }
        return;
      }

      // 1ÊûöÊíÆÂΩ±„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
      // „Ç∑„É£„ÉÉ„Çø„Éº„Ç®„Éï„Çß„ÇØ„Éà
      shutterEffect.classList.add('flash');
      setTimeout(() => shutterEffect.classList.remove('flash'), 200);

      // „Ç≠„É£„É≥„Éê„Çπ„Å´ÊèèÁîª
      const ctx = captureCanvas.getContext('2d');
      captureCanvas.width = cameraVideo.videoWidth;
      captureCanvas.height = cameraVideo.videoHeight;
      ctx.drawImage(cameraVideo, 0, 0);

      // ÁîªÂÉè„Éá„Éº„Çø„ÇíÂèñÂæó
      capturedImageData = captureCanvas.toDataURL('image/jpeg', 0.9);

      // „Ç´„É°„É©„ÇíÂÅúÊ≠¢
      stopCamera();

      // „Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫
      capturePreview.src = capturedImageData;
      capturePreview.classList.add('visible');
      cameraVideo.classList.remove('visible');
      cameraSwitchBtn.classList.remove('visible');
      retakeBtn.classList.add('visible');

      // Ëß£Êûê„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
      hasImage = true;
      analyzeBtn.disabled = false;

      // ÁµêÊûú„Çí„É™„Çª„ÉÉ„Éà
      resultSection.classList.remove('visible');
      resultCard.classList.remove('animate');
    }

    // ÊíÆ„ÇäÁõ¥„Åó
    function retakePhoto() {
      capturedImageData = null;
      hasImage = false;
      analyzeBtn.disabled = true;

      // „Éó„É¨„Éì„É•„Éº„ÇíÈùûË°®Á§∫
      capturePreview.classList.remove('visible');
      retakeBtn.classList.remove('visible');

      // „Ç´„É°„É©„ÇíÂÜçÈñã
      startCamera();
    }

    // ========== ÊíÆÂΩ±„É¢„Éº„ÉâÈÅ∏Êäû ==========
    function selectCaptureMode(mode) {
      // Èå≤Áîª‰∏≠„ÅØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà‰∏çÂèØ
      if (isContinuousRunning) return;

      if (mode === 'single') {
        // 1ÊûöÊíÆÂΩ±„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
        isContinuousMode = false;
        singleModeBtn.classList.add('active');
        continuousModeBtn.classList.remove('active');
        stopContinuousCapture();
      } else if (mode === 'continuous') {
        // „Åæ„Å®„ÇÅÊíÆ„Çä„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
        isContinuousMode = true;
        singleModeBtn.classList.remove('active');
        continuousModeBtn.classList.add('active');
        // ÊíÆÂΩ±„Éú„Çø„É≥„ÇíÊäº„Åô„Åæ„ÅßÈå≤Áîª„ÅØÈñãÂßã„Åó„Å™„ÅÑ
      }
    }

    function startContinuousCapture() {
      if (!isCameraSupported()) return;

      // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
      receiptResults = [];
      isAnalyzing = false;
      lastReceiptDetectionTime = 0;
      updateContinuousCount();
      isContinuousRunning = true;

      // UI„ÇíÈå≤Áîª‰∏≠„Å´Â§âÊõ¥
      shutterBtn.classList.add('recording');
      continuousModeText.textContent = 'ÊíÆÂΩ±‰∏≠';

      // „Ç´„É°„É©„ÅåÊ≠¢„Åæ„Å£„Å¶„ÅÑ„Åü„ÇâÂÜçÈñã
      if (!isStreaming && !capturedImageData) {
        startCamera();
      }

      // 500ms„Åî„Å®„Å´„Éï„É¨„Éº„É†„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà„É¨„Ç∑„Éº„ÉàÊ§úÂá∫Ôºâ
      if (continuousIntervalId) {
        clearInterval(continuousIntervalId);
      }

      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      // „É¨„Ç∑„Éº„ÉàÊ§úÂá∫Áî®„ÅÆËß£ÂÉèÂ∫¶
      const TARGET_WIDTH = 640;
      const TARGET_HEIGHT = 480;

      continuousIntervalId = setInterval(async () => {
        if (!isStreaming || cameraVideo.videoWidth === 0) return;
        if (isAnalyzing) return; // Ëß£Êûê‰∏≠„ÅØÊ¨°„ÅÆÂà§ÂÆö„Çí„Çπ„Ç≠„ÉÉ„Éó

        // ÊúÄÂæå„ÅÆÊ§úÂá∫„Åã„Çâ3Áßí‰ª•ÂÜÖ„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàÂêå„Åò„É¨„Ç∑„Éº„Éà„ÇíË§áÊï∞ÂõûËß£Êûê„Åó„Å™„ÅÑÔºâ
        const now = Date.now();
        if (now - lastReceiptDetectionTime < 3000) {
          return;
        }

        // „Éï„É¨„Éº„É†„Çí„Ç≠„É£„Éó„ÉÅ„É£
        tempCanvas.width = TARGET_WIDTH;
        tempCanvas.height = TARGET_HEIGHT;
        tempCtx.drawImage(cameraVideo, 0, 0, TARGET_WIDTH, TARGET_HEIGHT);

        const imageData = tempCtx.getImageData(0, 0, TARGET_WIDTH, TARGET_HEIGHT);
        const current = {
          data: imageData.data,
          w: TARGET_WIDTH,
          h: TARGET_HEIGHT,
        };

        // „É¨„Ç∑„Éº„ÉàÂà§ÂÆö
        const isReceipt = detectReceipt(current);

        if (isReceipt) {
          console.log('„É¨„Ç∑„Éº„Éà„ÇíÊ§úÂá∫ÔºÅËá™ÂãïËß£Êûê„ÇíÈñãÂßã„Åó„Åæ„Åô');
          lastReceiptDetectionTime = now;
          isAnalyzing = true;

          // È´òÂìÅË≥™„Å™ÁîªÂÉè„ÇíÂèñÂæóÔºàËß£ÊûêÁî®Ôºâ
          const fullCanvas = document.createElement('canvas');
          const fullCtx = fullCanvas.getContext('2d');
          fullCanvas.width = cameraVideo.videoWidth;
          fullCanvas.height = cameraVideo.videoHeight;
          fullCtx.drawImage(cameraVideo, 0, 0);
          const fullDataUrl = fullCanvas.toDataURL('image/jpeg', 0.9);

          // „Ç∑„É£„ÉÉ„Çø„Éº„Ç®„Éï„Çß„ÇØ„Éà
          shutterEffect.classList.add('flash');
          setTimeout(() => shutterEffect.classList.remove('flash'), 200);

          // Ëá™ÂãïËß£Êûê„ÇíÂÆüË°å
          try {
            await autoAnalyzeReceipt(fullDataUrl);
          } catch (error) {
            console.error('Ëá™ÂãïËß£Êûê„Ç®„É©„Éº:', error);
          } finally {
            isAnalyzing = false;
          }
        }
      }, 500); // 500ms„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ
    }

    function stopContinuousCapture() {
      isContinuousRunning = false;
      isAnalyzing = false;

      if (continuousIntervalId) {
        clearInterval(continuousIntervalId);
        continuousIntervalId = null;
      }

      // UI„ÇíÂÖÉ„Å´Êàª„Åô
      shutterBtn.classList.remove('recording');
      continuousModeText.textContent = '„Åæ„Å®„ÇÅÊíÆ„Çä';

      console.log(`„Åæ„Å®„ÇÅÊíÆ„ÇäÂÅúÊ≠¢„ÄÇËß£ÊûêÊ∏à„Åø„É¨„Ç∑„Éº„ÉàÊï∞: ${receiptResults.length}`);

      // Ëß£ÊûêÊ∏à„Åø„É¨„Ç∑„Éº„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Éê„ÉÉ„ÉÅÁµêÊûúUI„ÇíË°®Á§∫
      if (receiptResults.length > 0) {
        console.log(`${receiptResults.length}‰ª∂„ÅÆ„É¨„Ç∑„Éº„Éà„ÇíËß£Êûê„Åó„Åæ„Åó„Åü`);
        displayBatchResults(receiptResults);
      } else {
        console.log('„É¨„Ç∑„Éº„Éà„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü');
      }
    }

    // „Éê„ÉÉ„ÉÅÁµêÊûú„ÇíË°®Á§∫
    function displayBatchResults(results) {
      // „Ç´„Ç¶„É≥„ÉàË°®Á§∫
      batchCount.textContent = results.length;

      // „Ç∞„É™„ÉÉ„Éâ„Çí„ÇØ„É™„Ç¢
      batchResultsGrid.innerHTML = '';

      // ÂêÑ„É¨„Ç∑„Éº„Éà„ÅÆ„Ç´„Éº„Éâ„ÇíÁîüÊàê
      results.forEach((result, index) => {
        const card = createBatchReceiptCard(result, index);
        batchResultsGrid.appendChild(card);
      });

      // „Éê„ÉÉ„ÉÅÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
      resultSection.classList.remove('visible');
      batchResultsSection.classList.add('visible');

      // „Çπ„ÇØ„É≠„Éº„É´
      setTimeout(() => {
        batchResultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }

    // „Éê„ÉÉ„ÉÅ„É¨„Ç∑„Éº„Éà„Ç´„Éº„Éâ„ÇíÁîüÊàê
    function createBatchReceiptCard(result, index) {
      const card = document.createElement('div');
      card.className = 'batch-receipt-card';
      card.dataset.index = index;

      const data = result.data;
      const storeName = data.storeName || '‰∏çÊòé„Å™Â∫óËàó';
      const date = data.date || '-';
      const total = data.total ? `¬•${data.total.toLocaleString()}` : '-';

      card.innerHTML = `
        <img src="${result.imageDataUrl}" alt="„É¨„Ç∑„Éº„ÉàÁîªÂÉè" class="batch-receipt-thumbnail">
        <div class="batch-receipt-info">
          <h3>${storeName}</h3>
          <div class="date">${date}</div>
          <div class="amount">${total}</div>
        </div>
        <select class="batch-category-select" data-index="${index}">
          <option value="">„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû</option>
          ${categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('')}
        </select>
        <button class="batch-save-btn" data-index="${index}">‰øùÂ≠ò</button>
      `;

      return card;
    }

    // „Éê„ÉÉ„ÉÅ„Ç´„Éº„ÉâÂÜÖ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
    function handleBatchCardClick(e) {
      const saveBtn = e.target.closest('.batch-save-btn');
      if (saveBtn) {
        const index = parseInt(saveBtn.dataset.index);
        saveSingleReceipt(index);
      }
    }

    // Âçò‰∏Ä„É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò
    async function saveSingleReceipt(index) {
      const result = receiptResults[index];
      if (!result) return;

      const selectElement = batchResultsGrid.querySelector(`.batch-category-select[data-index="${index}"]`);
      const categoryId = selectElement ? selectElement.value : '';

      if (!categoryId) {
        alert('„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      const saveBtn = batchResultsGrid.querySelector(`.batch-save-btn[data-index="${index}"]`);
      saveBtn.disabled = true;
      saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';

      try {
        // „É¨„Ç∑„Éº„Éà„Éá„Éº„Çø„ÇíÊßãÁØâ
        const receiptData = {
          imageDataUrl: result.imageDataUrl,
          storeName: result.data.storeName || '‰∏çÊòé„Å™Â∫óËàó',
          date: result.data.date || new Date().toISOString().split('T')[0],
          total: result.data.total || 0,
          items: result.data.items || [],
          categoryId: categoryId,
          timestamp: result.timestamp || Date.now(),
          createdAt: new Date().toISOString()
        };

        // LocalStorage„Å´‰øùÂ≠ò
        const savedId = storage.save(receiptData);
        console.log('„É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', savedId);

        // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂ§âÊõ¥
        saveBtn.textContent = '‰øùÂ≠òÊ∏à„Åø';
        saveBtn.classList.add('saved');

      } catch (error) {
        console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        saveBtn.disabled = false;
        saveBtn.textContent = '‰øùÂ≠ò';
      }
    }

    // „Åô„Åπ„Å¶„ÅÆ„É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò
    async function saveAllReceipts() {
      const selects = batchResultsGrid.querySelectorAll('.batch-category-select');
      let hasEmptyCategory = false;

      // „Åô„Åπ„Å¶„Ç´„ÉÜ„Ç¥„É™„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      selects.forEach(select => {
        if (!select.value) {
          hasEmptyCategory = true;
        }
      });

      if (hasEmptyCategory) {
        alert('„Åô„Åπ„Å¶„ÅÆ„É¨„Ç∑„Éº„Éà„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      saveAllBtn.disabled = true;
      saveAllBtn.textContent = '‰øùÂ≠ò‰∏≠...';

      try {
        // „Åô„Åπ„Å¶„ÅÆ„É¨„Ç∑„Éº„Éà„ÇíÈ†ÜÁï™„Å´‰øùÂ≠ò
        for (let i = 0; i < receiptResults.length; i++) {
          const saveBtn = batchResultsGrid.querySelector(`.batch-save-btn[data-index="${i}"]`);
          if (!saveBtn.classList.contains('saved')) {
            await saveSingleReceipt(i);
          }
        }

        alert(`${receiptResults.length}‰ª∂„ÅÆ„É¨„Ç∑„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
        closeBatchResults();

      } catch (error) {
        console.error('‰∏ÄÊã¨‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('‰∏ÄÊã¨‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        saveAllBtn.disabled = false;
        saveAllBtn.textContent = '„Åô„Åπ„Å¶‰øùÂ≠ò';
      }
    }

    // „Éê„ÉÉ„ÉÅÁµêÊûú„ÇíÈñâ„Åò„Çã
    function closeBatchResults() {
      batchResultsSection.classList.remove('visible');
      receiptResults = [];
      updateContinuousCount();
      console.log('„Éê„ÉÉ„ÉÅÁµêÊûú„ÇíÈñâ„Åò„Åæ„Åó„Åü');
    }

    // Ëá™ÂãïËß£ÊûêÈñ¢Êï∞Ôºà„É¨„Ç∑„Éº„ÉàÊ§úÂá∫ÊôÇ„Å´Âëº„Å∞„Çå„ÇãÔºâ
    async function autoAnalyzeReceipt(imageDataUrl) {
      try {
        console.log('Ëá™ÂãïËß£ÊûêÈñãÂßã...', new Date().toISOString());

        // OCRËß£Êûê„ÇíÂÆüË°åÔºà„Çµ„Éº„Éê„ÉºÁµåÁî±Ôºâ
        const data = await callOpenAiReceiptOcr(imageDataUrl, (msg) => {
          console.log('Ëß£ÊûêÈÄ≤Êçó:', msg);
        });

        console.log('OCRËß£ÊûêÂÆå‰∫Ü:', data);

        // Ëß£ÊûêÁµêÊûú„Çí‰øùÂ≠ò
        receiptResults.push({
          imageDataUrl,
          data,
          timestamp: Date.now()
        });

        console.log(`Ëß£ÊûêÁµêÊûú„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇÁèæÂú®„ÅÆËß£ÊûêÊ∏à„ÅøÊï∞: ${receiptResults.length}`);

        // „Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
        updateContinuousCount();

        // ÁµêÊûú„ÇíË°®Á§∫
        displayResults(data);

        console.log(`Ëß£ÊûêÂÆå‰∫ÜÔºÅÁèæÂú®„ÅÆËß£ÊûêÊ∏à„ÅøÊï∞: ${receiptResults.length}`);
      } catch (error) {
        console.error('Ëá™ÂãïËß£Êûê„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü:', error);
        // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„Åæ„Å®„ÇÅÊíÆ„Çä„ÅØÁ∂ôÁ∂ö
      }
    }

    function computeFrameDifference(prev, current) {
      // Á∞°ÊòìÁöÑ„Å´„ÄÅÊï∞ÂçÅ„Éî„ÇØ„Çª„É´„Å†„Åë„Çµ„É≥„Éó„É™„É≥„Ç∞„Åó„Å¶Â∑ÆÂàÜÁéá„ÇíÂá∫„Åô
      const step = 24; // „Çµ„É≥„Éó„É™„É≥„Ç∞ÈñìÈöî
      let total = 0;
      let diffSum = 0;

      for (let y = 0; y < current.h; y += step) {
        for (let x = 0; x < current.w; x += step) {
          const idx = (y * current.w + x) * 4;
          const r1 = prev.data[idx];
          const g1 = prev.data[idx + 1];
          const b1 = prev.data[idx + 2];

          const r2 = current.data[idx];
          const g2 = current.data[idx + 1];
          const b2 = current.data[idx + 2];

          const l1 = 0.299 * r1 + 0.587 * g1 + 0.114 * b1;
          const l2 = 0.299 * r2 + 0.587 * g2 + 0.114 * b2;

          const diff = Math.abs(l1 - l2) / 255;
          diffSum += diff;
          total++;
        }
      }

      if (!total) return 0;
      return diffSum / total;
    }

    // „Ç∑„É£„Éº„Éó„Éç„ÇπÔºàÈÆÆÊòéÂ∫¶Ôºâ„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
    // Laplacian variance „ÇíÁ∞°ÊòìË®àÁÆóÔºà„Ç®„ÉÉ„Ç∏Âº∑Â∫¶„ÅÆÂàÜÊï£„ÅåÈ´ò„ÅÑ„Åª„Å©ÈÆÆÊòéÔºâ
    function computeSharpnessScore(imageData) {
      const data = imageData.data;
      const w = imageData.w;
      const h = imageData.h;
      const step = 4; // „Çµ„É≥„Éó„É™„É≥„Ç∞ÈñìÈöîÔºàË®àÁÆóË≤†Ëç∑ËªΩÊ∏õ„ÅÆ„Åü„ÇÅÔºâ

      let laplacianSum = 0;
      let laplacianSqSum = 0;
      let count = 0;

      // „Ç∞„É¨„Éº„Çπ„Ç±„Éº„É´Â§âÊèõ„Åó„Å™„Åå„ÇâLaplacian„Ç´„Éº„Éç„É´ÈÅ©Áî®
      for (let y = step; y < h - step; y += step) {
        for (let x = step; x < w - step; x += step) {
          // ‰∏≠ÂøÉ„Éî„ÇØ„Çª„É´„Å®Âë®Âõ≤„ÅÆ„Ç∞„É¨„Éº„Çπ„Ç±„Éº„É´ÂÄ§„ÇíÂèñÂæó
          const getGray = (px, py) => {
            const idx = (py * w + px) * 4;
            return 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
          };

          const center = getGray(x, y);
          const top = getGray(x, y - 1);
          const bottom = getGray(x, y + 1);
          const left = getGray(x - 1, y);
          const right = getGray(x + 1, y);

          // Laplacian„Éï„Ç£„É´„Çø: ‰∏≠ÂøÉ*4 - ‰∏ä‰∏ãÂ∑¶Âè≥„ÅÆÂêàË®à
          const laplacian = Math.abs(4 * center - top - bottom - left - right);

          laplacianSum += laplacian;
          laplacianSqSum += laplacian * laplacian;
          count++;
        }
      }

      if (count === 0) return 0;

      // ÂàÜÊï£„ÇíË®àÁÆóÔºàÈ´ò„ÅÑ„Åª„Å©ÈÆÆÊòéÔºâ
      const mean = laplacianSum / count;
      const variance = (laplacianSqSum / count) - (mean * mean);

      return variance;
    }

    function updateContinuousCount() {
      const count = receiptResults.length;
      frameCount.textContent = count;
    }

    // „É¨„Ç∑„Éº„ÉàÂà§ÂÆöÈñ¢Êï∞Ôºà„Ç∑„É≥„Éó„É´„Å™ÁîªÂÉèËß£ÊûêÔºâ
    function detectReceipt(imageData) {
      const data = imageData.data;
      const w = imageData.w;
      const h = imageData.h;

      // 1. Êòé„Çã„Åï„Å®„Ç≥„É≥„Éà„É©„Çπ„Éà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
      let brightnessSum = 0;
      let pixelCount = 0;
      const step = 8; // „Çµ„É≥„Éó„É™„É≥„Ç∞ÈñìÈöî

      for (let y = 0; y < h; y += step) {
        for (let x = 0; x < w; x += step) {
          const idx = (y * w + x) * 4;
          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];
          const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
          brightnessSum += brightness;
          pixelCount++;
        }
      }

      const avgBrightness = brightnessSum / pixelCount;

      // „É¨„Ç∑„Éº„Éà„ÅØÁôΩ„ÅÑËÉåÊôØ„ÅåÂ§ö„ÅÑ„ÅÆ„Åß„ÄÅÂπ≥ÂùáÊòé„Çã„Åï„Åå‰∏ÄÂÆö‰ª•‰∏äÔºà„Åó„Åç„ÅÑÂÄ§„ÇíÁ∑©ÂíåÔºâ
      if (avgBrightness < 80) {
        console.log('„É¨„Ç∑„Éº„ÉàÂà§ÂÆöÂ§±Êïó: Êòé„Çã„Åï‰∏çË∂≥', avgBrightness.toFixed(1));
        return false; // Êöó„Åô„Åé„Çã
      }

      // 2. „Ç®„ÉÉ„Ç∏ÂØÜÂ∫¶„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºà„ÉÜ„Ç≠„Çπ„Éà„ÅåÂ§ö„ÅÑ„ÅãÔºâ
      let edgeCount = 0;
      const edgeStep = 8;
      const edgeThreshold = 25; // „Ç®„ÉÉ„Ç∏„Å®Âà§ÂÆö„Åô„ÇãÈñæÂÄ§ÔºàÁ∑©ÂíåÔºâ

      for (let y = edgeStep; y < h - edgeStep; y += edgeStep) {
        for (let x = edgeStep; x < w - edgeStep; x += edgeStep) {
          const idx = (y * w + x) * 4;

          // ‰∏≠ÂøÉ„Éî„ÇØ„Çª„É´„ÅÆÊòéÂ∫¶
          const centerGray = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];

          // Âë®Âõ≤„Éî„ÇØ„Çª„É´„Å®„ÅÆÂ∑ÆÂàÜÔºàÁ∞°ÊòìSobel„Éï„Ç£„É´„ÇøÔºâ
          const rightIdx = (y * w + (x + edgeStep)) * 4;
          const bottomIdx = ((y + edgeStep) * w + x) * 4;

          const rightGray = 0.299 * data[rightIdx] + 0.587 * data[rightIdx + 1] + 0.114 * data[rightIdx + 2];
          const bottomGray = 0.299 * data[bottomIdx] + 0.587 * data[bottomIdx + 1] + 0.114 * data[bottomIdx + 2];

          const gx = Math.abs(rightGray - centerGray);
          const gy = Math.abs(bottomGray - centerGray);
          const gradient = Math.sqrt(gx * gx + gy * gy);

          if (gradient > edgeThreshold) {
            edgeCount++;
          }
        }
      }

      const totalSamplePixels = ((h - 2 * edgeStep) / edgeStep) * ((w - 2 * edgeStep) / edgeStep);
      const edgeDensity = edgeCount / totalSamplePixels;

      // „Ç®„ÉÉ„Ç∏ÂØÜÂ∫¶„Åå‰∏ÄÂÆö‰ª•‰∏äÔºà„ÉÜ„Ç≠„Çπ„Éà„ÅåÂ§ö„ÅÑÔºâÔºà„Åó„Åç„ÅÑÂÄ§„ÇíÁ∑©ÂíåÔºâ
      if (edgeDensity < 0.05) {
        console.log('„É¨„Ç∑„Éº„ÉàÂà§ÂÆöÂ§±Êïó: „Ç®„ÉÉ„Ç∏ÂØÜÂ∫¶‰∏çË∂≥', edgeDensity.toFixed(3));
        return false; // „Ç®„ÉÉ„Ç∏„ÅåÂ∞ë„Å™„Åô„Åé„Çã
      }

      // 3. ‰∏≠Â§ÆÈÉ®ÂàÜ„Å´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      const centerX = Math.floor(w / 2);
      const centerY = Math.floor(h / 2);
      const centerSize = Math.min(w, h) / 4;

      let centerEdgeCount = 0;
      let centerPixelCount = 0;

      for (let y = centerY - centerSize / 2; y < centerY + centerSize / 2; y += edgeStep) {
        for (let x = centerX - centerSize / 2; x < centerX + centerSize / 2; x += edgeStep) {
          if (y >= 0 && y < h && x >= 0 && x < w) {
            const idx = (Math.floor(y) * w + Math.floor(x)) * 4;
            const gray = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];

            // ËøëÈö£„Å®„ÅÆÂ∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ
            if (x + edgeStep < w && y + edgeStep < h) {
              const rightIdx = (Math.floor(y) * w + Math.floor(x + edgeStep)) * 4;
              const bottomIdx = (Math.floor(y + edgeStep) * w + Math.floor(x)) * 4;

              const rightGray = 0.299 * data[rightIdx] + 0.587 * data[rightIdx + 1] + 0.114 * data[rightIdx + 2];
              const bottomGray = 0.299 * data[bottomIdx] + 0.587 * data[bottomIdx + 1] + 0.114 * data[bottomIdx + 2];

              const gx = Math.abs(rightGray - gray);
              const gy = Math.abs(bottomGray - gray);
              const gradient = Math.sqrt(gx * gx + gy * gy);

              if (gradient > edgeThreshold) {
                centerEdgeCount++;
              }
            }
            centerPixelCount++;
          }
        }
      }

      const centerEdgeDensity = centerEdgeCount / centerPixelCount;

      // ‰∏≠Â§Æ„Å´„ÇÇ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„ÇãÔºà„Åó„Åç„ÅÑÂÄ§„ÇíÁ∑©ÂíåÔºâ
      if (centerEdgeDensity < 0.03) {
        console.log('„É¨„Ç∑„Éº„ÉàÂà§ÂÆöÂ§±Êïó: ‰∏≠Â§Æ„Ç®„ÉÉ„Ç∏ÂØÜÂ∫¶‰∏çË∂≥', centerEdgeDensity.toFixed(3));
        return false;
      }

      console.log('‚úÖ „É¨„Ç∑„Éº„ÉàÊ§úÂá∫ÊàêÂäü!', {
        avgBrightness: avgBrightness.toFixed(1),
        edgeDensity: edgeDensity.toFixed(3),
        centerEdgeDensity: centerEdgeDensity.toFixed(3)
      });

      return true; // „É¨„Ç∑„Éº„Éà„Å®Âà§ÂÆö
    }

    // ========== „Éï„Ç°„Ç§„É´ÈÅ∏Êäû ==========
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          // „Ç≠„É£„Éó„ÉÅ„É£„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
          capturedImageData = null;
          capturePreview.classList.remove('visible');

          // „Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫
          scanPreview.src = e.target.result;
          scanPreview.classList.add('visible');
          scanContent.style.opacity = '0';
          hasImage = true;
          analyzeBtn.disabled = false;

          // „ÇÆ„É£„É©„É™„Éº„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
          if (currentMode === 'camera') {
            switchToMode('gallery');
          }

          // ÁµêÊûú„Çí„É™„Çª„ÉÉ„Éà
          resultSection.classList.remove('visible');
          resultCard.classList.remove('animate');
        };
        reader.readAsDataURL(file);
      }
      // input„Çí„É™„Çª„ÉÉ„ÉàÔºàÂêå„Åò„Éï„Ç°„Ç§„É´„ÇíÂÜçÈÅ∏Êäû„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
      event.target.value = '';
    }

    // ========== OpenAI „Å´„Çà„Çã OCR & Ëß£ÊûêÔºà„Çµ„Éº„Éê„ÉºÁµåÁî±Ôºâ ==========
    async function callOpenAiReceiptOcr(imageSrc, onProgress) {
      if (onProgress) {
        onProgress('„Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°‰∏≠...');
      }

      const response = await fetch('/api/receipt-ocr', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ imageSrc })
      });

      const text = await response.text();

      if (!response.ok) {
        let errorMessage = `„Çµ„Éº„Éê„ÉºÂÅ¥„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü (${response.status})`;
        try {
          const errorJson = JSON.parse(text);
          if (errorJson.error) {
            errorMessage += `: ${errorJson.error}`;
          } else {
            errorMessage += `: ${text}`;
          }
        } catch {
          errorMessage += `: ${text}`;
        }
        console.error('„Çµ„Éº„Éê„ÉºÂÅ¥ OCR „Ç®„É©„Éº:', { status: response.status, body: text });
        throw new Error(errorMessage);
      }

      let data;
      try {
        data = JSON.parse(text);
        console.log('„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆËß£ÊûêÁµêÊûú:', data);
      } catch (e) {
        console.error('„Çµ„Éº„Éê„ÉºÂøúÁ≠î JSON „Éë„Éº„Çπ„Ç®„É©„Éº:', e, text);
        throw new Error('„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂøúÁ≠î„Çí JSON „Å®„Åó„Å¶Ëß£Èáà„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
      }

      return data;
    }

    // ========== Ëß£ÊûêÂá¶ÁêÜ ==========
    async function analyzeReceipt() {
      if (!hasImage) return;

      // „Åæ„Å®„ÇÅÊíÆ„Çä„É¢„Éº„Éâ„Åß„ÅØËá™ÂãïËß£Êûê„Åï„Çå„Çã„Åü„ÇÅ„ÄÅËß£Êûê„Éú„Çø„É≥„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ
      if (isContinuousMode) {
        console.log('„Åæ„Å®„ÇÅÊíÆ„Çä„É¢„Éº„Éâ„Åß„ÅØËá™ÂãïËß£Êûê„Åï„Çå„Åæ„Åô');
        return;
      }

      // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
      loadingOverlay.classList.add('visible');
      const loadingText = loadingOverlay.querySelector('.loading-text');

      // „Çπ„Ç≠„É£„É≥„É©„Ç§„É≥ÈñãÂßã
      scanLine.classList.add('scanning');

      // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„Éª„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„ÉàË¶ÅÁ¥†„ÇíÂèñÂæó
      const progressBarContainer = document.getElementById('progressBarContainer');
      const progressBar = document.getElementById('analysisProgressBar');
      const checklist = document.getElementById('analysisChecklist');

      try {
        // „Åæ„Å®„ÇÅÊíÆ„Çä„É¢„Éº„Éâ„Åß„ÅØËá™ÂãïËß£Êûê„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„ÅÆÂàÜÂ≤ê„ÅØ‰∏çË¶Å
        if (false && isContinuousMode && continuousFrames.length > 0) {
          console.log('ÈÄ£Á∂ö„Çπ„Ç≠„É£„É≥„É¢„Éº„Éâ„ÅßËß£ÊûêÈñãÂßã„ÄÇ„Éï„É¨„Éº„É†Êï∞:', continuousFrames.length);

          // „Éô„Çπ„Éà„Ç∑„Éß„ÉÉ„ÉàÈÅ∏Êäû: „Ç∑„É£„Éº„Éó„Éç„ÇπÔºàÈÆÆÊòéÂ∫¶Ôºâ„Çπ„Ç≥„Ç¢„ÅßÈôçÈ†Ü„ÇΩ„Éº„Éà
          // ÊúÄ„ÇÇÈÆÆÊòé„Å™„Éï„É¨„Éº„É†„Åã„ÇâÂÑ™ÂÖàÁöÑ„Å´Ëß£Êûê
          const sortedFrames = [...continuousFrames].sort((a, b) => {
            return (b.sharpness || 0) - (a.sharpness || 0);
          });
          console.log('„Ç∑„É£„Éº„Éó„Éç„Çπ„Åß„ÇΩ„Éº„ÉàÊ∏à„Åø:', sortedFrames.map(f => f.sharpness));

          const results = [];
          const frameCount = sortedFrames.length;

          // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„Å®„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà„ÇíÂàùÊúüÂåñ„ÉªË°®Á§∫
          progressBarContainer.classList.add('visible');
          progressBar.style.width = '0%';
          checklist.classList.add('visible');
          checklist.innerHTML = '';

          // „ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„ÉàÈ†ÖÁõÆ„ÇíÁîüÊàê
          for (let j = 0; j < frameCount; j++) {
            const item = document.createElement('div');
            item.className = 'analysis-checklist-item';
            item.id = `checklist-item-${j}`;
            item.innerHTML = `
              <div class="check-icon">
                <div class="spinner"></div>
              </div>
              <span>„Éï„É¨„Éº„É† ${j + 1}</span>
            `;
            checklist.appendChild(item);
          }

          // „Éï„É¨„Éº„É†„Åî„Å®„Å´È†ÜÊ¨°Ëß£ÊûêÔºàAPIÊñôÈáë„ÇíÊäë„Åà„Çã„Åü„ÇÅÂêåÊôÇ„Åß„ÅØ„Å™„ÅèÁõ¥ÂàóÔºâ
          // „ÇΩ„Éº„ÉàÊ∏à„Åø„Éï„É¨„Éº„É†„Çí‰ΩøÁî®ÔºàÈÆÆÊòéÂ∫¶„ÅÆÈ´ò„ÅÑÈ†ÜÔºâ
          for (let i = 0; i < frameCount; i++) {
            const frame = sortedFrames[i];
            loadingText.textContent = `„É¨„Ç∑„Éº„Éà„ÇíËß£Êûê‰∏≠... (${i + 1}/${frameCount}) [ÈÆÆÊòéÂ∫¶: ${Math.round(frame.sharpness || 0)}]`;
            console.log(`„Éï„É¨„Éº„É†${i + 1}Ëß£ÊûêÈñãÂßã - ÁîªÂÉè„Çµ„Ç§„Ç∫:`, frame.dataUrl.length, 'ÊñáÂ≠ó, „Ç∑„É£„Éº„Éó„Éç„Çπ:', frame.sharpness);

            // ÁèæÂú®Âá¶ÁêÜ‰∏≠„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„ÉàÈ†ÖÁõÆ„Çí„Éè„Ç§„É©„Ç§„Éà
            const currentItem = document.getElementById(`checklist-item-${i}`);
            if (currentItem) {
              currentItem.classList.add('processing');
            }

            const receiptData = await callOpenAiReceiptOcr(frame.dataUrl, (msg) => {
              loadingText.textContent = `${msg} (${i + 1}/${frameCount})`;
            });
            results.push(receiptData);

            // ÂÆå‰∫Ü„Åó„Åü„Çâ„ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´Â§âÊõ¥
            if (currentItem) {
              currentItem.classList.remove('processing');
              currentItem.classList.add('completed');
              currentItem.querySelector('.check-icon').innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              `;
            }

            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÇíÊõ¥Êñ∞
            const progress = ((i + 1) / frameCount) * 100;
            progressBar.style.width = `${progress}%`;
          }

          console.log('ÈÄ£Á∂ö„Çπ„Ç≠„É£„É≥Ëß£ÊûêÂÆå‰∫Ü:', results);

          // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„Å®„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà„ÇíÈùûË°®Á§∫„Å´„É™„Çª„ÉÉ„Éà
          progressBarContainer.classList.remove('visible');
          checklist.classList.remove('visible');

          // ÊúÄÂæå„ÅÆÁµêÊûú„ÇíÁîªÈù¢„Å´Ë°®Á§∫ÔºàUI„ÅØ1ÊûöÂàÜ„ÇíÂºï„ÅçÁ∂ô„Åé„Å§„Å§„ÄÅ‰∏≠Ë∫´„ÅØÈÖçÂàó„Åß‰øùÊåÅÔºâ
          const last = results[results.length - 1];
          currentReceiptData = {
            isBatch: true,
            receipts: results,
          };
          displayResults(last);

          // ÈÄ£Á∂ö„Ç≠„É£„Éó„ÉÅ„É£„ÅØ‰∏ÄÊó¶ÂÅúÊ≠¢„Åó„ÄÅ1ÊûöÊíÆÂΩ±„É¢„Éº„Éâ„Å´Êàª„Åô
          stopContinuousCapture();
          isContinuousMode = false;
          singleModeBtn.classList.add('active');
          continuousModeBtn.classList.remove('active');

          // ÈÄ£Á∂ö„Éï„É¨„Éº„É†„ÅØ„ÇØ„É™„Ç¢ÔºàÊñôÈáëÂØæÁ≠ñÔºâ
          continuousFrames = [];
          updateContinuousCount();
        } else {
          // ÈÄöÂ∏∏„É¢„Éº„ÉâÔºö1Êûö„Å†„ÅëËß£Êûê
          // ÁîªÂÉè„ÇíÂèñÂæó
          let imageSrc = capturedImageData || scanPreview.src;
          if (!imageSrc) {
            throw new Error('ÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
          }

          loadingText.textContent = 'OpenAI„ÅßÁîªÂÉè„ÇíËß£Êûê‰∏≠...';
          console.log('Ëß£ÊûêÈñãÂßã - ÁîªÂÉè„Çµ„Ç§„Ç∫:', imageSrc.length, 'ÊñáÂ≠ó');
          const receiptData = await callOpenAiReceiptOcr(imageSrc, (msg) => {
            loadingText.textContent = msg;
            console.log('ÈÄ≤Êçó:', msg);
          });
          console.log('Ëß£ÊûêÂÆå‰∫Ü:', receiptData);

          currentReceiptData = receiptData;
          displayResults(receiptData);
        }

        // „Çπ„Ç≠„É£„É≥„É©„Ç§„É≥ÂÅúÊ≠¢
        scanLine.classList.remove('scanning');

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
        loadingOverlay.classList.remove('visible');
      } catch (error) {
        console.error('Ëß£Êûê„Ç®„É©„Éº:', error);
        console.error('„Ç®„É©„ÉºË©≥Á¥∞:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        scanLine.classList.remove('scanning');
        loadingOverlay.classList.remove('visible');
        
        // „Çà„ÇäË©≥Á¥∞„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
        let errorMsg = '„É¨„Ç∑„Éº„Éà„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n';
        if (error.message.includes('API „Ç≠„Éº')) {
          errorMsg += 'API„Ç≠„Éº„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
          errorMsg += 'API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑ„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        } else if (error.message.includes('429') || error.message.includes('rate limit')) {
          errorMsg += 'API„ÅÆÂà©Áî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        } else if (error.message.includes('ÁîªÂÉè')) {
          errorMsg += 'ÁîªÂÉè„ÅåÊ≠£„Åó„ÅèË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
        } else {
          errorMsg += `„Ç®„É©„Éº: ${error.message}`;
        }
        errorMsg += '\n\n„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12Ôºâ„ÅßË©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ';
        
        alert(errorMsg);
      }
    }

    // ========== „É¨„Ç∑„Éº„Éà„ÉÜ„Ç≠„Çπ„ÉàËß£Êûê ==========
    function parseReceiptText(text) {
      const lines = text.split('\n').filter(line => line.trim().length > 0);
      
      let storeName = 'Â∫óËàóÂêç‰∏çÊòé';
      let date = new Date().toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      let total = '0';
      const items = [];

      // Â∫óËàóÂêç„ÅÆÊ§úÂá∫ÔºàÊúÄÂàù„ÅÆÊï∞Ë°å„Åã„ÇâÔºâ
      for (let i = 0; i < Math.min(5, lines.length); i++) {
        const line = lines[i].trim();
        // Â∫óËàóÂêç„Çâ„Åó„ÅÑË°åÔºàÈï∑„Åï„ÅåÈÅ©Âàá„Åß„ÄÅÈáëÈ°ç„Éë„Çø„Éº„É≥„ÇíÂê´„Åæ„Å™„ÅÑÔºâ
        if (line.length > 2 && line.length < 30 && !/\d{3,}/.test(line)) {
          // ‰∏ÄËà¨ÁöÑ„Å™Â∫óËàóÂêç„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÈô§Â§ñ
          if (!line.match(/^(È†òÂèé|„É¨„Ç∑„Éº„Éà|ÂêàË®à|Â∞èË®à|Á®é|Êó•‰ªò|ÊôÇÂàª)/)) {
            storeName = line;
            break;
          }
        }
      }

      // Êó•‰ªò„ÅÆÊ§úÂá∫
      const datePatterns = [
        /(\d{4})[Âπ¥\/\-](\d{1,2})[Êúà\/\-](\d{1,2})/,
        /(\d{1,2})[Êúà\/\-](\d{1,2})[Êó•\/\-]/,
        /(\d{4})\/(\d{2})\/(\d{2})/
      ];
      for (const line of lines) {
        for (const pattern of datePatterns) {
          const match = line.match(pattern);
          if (match) {
            try {
              const year = match[1]?.length === 4 ? match[1] : new Date().getFullYear();
              const month = match[2] || match[1];
              const day = match[3] || match[2];
              const timeMatch = line.match(/(\d{1,2}):(\d{2})/);
              const hour = timeMatch ? timeMatch[1] : new Date().getHours();
              const minute = timeMatch ? timeMatch[2] : new Date().getMinutes();
              date = `${year}Âπ¥${month}Êúà${day}Êó• ${hour}:${minute}`;
              break;
            } catch (e) {
              // Êó•‰ªòËß£Êûê„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
            }
          }
        }
        if (date !== '') break;
      }

      // ÈáëÈ°ç„Å®ÊòéÁ¥∞„ÅÆÊäΩÂá∫
      const pricePattern = /[¬•Ôø•]?\s*(\d{1,3}(?:[,Ôºå]\d{3})*)/g;
      const totalPatterns = [/ÂêàË®à[¬•Ôø•]?\s*(\d{1,3}(?:[,Ôºå]\d{3})*)/, /Ë®à[¬•Ôø•]?\s*(\d{1,3}(?:[,Ôºå]\d{3})*)/, /TOTAL[¬•Ôø•]?\s*(\d{1,3}(?:[,Ôºå]\d{3})*)/i];
      
      // ÂêàË®àÈáëÈ°ç„ÅÆÊ§úÂá∫
      for (const line of lines) {
        for (const pattern of totalPatterns) {
          const match = line.match(pattern);
          if (match) {
            total = match[1].replace(/[,Ôºå]/g, '');
            break;
          }
        }
        if (total !== '0') break;
      }

      // ÊúÄÂæå„ÅÆÂ§ß„Åç„Å™ÈáëÈ°ç„ÇíÂêàË®à„Å®„Åó„Å¶‰ΩøÁî®ÔºàÂêàË®à„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥ÂêàÔºâ
      if (total === '0') {
        const allPrices = [];
        for (const line of lines) {
          const matches = [...line.matchAll(pricePattern)];
          for (const match of matches) {
            const price = parseInt(match[1].replace(/[,Ôºå]/g, ''));
            if (price > 100) allPrices.push(price);
          }
        }
        if (allPrices.length > 0) {
          total = Math.max(...allPrices).toString();
        }
      }

      // ÊòéÁ¥∞„ÅÆÊäΩÂá∫ÔºàÈáëÈ°ç„ÅåÂê´„Åæ„Çå„ÇãË°å„Åã„ÇâÔºâ
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const priceMatches = [...line.matchAll(pricePattern)];
        
        if (priceMatches.length > 0) {
          // ÂêàË®à„ÇÑÁ®é„Å™„Å©„ÅÆË°å„ÅØÈô§Â§ñ
          if (line.match(/^(ÂêàË®à|Â∞èË®à|Á®é|Ê∂àË≤ªÁ®é|ÂÜÖÁ®é|Â§ñÁ®é|TOTAL|SUB)/)) {
            continue;
          }

          // ÈáëÈ°ç„ÇíÊäΩÂá∫
          const prices = priceMatches.map(m => parseInt(m[1].replace(/[,Ôºå]/g, '')));
          const itemPrice = prices[prices.length - 1]; // ÊúÄÂæå„ÅÆÈáëÈ°ç„Çí‰ΩøÁî®

          if (itemPrice > 0 && itemPrice < 1000000) { // Â¶•ÂΩì„Å™ÁØÑÂõ≤
            // ÂïÜÂìÅÂêç„ÇíÊäΩÂá∫ÔºàÈáëÈ°ç„ÅÆÂâç„ÅÆÈÉ®ÂàÜÔºâ
            const priceIndex = line.lastIndexOf(priceMatches[priceMatches.length - 1][0]);
            let itemName = line.substring(0, priceIndex).trim();
            
            // ÂïÜÂìÅÂêç„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØË°åÂÖ®‰Ωì„Åã„ÇâÈáëÈ°ç„ÇíÈô§„ÅÑ„ÅüÈÉ®ÂàÜ
            if (!itemName || itemName.length < 2) {
              itemName = line.replace(pricePattern, '').trim();
            }

            // ÂïÜÂìÅÂêç„ÅåÂèñÂæó„Åß„Åç„ÅüÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
            if (itemName && itemName.length > 0) {
              items.push({
                name: itemName,
                price: itemPrice.toLocaleString('ja-JP')
              });
            }
          }
        }
      }

      // ÊòéÁ¥∞„ÅåÂèñÂæó„Åß„Åç„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
      if (items.length === 0 && total !== '0') {
        items.push({
          name: 'ÂïÜÂìÅ',
          price: total
        });
      }

      return {
        storeName: storeName || 'Â∫óËàóÂêç‰∏çÊòé',
        date: date,
        total: parseInt(total).toLocaleString('ja-JP'),
        items: items.slice(0, 20) // ÊúÄÂ§ß20È†ÖÁõÆ
      };
    }

    // ÁµêÊûúË°®Á§∫Èñ¢Êï∞
    function displayResults(data) {
      // „Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà
      storeName.textContent = data.storeName;
      receiptDate.textContent = data.date;
      totalAmount.textContent = data.total;

      // „Ç´„ÉÜ„Ç¥„É™„Éú„Çø„É≥„ÇíÁîüÊàê
      categoryButtons.innerHTML = '';
      categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = `category-btn ${category.class}`;
        btn.textContent = `${category.icon} ${category.name}`;
        btn.dataset.categoryId = category.id;
        btn.addEventListener('click', () => selectCategory(category.id));
        categoryButtons.appendChild(btn);
      });

      // ÊòéÁ¥∞„Çí„ÇØ„É™„Ç¢
      resultItems.innerHTML = '';

      // ÊòéÁ¥∞„ÇíËøΩÂä†
      data.items.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'result-item';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'item-name';
        nameSpan.textContent = item.name;

        // ÂìÅÁõÆ„Åî„Å®„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éê„ÉÉ„Ç∏
        if (item.categoryId) {
          const cat = categories.find((c) => c.id === item.categoryId);
          const badge = document.createElement('span');
          badge.className = 'item-category';
          badge.textContent = cat ? cat.name : '„Åù„ÅÆ‰ªñ';
          nameSpan.appendChild(badge);
        }

        const priceSpan = document.createElement('span');
        priceSpan.className = 'item-price';
        priceSpan.textContent = `¬•${item.price}`;

        li.appendChild(nameSpan);
        li.appendChild(priceSpan);

        resultItems.appendChild(li);
      });

      // „Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
      resultSection.classList.add('visible');
      categorySection.style.display = 'block';

      // „É¨„Ç∑„Éº„ÉàÂÖ®‰Ωì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çå„Å∞Ëá™ÂãïÈÅ∏Êäû
      if (data.categoryId) {
        selectCategory(data.categoryId);
      }

      // „Ç´„Éº„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      requestAnimationFrame(() => {
        resultCard.classList.add('animate');

        // ÊòéÁ¥∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÈ†ÜÊ¨°Ôºâ
        const items = resultItems.querySelectorAll('.result-item');
        items.forEach((item, index) => {
          setTimeout(() => {
            item.classList.add('animate');
          }, 600 + (index * 100));
        });
      });

      // ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„Å´„Çπ„ÇØ„É≠„Éº„É´
      setTimeout(() => {
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }

    // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû
    function selectCategory(categoryId) {
      selectedCategory = categoryId;
      
      // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      categoryButtons.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.categoryId === categoryId) {
          btn.classList.add('active');
        }
      });

      // „Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†±„Çí‰øùÂ≠òÔºàÂ∞ÜÊù•„ÅÆÂ±•Ê≠¥Ê©üËÉΩÁî®Ôºâ
      if (currentReceiptData) {
        currentReceiptData.category = categoryId;
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
        try {
          const history = JSON.parse(localStorage.getItem('receiptHistory') || '[]');
          history.push({
            ...currentReceiptData,
            timestamp: new Date().toISOString()
          });
          // ÊúÄÊñ∞100‰ª∂„ÅÆ„Åø‰øùÊåÅ
          localStorage.setItem('receiptHistory', JSON.stringify(history.slice(-100)));
        } catch (e) {
          console.warn('Â±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
        }
      }
    }

    // HTML„Ç®„Çπ„Ç±„Éº„Éó
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== ÂàùÊúüÂåñÂÆüË°å ==========
    init();

    // ========== Service Worker ÁôªÈå≤ ==========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
